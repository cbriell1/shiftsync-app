This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
app/api/checklists/route.ts
app/api/dashboard/route.ts
app/api/feedback/[id]/route.ts
app/api/feedback/route.ts
app/api/giftcards/[id]/route.ts
app/api/giftcards/route.ts
app/api/kiosk/route.ts
app/api/locations/route.ts
app/api/manager/route.ts
app/api/members/route.ts
app/api/shifts/route.ts
app/api/shifts/seed/route.ts
app/api/tasks/route.ts
app/api/templates/route.ts
app/api/timecards/route.ts
app/api/timecards/seed/route.ts
app/api/users/route.ts
app/components/CalendarTab.tsx
app/components/DashboardTab.tsx
app/components/FeedbackTab.tsx
app/components/GiftCardTab.tsx
app/components/ManagerTab.tsx
app/components/PrivilegesTab.tsx
app/components/ReportsTab.tsx
app/components/SetupTab.tsx
app/components/StaffTab.tsx
app/components/TimeCardTab.tsx
app/favicon.ico
app/globals.css
app/kiosk/page.tsx
app/layout.tsx
app/page.tsx
eslint.config.mjs
lib/prisma.ts
lib/types.ts
New Text Document.txt
next.config.ts
package.json
postcss.config.mjs
prisma/schema.prisma
public/file.svg
public/globe.svg
public/logo.png
public/next.svg
public/vercel.svg
public/window.svg
README.md
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/api/checklists/route.ts">
import { prisma } from '@/lib/prisma';
import { NextResponse } from 'next/server';
import { z } from 'zod';

export const dynamic = 'force-dynamic';

// Schema for creating/updating checklists
const checklistSchema = z.object({
  id: z.number().optional(),
  userId: z.coerce.number(),
  locationId: z.coerce.number(),
  timeCardId: z.coerce.number().nullable().optional(),
  notes: z.string().default(''),
  completedTasks: z.array(z.string()).default([]),
  missedTasks: z.array(z.string()).default([]),
});

export async function GET() {
  try {
    const lists = await prisma.checklist.findMany({
      include: { user: true, location: true, timeCard: true }, 
      orderBy: { date: 'desc' },
      take: 100
    });
    return NextResponse.json(lists);
  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}

export async function POST(request: Request) {
  try {
    const body = await request.json();
    const data = checklistSchema.parse(body);

    const newChecklist = await prisma.checklist.create({
      data: {
        userId: data.userId,
        locationId: data.locationId,
        timeCardId: data.timeCardId || null,
        notes: data.notes,
        completedTasks: data.completedTasks, 
        missedTasks: data.missedTasks        
      }
    });
    return NextResponse.json(newChecklist);
  } catch (error: any) {
    if (error instanceof z.ZodError) {
      return NextResponse.json({ error: error.errors }, { status: 400 });
    }
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}

export async function PUT(request: Request) {
  try {
    const body = await request.json();
    const data = checklistSchema.parse(body);

    if (!data.id) return NextResponse.json({ error: "Missing ID" }, { status: 400 });

    const updatedChecklist = await prisma.checklist.update({
      where: { id: data.id },
      data: {
        notes: data.notes,
        completedTasks: data.completedTasks,
        missedTasks: data.missedTasks
      }
    });
    return NextResponse.json(updatedChecklist);
  } catch (error: any) {
    if (error instanceof z.ZodError) {
      return NextResponse.json({ error: error.errors }, { status: 400 });
    }
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}
</file>

<file path="app/api/dashboard/route.ts">
import { prisma } from '@/lib/prisma';
import { NextResponse } from 'next/server';
import { z } from 'zod';

export const dynamic = 'force-dynamic';

const dashboardSchema = z.object({
  startDate: z.string(),
  endDate: z.string(),
  userIds: z.array(z.coerce.number()).optional(),
  locationIds: z.array(z.coerce.number()).optional(),
});

export async function POST(request: Request) {
  try {
    const body = await request.json();
    const { startDate, endDate, userIds, locationIds } = dashboardSchema.parse(body);

    // Creates absolute boundary dates to ignore timezone shifts
    const start = new Date(startDate);
    start.setHours(0, 0, 0, 0);
    
    const end = new Date(endDate);
    end.setHours(23, 59, 59, 999); 

    const whereClause: any = {
      clockIn: { gte: start, lte: end }
    };

    if (userIds && userIds.length > 0) {
      whereClause.userId = { in: userIds };
    }

    // NEW: Respect the location filter!
    if (locationIds && locationIds.length > 0) {
      whereClause.locationId = { in: locationIds };
    }

    const timeCards = await prisma.timeCard.findMany({
      where: whereClause,
      include: { location: true, user: true },
      orderBy: { clockIn: 'asc' }
    });

    return NextResponse.json({ timeCards });
  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 400 });
  }
}
</file>

<file path="app/api/feedback/[id]/route.ts">
import { prisma } from '@/lib/prisma';
import { NextResponse } from 'next/server';
import { z } from 'zod';

const updateFeedbackSchema = z.object({
  status: z.enum(['OPEN', 'IN PROGRESS', 'COMPLETED']),
  devNotes: z.string().optional(),
});

export async function PUT(request: Request, props: { params: Promise<{ id: string }> }) {
  try {
    const { id } = await props.params;
    const body = await request.json();
    const data = updateFeedbackSchema.parse(body);

    const updated = await prisma.feedback.update({
      where: { id: parseInt(id) },
      data: { status: data.status, devNotes: data.devNotes },
    });
    return NextResponse.json(updated);
  } catch (error: any) {
    return NextResponse.json({ error: 'Update failed' }, { status: 500 });
  }
}
</file>

<file path="app/api/feedback/route.ts">
import { prisma } from '@/lib/prisma';
import { NextResponse } from 'next/server';
import { z } from 'zod';

const feedbackSchema = z.object({
  userId: z.coerce.number(),
  type: z.enum(['BUG', 'SUGGESTION']),
  description: z.string().min(5),
});

export async function GET() {
  try {
    const feedbacks = await prisma.feedback.findMany({
      include: { user: true },
      orderBy: { createdAt: 'desc' },
    });
    return NextResponse.json(feedbacks);
  } catch (error) {
    return NextResponse.json({ error: 'Failed to fetch' }, { status: 500 });
  }
}

export async function POST(request: Request) {
  try {
    const body = await request.json();
    const data = feedbackSchema.parse(body);
    const newFeedback = await prisma.feedback.create({
      data: {
        userId: data.userId,
        type: data.type,
        description: data.description,
        status: 'OPEN',
      },
    });
    return NextResponse.json(newFeedback, { status: 201 });
  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 400 });
  }
}
</file>

<file path="app/api/kiosk/route.ts">
import { prisma } from '@/lib/prisma';
import { NextResponse } from 'next/server';
import { z } from 'zod';

export const dynamic = 'force-dynamic';

const kioskSchema = z.discriminatedUnion("action", [
  z.object({
    action: z.literal("CLOCK_IN"),
    userId: z.coerce.number(),
    locationId: z.coerce.number(),
    pinCode: z.string()
  }),
  z.object({
    action: z.literal("CLOCK_OUT"),
    timeCardId: z.coerce.number(),
    pinCode: z.string()
  })
]);

export async function GET() {
  const openCards = await prisma.timeCard.findMany({
    where: { clockOut: null },
    include: { user: true, location: true }
  });
  return NextResponse.json(openCards);
}

export async function POST(request: Request) {
  try {
    const body = await request.json();
    const data = kioskSchema.parse(body);

    if (data.action === 'CLOCK_IN') {
      const user = await prisma.user.findUnique({ where: { id: data.userId } });
      if (!user) return NextResponse.json({ error: "User not found" }, { status: 404 });
      
      if ((user.pinCode || '1234') !== data.pinCode) {
        return NextResponse.json({ error: "Invalid PIN" }, { status: 401 });
      }

      const newCard = await prisma.timeCard.create({
        data: { userId: data.userId, locationId: data.locationId, clockIn: new Date() }
      });
      return NextResponse.json(newCard);
    }

    if (data.action === 'CLOCK_OUT') {
      const tc = await prisma.timeCard.findUnique({ 
        where: { id: data.timeCardId }, 
        include: { user: true } 
      });
      if (!tc || !tc.user) return NextResponse.json({ error: "Record not found" }, { status: 404 });

      if ((tc.user.pinCode || '1234') !== data.pinCode) {
        return NextResponse.json({ error: "Invalid PIN" }, { status: 401 });
      }
      
      const clockOut = new Date();
      const diff = clockOut.getTime() - new Date(tc.clockIn).getTime();
      const hours = parseFloat((diff / (1000 * 60 * 60)).toFixed(2));

      const updated = await prisma.timeCard.update({
        where: { id: data.timeCardId },
        data: { clockOut, totalHours: hours }
      });
      return NextResponse.json(updated);
    }
  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 400 });
  }
}
</file>

<file path="app/api/locations/route.ts">
import { prisma } from '@/lib/prisma';
import { NextResponse } from 'next/server';

export const dynamic = 'force-dynamic';

export async function GET() {
  try {
    const locations = await prisma.location.findMany({
      orderBy: {
        name: 'asc' // Keeps location dropdowns alphabetically sorted globally
      }
    });
    return NextResponse.json(locations);
  } catch (error: any) {
    console.error("GET Locations Error:", error);
    return NextResponse.json(
      { error: "Failed to fetch locations from database" }, 
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/manager/route.ts">
import { prisma } from '@/lib/prisma';
import { NextResponse } from 'next/server';
import { z } from 'zod';

const managerSchema = z.object({
  periods: z.array(z.object({
    start: z.string(),
    end: z.string()
  })),
  userIds: z.array(z.coerce.number()).optional(),
});

export async function POST(request: Request) {
  try {
    const body = await request.json();
    const { periods, userIds } = managerSchema.parse(body);

    const whereClause: any = {};

    if (userIds && userIds.length > 0) {
      whereClause.userId = { in: userIds };
    }

    if (periods && periods.length > 0) {
      const orConditions = periods.map(p => {
        const eDate = new Date(p.end);
        eDate.setHours(23, 59, 59, 999);
        return {
          clockIn: { gte: new Date(p.start), lte: eDate }
        };
      });
      whereClause.OR = orConditions;
    }

    const timeCards = await prisma.timeCard.findMany({
      where: whereClause,
      include: { user: true, location: true },
      orderBy: { clockIn: 'asc' }
    });

    return NextResponse.json(timeCards);
  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 400 });
  }
}
</file>

<file path="app/api/members/route.ts">
import { prisma } from '@/lib/prisma';
import { NextResponse } from 'next/server';
import { z } from 'zod';

export const dynamic = 'force-dynamic';

const memberActionSchema = z.discriminatedUnion("action", [
  z.object({ action: z.literal("LOG_BEVERAGE"), memberId: z.coerce.number() }),
  z.object({ action: z.literal("UPDATE_RENEWAL"), memberId: z.coerce.number(), renewalDate: z.string() }),
  z.object({ action: z.literal("UPDATE_TOTAL_PASSES"), memberId: z.coerce.number(), totalPasses: z.coerce.number(), bonusNotes: z.string().optional() }),
  z.object({ action: z.literal("LOG_PASS_USAGE"), memberId: z.coerce.number(), dateUsed: z.string(), amount: z.coerce.number(), initials: z.string() })
]);

export async function GET() {
  const members = await prisma.member.findMany({
    include: { usages: true },
    orderBy: { lastName: 'asc' }
  });
  return NextResponse.json(members);
}

export async function POST(request: Request) {
  try {
    const data = await request.json();
    const newMember = await prisma.member.create({
      data: {
        lastName: data.lastName,
        firstName: data.firstName || '',
        location: data.location || '',
        notes: data.notes || '',
        family: data.family || '',
        renewalDate: data.renewalDate || '',
        totalPasses: parseInt(data.totalPasses) || 12
      }
    });
    return NextResponse.json(newMember);
  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}

export async function PUT(request: Request) {
  try {
    const body = await request.json();
    const data = memberActionSchema.parse(body);

    if (data.action === 'LOG_BEVERAGE') {
      const updated = await prisma.member.update({
        where: { id: data.memberId },
        data: { lastBeverageDate: new Date() } 
      });
      return NextResponse.json(updated);
    }

    if (data.action === 'UPDATE_RENEWAL') {
      const updated = await prisma.member.update({
        where: { id: data.memberId },
        data: { renewalDate: data.renewalDate }
      });
      return NextResponse.json(updated);
    }

    if (data.action === 'UPDATE_TOTAL_PASSES') {
      const updated = await prisma.member.update({
        where: { id: data.memberId },
        data: { 
          totalPasses: data.totalPasses,
          bonusNotes: data.bonusNotes || '' 
        }
      });
      return NextResponse.json(updated);
    }

    if (data.action === 'LOG_PASS_USAGE') {
      const newUsage = await prisma.passUsage.create({
        data: {
          memberId: data.memberId,
          dateUsed: data.dateUsed,
          amount: data.amount,
          initials: data.initials
        }
      });
      return NextResponse.json(newUsage);
    }
  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 400 });
  }
}
</file>

<file path="app/api/shifts/route.ts">
import { prisma } from '@/lib/prisma';
import { NextResponse } from 'next/server';
import { z } from 'zod';

export const dynamic = 'force-dynamic';

const shiftActionSchema = z.object({
  shiftId: z.coerce.number(),
  userId: z.coerce.number().optional(),
  action: z.enum(['CLAIM', 'UNCLAIM', 'REQUEST_COVER', 'CANCEL_COVER'])
});

export async function GET() {
  const shifts = await prisma.shift.findMany({
    include: { location: true, assignedTo: true },
    orderBy: { startTime: 'asc' }
  });
  return NextResponse.json(shifts);
}

export async function POST(request: Request) {
  try {
    const body = await request.json();
    const { shiftId, userId, action } = shiftActionSchema.parse(body);

    let updateData: any = {};

    switch (action) {
      case 'UNCLAIM':
        updateData = { status: 'OPEN', userId: null };
        break;
      case 'REQUEST_COVER':
        updateData = { status: 'COVERAGE_REQUESTED' };
        break;
      case 'CANCEL_COVER':
        updateData = { status: 'CLAIMED' };
        break;
      case 'CLAIM':
        if (!userId) return NextResponse.json({ error: "User ID required" }, { status: 400 });
        updateData = { status: 'CLAIMED', userId };
        break;
    }

    const updated = await prisma.shift.update({
      where: { id: shiftId },
      data: updateData
    });
    return NextResponse.json(updated);
  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 400 });
  }
}
</file>

<file path="app/api/shifts/seed/route.ts">
import { prisma } from '@/lib/prisma';
import { NextResponse } from 'next/server';
import { z } from 'zod';

const generateSchema = z.object({
  locationId: z.coerce.number().optional().nullable(),
  month: z.coerce.number().min(0).max(11),
  year: z.coerce.number().min(2024).max(2100),
});

export async function POST(request: Request) {
  try {
    const body = await request.json().catch(() => ({}));
    const { locationId, month, year } = generateSchema.parse(body);

    // 1. Determine which locations we are generating for
    const targetLocations = locationId 
      ? await prisma.location.findMany({ where: { id: locationId } })
      : await prisma.location.findMany();

    const allTemplates = await prisma.shiftTemplate.findMany();
    
    // 2. Define the Pay Period (28th of previous month to 27th of current month)
    const periodStart = new Date(year, month - 1, 28);
    const periodEnd = new Date(year, month, 27, 23, 59, 59);
    
    let createdCount = 0;

    for (const loc of targetLocations) {
      const locTemplates = allTemplates.filter(t => t.locationId === loc.id);
      const currentDate = new Date(periodStart);

      while (currentDate <= periodEnd) {
        const currentDayOfWeek = currentDate.getDay();
        
        // Filter templates that apply to this specific day of the week
        const dailyTemplates = locTemplates.filter(t => t.dayOfWeek === currentDayOfWeek);
        
        for (const t of dailyTemplates) {
          const [sHour, sMin] = t.startTime.split(':').map(Number);
          const [eHour, eMin] = t.endTime.split(':').map(Number);

          const startTime = new Date(currentDate);
          startTime.setHours(sHour, sMin, 0, 0);

          const endTime = new Date(currentDate);
          endTime.setHours(eHour, eMin, 0, 0);

          // Avoid creating duplicates for the exact same time/location
          const existingShift = await prisma.shift.findFirst({
            where: { 
              locationId: loc.id, 
              startTime: startTime, 
              endTime: endTime 
            }
          });

          if (!existingShift) {
            await prisma.shift.create({
              data: { 
                locationId: loc.id, 
                startTime: startTime, 
                endTime: endTime, 
                status: t.userId ? 'CLAIMED' : 'OPEN',
                userId: t.userId || null
              }
            });
            createdCount++;
          }
        }
        currentDate.setDate(currentDate.getDate() + 1);
      }
    }

    return NextResponse.json({ 
      message: "Schedule generated successfully", 
      count: createdCount 
    });
  } catch (error: any) {
    if (error instanceof z.ZodError) {
      return NextResponse.json({ error: "Invalid month or year provided" }, { status: 400 });
    }
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}
</file>

<file path="app/api/tasks/route.ts">
import { prisma } from '@/lib/prisma';
import { NextResponse } from 'next/server';
import { z } from 'zod';

export const dynamic = 'force-dynamic';

// Validation schemas
const createTaskSchema = z.object({
  name: z.string().min(2, "Task name must be at least 2 characters long").max(100),
});

const deleteTaskSchema = z.object({
  id: z.coerce.number(),
});

export async function GET() {
  try {
    const tasks = await prisma.globalTask.findMany({ 
      orderBy: { name: 'asc' } 
    });
    return NextResponse.json(tasks);
  } catch (error: any) {
    return NextResponse.json({ error: "Failed to fetch tasks" }, { status: 500 });
  }
}

export async function POST(request: Request) {
  try {
    const body = await request.json();
    const { name } = createTaskSchema.parse(body);

    const newTask = await prisma.globalTask.create({ 
      data: { name: name.trim() } 
    });
    
    return NextResponse.json(newTask);
  } catch (error: any) {
    // Handle Prisma unique constraint error (P2002)
    if (error.code === 'P2002') {
      return NextResponse.json({ error: "This task already exists" }, { status: 400 });
    }
    if (error instanceof z.ZodError) {
      return NextResponse.json({ error: error.errors[0].message }, { status: 400 });
    }
    return NextResponse.json({ error: "Server error creating task" }, { status: 500 });
  }
}

export async function DELETE(request: Request) {
  try {
    const body = await request.json();
    const { id } = deleteTaskSchema.parse(body);

    await prisma.globalTask.delete({ 
      where: { id } 
    });

    return NextResponse.json({ success: true });
  } catch (error: any) {
    if (error instanceof z.ZodError) {
      return NextResponse.json({ error: "Invalid task ID" }, { status: 400 });
    }
    return NextResponse.json({ error: "Could not delete task. It might still be linked to active templates." }, { status: 500 });
  }
}
</file>

<file path="app/api/templates/route.ts">
import { prisma } from '@/lib/prisma';
import { NextResponse } from 'next/server';
import { z } from 'zod';

const templateSchema = z.object({
  id: z.number().optional(),
  locationIds: z.array(z.coerce.number()).optional(),
  daysOfWeek: z.array(z.union([z.string(), z.number()])).optional(),
  startTime: z.string(),
  endTime: z.string(),
  startDate: z.string().nullable().optional(),
  endDate: z.string().nullable().optional(),
  checklistTasks: z.array(z.string()).default([]),
  userId: z.coerce.number().nullable().optional(),
});

export async function GET() {
  const templates = await prisma.shiftTemplate.findMany({
    include: { location: true, user: true }
  });
  return NextResponse.json(templates);
}

export async function POST(req: Request) {
  try {
    const body = await req.json();
    const data = templateSchema.parse(body);
    const created = [];

    if (!data.locationIds || !data.daysOfWeek) throw new Error("Missing locations or days");

    for (const locId of data.locationIds) {
      for (const day of data.daysOfWeek) {
        // Convert day name to 0-6 if necessary
        const dayInt = typeof day === 'number' ? day : ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'].indexOf(day.toLowerCase().substring(0, 3));
        
        const tpl = await prisma.shiftTemplate.create({
          data: {
            locationId: locId,
            dayOfWeek: dayInt,
            startTime: data.startTime,
            endTime: data.endTime,
            startDate: data.startDate,
            endDate: data.endDate,
            checklistTasks: data.checklistTasks,
            userId: data.userId || null
          }
        });
        created.push(tpl);
      }
    }
    return NextResponse.json({ success: true, count: created.length });
  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 400 });
  }
}

export async function PUT(req: Request) {
  try {
    const body = await req.json();
    const data = templateSchema.parse(body);
    if (!data.id) throw new Error("ID required");

    const updated = await prisma.shiftTemplate.update({
      where: { id: data.id },
      data: {
        startTime: data.startTime,
        endTime: data.endTime,
        startDate: data.startDate,
        endDate: data.endDate,
        checklistTasks: data.checklistTasks,
        userId: data.userId || null
      }
    });
    return NextResponse.json(updated);
  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 400 });
  }
}

export async function DELETE(req: Request) {
  const { id } = await req.json();
  await prisma.shiftTemplate.delete({ where: { id: parseInt(id) } });
  return NextResponse.json({ success: true });
}
</file>

<file path="app/api/timecards/route.ts">
import { prisma } from '@/lib/prisma';
import { NextResponse } from 'next/server';
import { z } from 'zod';

const timeCardSchema = z.object({
  id: z.number().optional(),
  userId: z.coerce.number(),
  locationId: z.coerce.number(),
  clockIn: z.string().datetime(),
  clockOut: z.string().datetime().nullable().optional(),
});

export async function GET() {
  try {
    const timeCards = await prisma.timeCard.findMany({
      include: { 
        user: true, 
        location: true, 
        checklists: true 
      },
      orderBy: { clockIn: 'desc' }
    });
    return NextResponse.json(timeCards);
  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}

export async function POST(req: Request) {
  try {
    const body = await req.json();
    const data = timeCardSchema.parse(body);

    const tc = await prisma.timeCard.create({
      data: {
        userId: data.userId,
        locationId: data.locationId,
        clockIn: new Date(data.clockIn),
        clockOut: data.clockOut ? new Date(data.clockOut) : null,
      }
    });
    return NextResponse.json(tc);
  } catch (error: any) {
    if (error instanceof z.ZodError) return NextResponse.json({ error: error.errors }, { status: 400 });
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}

export async function PUT(req: Request) {
  try {
    const body = await req.json();
    const data = timeCardSchema.parse(body);

    if (!data.id) return NextResponse.json({ error: "ID required" }, { status: 400 });

    const tc = await prisma.timeCard.update({
      where: { id: data.id },
      data: {
        userId: data.userId,
        locationId: data.locationId,
        clockIn: new Date(data.clockIn),
        clockOut: data.clockOut ? new Date(data.clockOut) : null,
      }
    });
    return NextResponse.json(tc);
  } catch (error: any) {
    if (error instanceof z.ZodError) return NextResponse.json({ error: error.errors }, { status: 400 });
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}

export async function DELETE(req: Request) {
  try {
    const data = await req.json();
    const id = z.coerce.number().parse(data.id);
    
    // Safety: Delete children first
    await prisma.checklist.deleteMany({
      where: { timeCardId: id }
    });

    await prisma.timeCard.delete({
      where: { id: id }
    });
    
    return NextResponse.json({ success: true });
  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}
</file>

<file path="app/api/timecards/seed/route.ts">
import { prisma } from '@/lib/prisma';
import { NextResponse } from 'next/server';

export async function POST(request: Request) {
  const actualWorkedData =[
    { yr: 2026, mo: 0, dt: 28, s: 16, e: 21, u: 'Fred Jimenez' },
    { yr: 2026, mo: 0, dt: 30, s: 15, e: 21, u: 'Chris Briell' },
    { yr: 2026, mo: 0, dt: 31, s: 9, e: 14, u: 'Chris Briell' },
    { yr: 2026, mo: 1, dt: 4, s: 16, e: 21, u: 'Fred Jimenez' },
    { yr: 2026, mo: 1, dt: 6, s: 15, e: 21, u: 'Chris Briell' },
    { yr: 2026, mo: 1, dt: 7, s: 9, e: 14, u: 'Chris Briell' },
    { yr: 2026, mo: 1, dt: 7, s: 14, e: 18, u: 'Colin Amatucci' },
    { yr: 2026, mo: 1, dt: 8, s: 8, e: 12, u: 'Colin Amatucci' },
    { yr: 2026, mo: 1, dt: 8, s: 12, e: 17, u: 'Colin Amatucci' }, 
    { yr: 2026, mo: 1, dt: 13, s: 15, e: 21, u: 'Chris Briell' },
    { yr: 2026, mo: 1, dt: 14, s: 9, e: 14, u: 'Chris Briell' },
    { yr: 2026, mo: 1, dt: 14, s: 14, e: 18, u: 'Colin Amatucci' },
    { yr: 2026, mo: 1, dt: 15, s: 8, e: 13, u: 'Colin Amatucci' }, 
    { yr: 2026, mo: 1, dt: 20, s: 15, e: 21, u: 'Chris Briell' },
    { yr: 2026, mo: 1, dt: 21, s: 9, e: 14, u: 'Chris Briell' },
    { yr: 2026, mo: 1, dt: 21, s: 14, e: 18, u: 'Colin Amatucci' },
    { yr: 2026, mo: 1, dt: 22, s: 8, e: 12, u: 'Sophia Kim' }
  ];

  try {
    // 1. Ensure the default location exists
    let loc = await prisma.location.findFirst({ where: { name: 'PnP Garner' } });
    if (!loc) {
      loc = await prisma.location.create({ data: { name: 'PnP Garner' } });
    }

    let users = await prisma.user.findMany();
    let importedCount = 0;
    let existedCount = 0;

    for (const item of actualWorkedData) {
      // 2. Safely find the user, ignoring case and accidental spaces
      let matchedUser = users.find(u => u.name.trim().toLowerCase() === item.u.trim().toLowerCase());
      
      // If the user doesn't exist in the DB anymore, force create them
      if (!matchedUser) {
        matchedUser = await prisma.user.create({
          data: {
            name: item.u,
            role: 'EMPLOYEE',
            systemRoles:['Front Desk'],
            locationIds: [loc.id]
          }
        });
        users.push(matchedUser); // Add to local array so subsequent loops find them
      }

      const clockInTime = new Date(item.yr, item.mo, item.dt, item.s, 0, 0, 0);
      const clockOutTime = new Date(item.yr, item.mo, item.dt, item.e, 0, 0, 0);
      
      const msDiff = clockOutTime.getTime() - clockInTime.getTime();
      const totalHours = parseFloat((msDiff / (1000 * 60 * 60)).toFixed(2));

      // 3. Check if this exact timecard is already attached to this user
      const existing = await prisma.timeCard.findFirst({
        where: { 
          userId: matchedUser.id, 
          clockIn: clockInTime 
        }
      });

      if (!existing) {
        await prisma.timeCard.create({
          data: {
            userId: matchedUser.id,
            locationId: loc.id,
            clockIn: clockInTime,
            clockOut: clockOutTime,
            totalHours: totalHours
          }
        });
        importedCount++;
      } else {
        existedCount++;
      }
    }

    // 4. Return a highly detailed response back to the button
    return NextResponse.json({ 
      count: `${importedCount} newly imported. (${existedCount} skipped because they were already in the database.)` 
    });

  } catch (error: any) {
    return NextResponse.json({ count: `Error: ${error.message}` }, { status: 500 });
  }
}
</file>

<file path="app/api/users/route.ts">
import { prisma } from '@/lib/prisma';
import { NextResponse } from 'next/server';
import { z } from 'zod';

const userUpdateSchema = z.object({
  id: z.coerce.number(),
  roles: z.array(z.string()).optional(),
  locationIds: z.array(z.coerce.number()).optional(),
});

export async function GET() {
  try {
    const users = await prisma.user.findMany({
      orderBy: { name: 'asc' }
    });
    return NextResponse.json(users);
  } catch (error: any) {
    return NextResponse.json({ error: "Failed to fetch users" }, { status: 500 });
  }
}

export async function PUT(request: Request) {
  try {
    const body = await request.json();
    const { id, roles, locationIds } = userUpdateSchema.parse(body);

    const updatedUser = await prisma.user.update({
      where: { id },
      data: {
        ...(roles && { systemRoles: roles }),
        ...(locationIds && { locationIds: locationIds }), 
      }
    });

    return NextResponse.json(updatedUser);
  } catch (error: any) {
    if (error instanceof z.ZodError) return NextResponse.json({ error: error.errors }, { status: 400 });
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}
</file>

<file path="lib/prisma.ts">
import { PrismaClient } from '@prisma/client';

const prismaClientSingleton = () => {
  return new PrismaClient();
};

declare const globalThis: {
  prismaGlobal: ReturnType<typeof prismaClientSingleton>;
} & typeof global;

export const prisma = globalThis.prismaGlobal ?? prismaClientSingleton();

if (process.env.NODE_ENV !== 'production') globalThis.prismaGlobal = prisma;
</file>

<file path="lib/types.ts">
export type Role = 'ADMIN' | 'MANAGER' | 'EMPLOYEE';

export interface Location {
  id: number;
  name: string;
}

export interface User {
  id: number;
  name: string;
  pinCode?: string | null;
  role: Role;
  systemRoles: string[];
  locationId?: number | null;
  locationIds?: number[];
  location?: Location;
}

export interface Shift {
  id: number;
  startTime: string;
  endTime: string;
  status: 'OPEN' | 'CLAIMED' | 'COVERAGE_REQUESTED';
  locationId: number;
  location?: Location;
  userId?: number | null;
  assignedTo?: User | null;
}

export interface TimeCard {
  id: number;
  clockIn: string;
  clockOut?: string | null;
  totalHours?: number | null;
  userId: number;
  user?: User;
  locationId: number;
  location?: Location;
  checklists?: Checklist[];
}

export interface Checklist {
  id: number;
  date: string;
  userId: number;
  user?: User;
  locationId: number;
  location?: Location;
  timeCardId?: number | null;
  notes?: string | null;
  completedTasks: string[];
  missedTasks: string[];
}

export interface Member {
  id: number;
  lastName: string;
  firstName: string;
  location?: string | null;
  notes?: string | null;
  bonusNotes?: string | null;
  family?: string | null;
  renewalDate?: string | null;
  totalPasses: number;
  lastBeverageDate?: string | null;
  usages: PassUsage[];
}

export interface PassUsage {
  id: number;
  dateUsed: string;
  amount: number;
  initials?: string | null;
  memberId: number;
}

export interface GiftCard {
  id: number;
  code: string;
  initialAmount: number;
  remainingBalance: number;
  recipientName?: string | null;
  memberId?: number | null;
  member?: { firstName: string; lastName: string };
  issuedAt: string;
}

export interface ShiftTemplate {
  id: number;
  locationId: number;
  location?: Location;
  dayOfWeek: number;
  startTime: string;
  endTime: string;
  startDate?: string | null;
  endDate?: string | null;
  checklistTasks: string[];
  userId?: number | null;
  user?: User;
}

export interface GlobalTask {
  id: number;
  name: string;
}

export interface Feedback {
  id: number;
  userId: number;
  user?: User;
  type: string;
  description: string;
  status: 'OPEN' | 'IN PROGRESS' | 'COMPLETED';
  devNotes?: string | null;
  createdAt: string;
}

export interface AppState {
  isMounted: boolean;
  activeTab: string;
  setActiveTab: (tab: string) => void;
  users: User[];
  locations: Location[];
  timeCards: TimeCard[];
  shifts: Shift[];
  members: Member[];
  templates: ShiftTemplate[];
  checklists: Checklist[];
  selectedUserId: string;
  setSelectedUserId: (id: string) => void;
  currentMonth: number;
  setCurrentMonth: (m: number) => void;
  currentYear: number;
  setCurrentYear: (y: number) => void;
  calLocFilter: string;
  setCalLocFilter: (id: string) => void;
  calEmpFilter: string;
  setCalEmpFilter: (id: string) => void;
  editingCardId: number | null;
  setEditingCardId: (id: number | null) => void;
  formDate: string;
  setFormDate: (d: string) => void;
  formStartTime: string;
  setFormStartTime: (t: string) => void;
  formEndTime: string;
  setFormEndTime: (t: string) => void;
  selectedLocation: string;
  setSelectedLocation: (id: string) => void;
  passSearch: string;
  setPassSearch: (s: string) => void;
  expandedMember: number | null;
  setExpandedMember: (id: number | null) => void;
  pDate: string;
  setPDate: (d: string) => void;
  pAmt: number | string;
  setPAmt: (a: number | string) => void;
  pInitials: string;
  setPInitials: (i: string) => void;
  editingTplId: number | null;
  setEditingTplId: (id: number | null) => void;
  tplLocs: number[];
  setTplLocs: (ids: number[]) => void;
  tplDays: (string | number)[];
  setTplDays: (days: (string | number)[]) => void;
  tplStart: string;
  setTplStart: (t: string) => void;
  tplEnd: string;
  setTplEnd: (t: string) => void;
  tplStartDate: string;
  setTplStartDate: (d: string) => void;
  tplEndDate: string;
  setTplEndDate: (d: string) => void;
  tplTasks: string[];
  setTplTasks: (tasks: string[]) => void;
  tplUserId: string;
  setTplUserId: (id: string) => void;
  tplViewLocs: number[];
  setTplViewLocs: (ids: number[]) => void;
  tplViewDays: number[];
  setTplViewDays: (days: number[]) => void;
  dashPeriodIndex: number;
  setDashPeriodIndex: (i: number) => void;
  dashLocs: number[];
  setDashLocs: (ids: number[]) => void;
  dashEmployees: number[];
  setDashEmployees: (ids: number[]) => void;
  manPeriods: number[];
  setManPeriods: (ids: number[]) => void;
  manLocs: number[];
  setManLocs: (ids: number[]) => void;
  manEmps: number[];
  setManEmps: (ids: number[]) => void;
  managerData: TimeCard[];
  DAYS_OF_WEEK: string[];
  MONTHS: string[];
  YEARS: number[];
  AVAILABLE_ROLES: string[];
  formatTimeSafe: (dStr: string) => string;
  formatDateSafe: (dStr: string) => string;
  getLocationColor: (locId: number | string) => any;
  showDashboard: boolean;
  showManagerView: boolean;
  showSetup: boolean;
  showReports: boolean;
  showStaff: boolean;
  showPasses: boolean;
  isManager: boolean;
  isAdmin: boolean;
  toggleDashLoc: (id: number) => void;
  toggleDashEmp: (id: number) => void;
  toggleManPeriod: (idx: number) => void;
  toggleManLoc: (id: number) => void;
  toggleManEmp: (id: number) => void;
  toggleTplLoc: (id: number) => void;
  toggleTplDay: (idx: string | number) => void;
  toggleTplViewLoc: (id: number) => void;
  toggleTplViewDay: (idx: number) => void;
  toggleTplTask: (taskName: string) => void;
  handleRoleToggle: (userId: number, role: string) => Promise<void>;
  handleUpdateUser: (userId: number, updates: any) => Promise<void>;
  handleSeedEmployees: () => Promise<void>;
  handleImportHistory: () => Promise<void>;
  handleImportTimecards: () => Promise<void>;
  handleImportPasses: () => Promise<void>;
  handleClaimShift: (shiftId: number) => Promise<void>;
  handleUnclaimShift: (shiftId: number) => Promise<void>;
  handleGenerateSchedule: () => Promise<void>;
  handleManualSubmit: (e: React.FormEvent) => Promise<void>;
  handleOpenReport: (card: TimeCard) => void;
  toggleChecklistTask: (taskName: string) => void;
  submitShiftReport: () => Promise<void>;
  handleEditTemplate: (t: ShiftTemplate) => void;
  handleSaveTemplate: (e: React.FormEvent) => Promise<void>;
  handleDeleteTemplate: (id: number) => Promise<void>;
  handleRedeemBeverage: (memberId: number) => Promise<void>;
  handleLogPass: (e: React.FormEvent, memberId: number) => Promise<void>;
  handleEditClick: (card: TimeCard) => void;
  handleDeleteClick: (cardId: number) => Promise<void>;
  handleExportCSV: () => void;
  periods: { label: string; start: string; end: string }[];
  dashData: { timeCards: TimeCard[] };
  showChecklistModal: boolean;
  setShowChecklistModal: (s: boolean) => void;
  reportTargetCard: TimeCard | null;
  setReportTargetCard: (c: TimeCard | null) => void;
  editingChecklistId: number | null;
  setEditingChecklistId: (id: number | null) => void;
  clDynamicTasks: string[];
  setClDynamicTasks: (t: string[]) => void;
  clCompletedTasks: string[];
  setClCompletedTasks: (t: string[]) => void;
  clNotes: string;
  setClNotes: (n: string) => void;
  globalTasks: GlobalTask[];
  setGlobalTasks: (t: GlobalTask[]) => void;
  fetchGlobalTasks: () => void;
  editingRenewalId: number | null;
  setEditingRenewalId: (id: number | null) => void;
  newRenewalDate: string;
  setNewRenewalDate: (d: string) => void;
  editingTotalId: number | null;
  setEditingTotalId: (id: number | null) => void;
  newTotalVal: number | string;
  setNewTotalVal: (v: number | string) => void;
  newBonusNotes: string;
  setNewBonusNotes: (n: string) => void;
  giftCards: GiftCard[];
  setGiftCards: (g: GiftCard[]) => void;
  fetchGiftCards: () => void;
  handleIssueGiftCard: (payload: any) => Promise<{ success: boolean }>;
  handleRedeemCard: (id: number, amount: number) => Promise<{ success: boolean }>;
  showGiftCards: boolean;
  isGiftCardsLoading: boolean;
  feedbacks: Feedback[];
  setFeedbacks: (f: Feedback[]) => void;
  fetchFeedbacks: () => void;
  handleSubmitFeedback: (payload: any) => Promise<{ success: boolean }>;
  handleUpdateFeedback: (id: number, payload: any) => Promise<{ success: boolean }>;
  isFeedbacksLoading: boolean;
  calendarCells: (number | null)[];
  activeCalColor: any;
  activeManPeriods: { label: string; start: string; end: string }[];
  matrixRows: any[];
  hiddenWarnings: string[];
  missingPunches: Shift[];
  dashVisibleData: any[];
  dashHiddenWarnings: string[];
  activeUserTimeCards: TimeCard[];
  filteredMembers: Member[];
  filteredTemplates: ShiftTemplate[];
}
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts

/app/generated/prisma

.vercel
</file>

<file path="app/api/giftcards/route.ts">
import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { z } from 'zod';

const issueCardSchema = z.object({
  code: z.string().min(3),
  amount: z.coerce.number().positive(),
  memberId: z.coerce.number().nullable().optional(),
  recipientName: z.string().nullable().optional(),
});

export async function GET() {
  try {
    const giftCards = await prisma.giftCard.findMany({
      include: { 
        member: {
          select: { firstName: true, lastName: true }
        }
      },
      orderBy: { issuedAt: 'desc' },
    });
    return NextResponse.json(giftCards);
  } catch (error) {
    return NextResponse.json({ error: 'Failed to fetch' }, { status: 500 });
  }
}

export async function POST(req: Request) {
  try {
    const body = await req.json();
    const data = issueCardSchema.parse(body);

    const newGiftCard = await prisma.giftCard.create({
      data: {
        code: data.code,
        initialAmount: data.amount,
        remainingBalance: data.amount,
        memberId: data.memberId || null,
        recipientName: data.memberId ? null : data.recipientName,
      },
      include: { 
        member: { select: { firstName: true, lastName: true } }
      }
    });

    return NextResponse.json(newGiftCard);
  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 400 });
  }
}
</file>

<file path="app/components/TimeCardTab.tsx">
"use client";
import React, { useState, useEffect } from 'react';
import { AppState, TimeCard, User, Location, ShiftTemplate, Checklist } from '../lib/types';

// --- SUB-COMPONENT: Individual Time Card Row ---
const TimeCardRow = ({ 
  card, activeUser, locations, templates, formatTimeSafe, formatDateSafe, checklists 
}: {
  card: TimeCard,
  activeUser?: User,
  locations: Location[],
  templates: ShiftTemplate[],
  formatTimeSafe: (d: string) => string,
  formatDateSafe: (d: string) => string,
  checklists: Checklist[]
}) => {
  const outD = new Date(card.clockOut || '');
  const isActive = !card.clockOut || isNaN(outD.getTime()) || outD.getFullYear() === 1970;
  
  // Find the report safely from the global checklists array
  const globalReport = checklists?.find((c: Checklist) => c.timeCardId === card.id);
  const activeReport = globalReport || (card.checklists && card.checklists.length > 0 ? card.checklists[0] : null);

  // Smarter Template Matching Logic
  let bestTpl: ShiftTemplate | null = null;
  const tcDate = new Date(card.clockIn);
  const day = tcDate.getDay();
  const mins = tcDate.getHours() * 60 + tcDate.getMinutes();

  const todayTpls = templates?.filter(t => t.locationId === card.locationId && t.dayOfWeek === day) ||[];
  if (todayTpls.length === 1) {
    bestTpl = todayTpls[0];
  } else if (todayTpls.length > 1) {
    let minDiff = 9999;
    todayTpls.forEach(t => {
      const parts = t.startTime.split(':');
      const tMins = parseInt(parts[0]) * 60 + parseInt(parts[1]);
      const diff = Math.abs(mins - tMins);
      if (diff < minDiff) { minDiff = diff; bestTpl = t; }
    });
  }

  const assignedTasks = bestTpl ? (bestTpl.checklistTasks || []) : [];
  
  // Local State for Inline Editing
  const [isExpanded, setIsExpanded] = useState(isActive); 
  const [completedTasks, setCompletedTasks] = useState<string[]>(activeReport ? activeReport.completedTasks || [] : []);
  const [notes, setNotes] = useState(activeReport ? activeReport.notes || '' : '');
  const [reportId, setReportId] = useState<number | null>(activeReport?.id || null);
  const [isSaving, setIsSaving] = useState(false);
  const[savedOnce, setSavedOnce] = useState(!!activeReport);

  // Ensure state updates if checklists load AFTER the component mounts (on screen refresh)
  useEffect(() => {
    if (globalReport && !reportId) {
      setCompletedTasks(globalReport.completedTasks ||[]);
      setNotes(globalReport.notes || '');
      setReportId(globalReport.id);
      setSavedOnce(true);
    }
  }, [globalReport, reportId]);

  const progressPct = assignedTasks.length > 0 ? Math.round((completedTasks.length / assignedTasks.length) * 100) : (completedTasks.length > 0 ? 100 : 0);

  // Core Save Logic
  const saveInlineReport = async (tasksToSave = completedTasks, notesToSave = notes) => {
    setIsSaving(true);
    const missed = assignedTasks.filter(t => !tasksToSave.includes(t));
    const payload: any = { notes: notesToSave, completedTasks: tasksToSave, missedTasks: missed };

    try {
      if (reportId) {
        payload.id = reportId;
        await fetch('/api/checklists', { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
      } else {
        payload.userId = card.userId;
        payload.locationId = card.locationId;
        payload.timeCardId = card.id;
        const res = await fetch('/api/checklists', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
        const data = await res.json();
        if (data && data.id) {
          setReportId(data.id);
        }
      }

      setSavedOnce(true);
      setTimeout(() => setIsSaving(false), 500); 
    } catch (err) {
      console.error("Failed to save report:", err);
      setIsSaving(false);
    }
  };

  const toggleTask = (task: string) => {
    if (!isActive) return;
    const updatedTasks = completedTasks.includes(task) 
      ? completedTasks.filter(t => t !== task) 
      : [...completedTasks, task];
      
    setCompletedTasks(updatedTasks);
    saveInlineReport(updatedTasks, notes); // Auto-save instantly on click!
  };

  const handleNotesBlur = () => {
    if (isActive) saveInlineReport(completedTasks, notes);
  };

  return (
    <div className={`relative bg-white rounded-2xl p-5 md:p-6 shadow-md border transition-all duration-300 ${isActive ? 'border-l-[8px] border-l-blue-600 border-blue-200' : 'border-slate-300'}`}>
      
      {/* Header Row */}
      <div className="flex justify-between items-start mb-5">
        <div>
          <h3 className="text-xl md:text-2xl font-black text-slate-900 tracking-tight leading-none mb-2">
            {formatDateSafe(card.clockIn)}
          </h3>
          <span className="text-[11px] font-black text-blue-900 bg-blue-100 border border-blue-300 px-3 py-1 rounded shadow-sm uppercase tracking-widest">
            {activeUser?.name || 'Unknown'}
          </span>
        </div>
        <div>
          {isActive ? (
            <div className="flex items-center gap-1.5 text-xs font-black tracking-widest text-blue-800 bg-blue-50 px-4 py-2 rounded-full border border-blue-300 shadow-sm animate-pulse">
              <span className="w-2 h-2 rounded-full bg-blue-600"></span> ACTIVE
            </div>
          ) : (
            <div className="text-[10px] font-black tracking-widest text-slate-600 bg-slate-100 px-4 py-2 rounded-full border border-slate-300 shadow-sm">
              CLOSED
            </div>
          )}
        </div>
      </div>

      {/* Times & Location Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-5">
        <div className="bg-slate-50 p-4 rounded-xl border border-slate-300 flex items-center justify-between shadow-inner">
          <div className="flex flex-col">
            <span className="text-[10px] font-black text-slate-600 uppercase tracking-widest mb-0.5">Clocked In</span>
            <span className="text-sm md:text-base font-black text-slate-900">{formatTimeSafe(card.clockIn)}</span>
          </div>
          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-slate-400 mx-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
          <div className="flex flex-col items-end">
            <span className="text-[10px] font-black text-slate-600 uppercase tracking-widest mb-0.5">Clocked Out</span>
            <span className={`text-sm md:text-base font-black ${isActive ? 'text-blue-700 italic' : 'text-slate-900'}`}>
              {isActive ? 'Working...' : formatTimeSafe(card.clockOut!)}
            </span>
          </div>
        </div>

        <div className="bg-slate-50 p-4 rounded-xl border border-slate-300 flex items-center gap-3 shadow-inner">
          <div className="bg-white p-2.5 rounded-lg shadow-sm border border-slate-200">
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-slate-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.242-4.243a8 8 0 1111.314 0z" />
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </div>
          <div className="flex flex-col">
            <span className="text-[10px] font-black text-slate-600 uppercase tracking-widest mb-0.5">Location</span>
            <span className="text-sm md:text-base font-bold text-slate-900 truncate">{locations?.find(l => l.id === card.locationId)?.name || 'Unknown Location'}</span>
          </div>
        </div>
      </div>

      {/* EXPANDABLE SHIFT REPORT ACCORDION */}
      <div className="mt-2 border-2 border-slate-200 rounded-xl overflow-hidden shadow-sm bg-slate-50">
        
        <button 
          onClick={() => setIsExpanded(!isExpanded)} 
          className="w-full bg-white hover:bg-slate-50 p-4 flex justify-between items-center transition-colors focus:outline-none"
        >
          <div className="flex items-center gap-3">
            <div className={`p-2 rounded-lg ${isActive ? 'bg-blue-100 text-blue-800' : 'bg-slate-200 text-slate-700'}`}>
              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clipRule="evenodd" />
              </svg>
            </div>
            <div className="text-left">
              <span className="block font-black text-slate-900 text-sm md:text-base uppercase tracking-wider">
                Shift Report
              </span>
              <span className={`text-xs font-bold ${progressPct === 100 ? 'text-green-700' : 'text-slate-600'}`}>
                {assignedTasks.length > 0 ? `${completedTasks.length} / ${assignedTasks.length} Tasks Done` : (completedTasks.length > 0 ? `${completedTasks.length} Extra Tasks Done` : (notes ? 'Notes Saved' : 'No Tasks Assigned'))}
              </span>
            </div>
          </div>
          
          <div className="flex items-center gap-4">
            {assignedTasks.length > 0 && (
              <div className="hidden md:flex items-center justify-center w-8 h-8 rounded-full border-[3px] border-slate-300 relative">
                <svg className="absolute w-8 h-8 -rotate-90">
                  <circle cx="16" cy="16" r="14" fill="none" stroke="currentColor" strokeWidth="3" className="text-blue-600 transition-all duration-500" strokeDasharray="88" strokeDashoffset={88 - (88 * progressPct) / 100} />
                </svg>
              </div>
            )}
            <svg xmlns="http://www.w3.org/2000/svg" className={`h-6 w-6 text-slate-600 transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M19 9l-7 7-7-7" />
            </svg>
          </div>
        </button>

        {!isExpanded && notes && (
          <div className="px-5 pb-4 pt-1 bg-white text-left border-t border-slate-200">
            <span className="text-[10px] font-black text-slate-600 uppercase tracking-widest block mb-1">Notes Saved:</span>
            <p className="text-sm text-slate-800 font-semibold italic truncate">"{notes}"</p>
          </div>
        )}

        {isExpanded && (
          <div className="p-4 md:p-6 border-t-2 border-slate-200 bg-slate-50">
            
            {/* Task Checklist */}
            <div className="mb-6">
              <h4 className="text-xs font-black text-slate-700 uppercase tracking-widest mb-3">Facility Tasks</h4>
              
              {assignedTasks.length > 0 ? (
                <div className="space-y-2">
                  {assignedTasks.map((task: string, idx: number) => {
                    const isDone = completedTasks.includes(task);
                    return (
                      <label key={idx} className={`flex items-start gap-3 p-3 rounded-xl border-2 transition-all duration-200 ${!isActive ? 'cursor-default' : 'cursor-pointer'} ${isDone ? 'bg-green-50 border-green-300' : 'bg-white border-slate-300 hover:border-blue-400 shadow-sm'}`}>
                        <input 
                          type="checkbox" 
                          checked={isDone} 
                          onChange={() => toggleTask(task)} 
                          disabled={!isActive}
                          className="mt-0.5 w-5 h-5 rounded border-slate-400 text-green-700 focus:ring-green-600 disabled:opacity-60 cursor-pointer" 
                        />
                        <span className={`text-sm font-bold leading-snug transition-all ${isDone ? 'text-green-900 line-through opacity-70' : 'text-slate-900'}`}>
                          {task}
                        </span>
                      </label>
                    );
                  })}
                </div>
              ) : (
                <div className="bg-white p-4 rounded-xl border-2 border-slate-300 shadow-sm">
                  {completedTasks.length > 0 ? (
                    <ul className="space-y-2">
                      {completedTasks.map((task: string, idx: number) => (
                        <li key={idx} className="flex items-start gap-2 text-sm font-bold text-slate-700">
                          <svg className="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>
                          {task}
                        </li>
                      ))}
                    </ul>
                  ) : (
                    <p className="text-sm font-bold text-slate-600 italic">No specific tasks were assigned to this shift.</p>
                  )}
                </div>
              )}
            </div>

            {/* Shift Notes Field */}
            <div className="mb-4">
              <h4 className="text-xs font-black text-slate-700 uppercase tracking-widest mb-2 flex items-center gap-1.5">
                Shift Notes <span className="font-medium normal-case tracking-normal">(Required if skipping tasks)</span>
              </h4>
              <textarea 
                value={notes} 
                onChange={(e) => setNotes(e.target.value)} 
                onBlur={handleNotesBlur} 
                readOnly={!isActive}
                placeholder={isActive ? "Report any issues, missing supplies, or pass-downs for the manager here..." : "No notes saved."}
                className={`w-full border-2 rounded-xl p-4 text-sm font-bold outline-none resize-none transition-colors ${isActive ? 'border-slate-300 bg-white text-slate-900 focus:border-blue-500 shadow-sm' : 'border-slate-200 bg-slate-100 text-slate-800'}`}
                rows={3}
              ></textarea>
            </div>

            {/* Manual Save Button */}
            {isActive && (
              <button 
                onClick={() => saveInlineReport(completedTasks, notes)} 
                disabled={isSaving}
                className="w-full bg-slate-900 hover:bg-black text-white font-black py-4 rounded-xl shadow-md transition flex justify-center items-center gap-2"
              >
                {isSaving ? (
                  <span className="animate-pulse">Auto-Saving...</span>
                ) : (
                  <>
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                    </svg>
                    {savedOnce ? 'Shift Report Saved' : 'Save Shift Report'}
                  </>
                )}
              </button>
            )}

          </div>
        )}
      </div>

    </div>
  );
};

// --- MAIN TAB COMPONENT ---
export default function TimeCardTab({ appState }: { appState: AppState }) {
  const {
    activeUserTimeCards, formatTimeSafe, formatDateSafe,
    selectedUserId, users, templates, locations, checklists
  } = appState;

  const activeUser = users?.find(u => u.id === parseInt(selectedUserId));

  return (
    <div className="space-y-6 max-w-3xl mx-auto">
      <div className="bg-transparent">
        <h2 className="text-xl md:text-2xl font-black text-slate-900 mb-5 px-1">Your Time & Shift Reports</h2>
        
        {(!activeUserTimeCards || activeUserTimeCards.length === 0) ? (
          <div className="bg-white p-8 rounded-2xl border-2 border-slate-200 text-center shadow-sm">
            <p className="text-slate-600 font-bold text-sm">No recent time cards found.</p>
          </div>
        ) : (
          <div className="space-y-6">
            {[...activeUserTimeCards].sort((a, b) => new Date(b.clockIn).getTime() - new Date(a.clockIn).getTime()).map(card => (
              <TimeCardRow 
                key={card.id} 
                card={card} 
                activeUser={activeUser} 
                locations={locations} 
                templates={templates} 
                formatDateSafe={formatDateSafe} 
                formatTimeSafe={formatTimeSafe} 
                checklists={checklists}
              />
            ))}
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="app/globals.css">
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}
</file>

<file path="app/kiosk/page.tsx">
"use client";
import React, { useState, useEffect } from 'react';

export default function KioskPage() {
  const[isMounted, setIsMounted] = useState(false);
  
  const [users, setUsers] = useState<any[]>([]);
  const [locations, setLocations] = useState<any[]>([]);
  const[openCards, setOpenCards] = useState<any[]>([]);
  
  // Selection State
  const [selectedUserId, setSelectedUserId] = useState('');
  const [selectedLocationId, setSelectedLocationId] = useState('');
  
  // Security PIN State
  const [pinCode, setPinCode] = useState('');
  const [pinError, setPinError] = useState('');

  const [currentTime, setCurrentTime] = useState(new Date());

  // Keep the big clock ticking
  useEffect(() => {
    setIsMounted(true); 
    const timer = setInterval(() => setCurrentTime(new Date()), 1000);
    return () => clearInterval(timer);
  },[]);

  useEffect(() => {
    fetch('/api/users?t=' + new Date().getTime()).then(res => res.json()).then(data => setUsers(data));
    fetch('/api/locations?t=' + new Date().getTime()).then(res => res.json()).then(data => {
      setLocations(data);
      if (data && data.length > 0) setSelectedLocationId(data[0].id);
    });
    fetchOpenCards();
  },[]);

  const fetchOpenCards = () => {
    fetch('/api/kiosk?t=' + new Date().getTime()).then(res => res.json()).then(data => setOpenCards(data));
  };

  const activeCard = selectedUserId ? openCards.find((c: any) => c.userId === parseInt(selectedUserId)) : null;

  // Keypad Handlers
  const handleNumberClick = (num: string) => {
    if (pinCode.length < 4) {
      setPinCode(prev => prev + num);
      setPinError('');
    }
  };

  const handleClear = () => {
    setPinCode('');
    setPinError('');
  };

  const handleBackspace = () => {
    setPinCode(prev => prev.slice(0, -1));
    setPinError('');
  };

  const handleClockIn = async () => {
    if (!selectedUserId || !selectedLocationId) return alert("Select your name and location!");
    
    const res = await fetch('/api/kiosk', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'CLOCK_IN', userId: selectedUserId, locationId: selectedLocationId, pinCode })
    });

    if (!res.ok) {
      const err = await res.json();
      setPinError(err.error || 'Invalid PIN code');
      setPinCode('');
      return;
    }

    setSelectedUserId('');
    setPinCode('');
    fetchOpenCards();
  };

  const handleClockOut = async () => {
    if (!activeCard) return;

    const res = await fetch('/api/kiosk', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'CLOCK_OUT', timeCardId: activeCard.id, pinCode })
    });

    if (!res.ok) {
      const err = await res.json();
      setPinError(err.error || 'Invalid PIN code');
      setPinCode('');
      return;
    }

    setSelectedUserId('');
    setPinCode('');
    fetchOpenCards();
  };

  if (!isMounted) return <div className="min-h-screen bg-slate-900 flex items-center justify-center text-white font-bold text-2xl">Loading Kiosk...</div>;

  return (
    <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-6 font-sans">
      
      <div className="w-full max-w-2xl bg-white rounded-3xl shadow-2xl overflow-hidden border-b-8 border-green-800">
        
        {/* Branding Header */}
        <div className="bg-slate-100 p-8 flex flex-col items-center border-b border-gray-200">
          <img src="/logo.png" alt="Pickles & Play Logo" className="h-24 w-auto object-contain mb-4 drop-shadow-md" onError={(e) => e.currentTarget.style.display = 'none'} />
          <h1 className="text-4xl font-black tracking-widest text-slate-900 uppercase italic">
            <span className="text-yellow-500">Pickles</span> & Play
          </h1>
          <p className="text-sm text-gray-500 font-bold uppercase tracking-widest mt-2">Employee Time Clock</p>
        </div>

        <div className="p-10 flex flex-col items-center">
          
          {/* Big Digital Clock */}
          <div className="text-center mb-10">
            <p className="text-xl font-bold text-gray-500 uppercase tracking-widest">{currentTime.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric'})}</p>
            <div className="text-7xl font-black text-slate-900 tracking-tighter mt-2 drop-shadow-sm">
              {currentTime.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit', second: '2-digit'})}
            </div>
          </div>

          {/* Conditional UI: Dropdowns OR Numpad */}
          {!selectedUserId ? (
            <div className="w-full space-y-6 animate-in fade-in duration-300">
              <div>
                <label className="block text-sm font-black text-slate-500 uppercase tracking-wider mb-2">Location</label>
                <select value={selectedLocationId} onChange={(e) => setSelectedLocationId(e.target.value)} className="w-full border-2 border-gray-300 rounded-xl p-4 text-xl font-bold text-slate-900 bg-slate-50 shadow-inner outline-none focus:border-green-600">
                  {locations.map((loc: any) => <option key={loc.id} value={loc.id}>{loc.name}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm font-black text-slate-500 uppercase tracking-wider mb-2">Select Your Name</label>
                <select 
                  value={selectedUserId} 
                  onChange={(e) => {
                    setSelectedUserId(e.target.value);
                    setPinCode('');
                    setPinError('');
                  }} 
                  className="w-full border-2 border-gray-300 rounded-xl p-4 text-xl font-bold text-slate-900 bg-slate-50 shadow-inner outline-none focus:border-blue-600 cursor-pointer"
                >
                  <option value="">-- Tap to Select Employee --</option>
                  {users.map((u: any) => <option key={u.id} value={u.id}>{u.name}</option>)}
                </select>
              </div>
            </div>
          ) : (
            <div className="w-full flex flex-col items-center animate-in slide-in-from-bottom-4 duration-300">
              
              <h3 className="text-2xl font-black text-slate-800 mb-2">
                Hello, {users.find(u => u.id === parseInt(selectedUserId))?.name}
              </h3>
              <p className="text-sm font-bold text-slate-500 uppercase tracking-widest mb-6">Enter your 4-digit PIN</p>

              {/* Secure PIN Indicator Dots */}
              <div className="flex gap-4 mb-6">
                 {[...Array(4)].map((_, i) => (
                    <div key={i} className={`w-12 h-12 rounded-full border-4 flex items-center justify-center text-3xl font-black transition-all ${pinCode.length > i ? 'border-slate-900 bg-slate-900 text-white' : 'border-gray-300 bg-gray-50'}`}>
                       {pinCode.length > i ? '' : ''}
                    </div>
                 ))}
               </div>

               {/* Error Message Space */}
               <div className="h-6 mb-4">
                 {pinError && <p className="text-red-500 font-bold uppercase tracking-widest text-sm animate-pulse">{pinError}</p>}
               </div>

               {/* Numpad */}
               <div className="grid grid-cols-3 gap-4 mb-8">
                  {[1,2,3,4,5,6,7,8,9].map(num => (
                     <button key={num} onClick={() => handleNumberClick(num.toString())} className="w-20 h-20 bg-slate-100 hover:bg-slate-200 rounded-full text-3xl font-black text-slate-800 transition-colors shadow-sm">{num}</button>
                  ))}
                  <button onClick={handleClear} className="w-20 h-20 bg-red-50 hover:bg-red-100 rounded-full text-lg font-black text-red-600 transition-colors shadow-sm">CLR</button>
                  <button onClick={() => handleNumberClick('0')} className="w-20 h-20 bg-slate-100 hover:bg-slate-200 rounded-full text-3xl font-black text-slate-800 transition-colors shadow-sm">0</button>
                  <button onClick={handleBackspace} className="w-20 h-20 bg-gray-200 hover:bg-gray-300 rounded-full text-xl font-black text-slate-700 transition-colors shadow-sm"></button>
               </div>

               {/* Submit Action Buttons */}
               {activeCard ? (
                 <div className="w-full flex flex-col gap-3">
                   <div className="bg-yellow-50 border border-yellow-400 text-yellow-800 text-center p-3 rounded-lg font-bold">
                     You clocked in at {new Date(activeCard.clockIn).toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'})}
                   </div>
                   <button onClick={handleClockOut} disabled={pinCode.length !== 4} className="w-full bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-black text-3xl py-6 rounded-2xl shadow-lg transition transform hover:scale-[1.02]">
                     CLOCK OUT
                   </button>
                 </div>
               ) : (
                 <button onClick={handleClockIn} disabled={pinCode.length !== 4} className="w-full bg-green-700 hover:bg-green-800 disabled:opacity-50 disabled:cursor-not-allowed text-white font-black text-3xl py-6 rounded-2xl shadow-lg transition transform hover:scale-[1.02]">
                   CLOCK IN
                 </button>
               )}

               <button 
                 onClick={() => { setSelectedUserId(''); setPinCode(''); setPinError(''); }} 
                 className="mt-6 text-slate-400 font-bold hover:text-slate-800 transition-colors uppercase tracking-widest text-xs"
               >
                 Go Back / Change Employee
               </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="New Text Document.txt">

</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="app/api/giftcards/[id]/route.ts">
import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { z } from 'zod';

const redemptionSchema = z.object({
  redemptionAmount: z.coerce.number().positive()
});

export async function PUT(req: Request, props: { params: Promise<{ id: string }> }) {
  try {
    const params = await props.params;
    const id = parseInt(params.id);
    const body = await req.json();
    const { redemptionAmount } = redemptionSchema.parse(body);

    const card = await prisma.giftCard.findUnique({ where: { id } });
    if (!card) return NextResponse.json({ error: 'Card not found' }, { status: 404 });

    // Precise decimal math to prevent floating point errors
    let newBalance = Math.round((card.remainingBalance - redemptionAmount) * 100) / 100;

    if (newBalance < 0) {
      return NextResponse.json({ 
        error: `Insufficient balance. Available: $${card.remainingBalance.toFixed(2)}` 
      }, { status: 400 });
    }

    const updatedCard = await prisma.giftCard.update({
      where: { id },
      data: { remainingBalance: newBalance },
      include: { 
        member: { select: { firstName: true, lastName: true } }
      }
    });

    return NextResponse.json(updatedCard);
  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 400 });
  }
}
</file>

<file path="app/components/CalendarTab.tsx">
"use client";
import React from 'react';
import { AppState, Shift, Location, User } from '../lib/types';

export default function CalendarTab({ appState }: { appState: AppState }) {
  const {
    currentMonth, setCurrentMonth, currentYear, setCurrentYear, MONTHS, YEARS,
    calLocFilter, setCalLocFilter, locations, calEmpFilter, setCalEmpFilter, users,
    showSetup, handleGenerateSchedule, DAYS_OF_WEEK, activeCalColor, calendarCells,
    shifts, selectedUserId, getLocationColor, formatTimeSafe, handleClaimShift,
    isAdmin, isManager
  } = appState;

  // --- ROLE & LOCATION FILTERING LOGIC ---
  const activeUserObj = users.find(u => u.id === parseInt(selectedUserId));
  const userLocationIds = activeUserObj?.locationIds || [];
  const allowedLocationIds = userLocationIds.map(id => typeof id === 'string' ? parseInt(id, 10) : id);

  const visibleLocations = (isAdmin || isManager) 
    ? locations 
    : locations.filter(loc => allowedLocationIds.includes(loc.id));

  const handleRequestCover = async (shiftId: number) => {
    if(!confirm("Are you sure you need coverage? The shift will turn orange and be offered to other employees.")) return;
    await fetch('/api/shifts', { 
      method: 'POST', 
      headers: {'Content-Type': 'application/json'}, 
      body: JSON.stringify({ shiftId: shiftId, action: 'REQUEST_COVER' }) 
    });
    window.location.reload(); 
  };

  const handleCancelCover = async (shiftId: number) => {
    await fetch('/api/shifts', { 
      method: 'POST', 
      headers: {'Content-Type': 'application/json'}, 
      body: JSON.stringify({ shiftId: shiftId, action: 'CANCEL_COVER' }) 
    });
    window.location.reload();
  };

  const claimCoverage = async (shiftId: number) => {
    if(!selectedUserId) return alert("Select an active employee at the top first!");
    if(!confirm("Are you sure you want to cover this shift? It will become yours.")) return;
    await fetch('/api/shifts', { 
      method: 'POST', 
      headers: {'Content-Type': 'application/json'}, 
      body: JSON.stringify({ shiftId: shiftId, userId: parseInt(selectedUserId), action: 'CLAIM' }) 
    });
    window.location.reload();
  };

  return (
    <div className="bg-white p-4 md:p-6 rounded-xl border border-gray-300 shadow-sm">
      <div className="flex flex-col xl:flex-row justify-between items-center mb-6 bg-slate-100 p-4 rounded-xl border border-gray-300 gap-4 shadow-inner text-sm">
        
        <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full xl:w-auto">
          <select value={currentMonth} onChange={(e) => setCurrentMonth(parseInt(e.target.value))} className="w-full sm:w-auto border border-gray-400 rounded-lg p-2 font-black text-slate-900 bg-white shadow-sm outline-none">
            {MONTHS.map((m, i) => <option key={i} value={i}>{m}</option>)}
          </select>
          <select value={currentYear} onChange={(e) => setCurrentYear(parseInt(e.target.value))} className="w-full sm:w-auto border border-gray-400 rounded-lg p-2 font-black text-slate-900 bg-white shadow-sm outline-none">
            {YEARS.map((y) => <option key={y} value={y}>{y}</option>)}
          </select>
        </div>

        <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full xl:w-auto">
          <select value={calLocFilter} onChange={(e) => setCalLocFilter(e.target.value)} className="w-full sm:w-auto border border-blue-400 rounded-lg p-2 font-bold text-slate-900 bg-blue-50 shadow-sm outline-none">
            <option value="">All Available Locations</option>
            {visibleLocations.map(loc => (
              <option key={loc.id} value={loc.id}>{loc.name}</option>
            ))}
          </select>
          <select value={calEmpFilter} onChange={(e) => setCalEmpFilter(e.target.value)} className="w-full sm:w-auto border border-blue-400 rounded-lg p-2 font-bold text-slate-900 bg-blue-50 shadow-sm outline-none">
            <option value="">All Employees</option>
            <option value="OPEN">Open (Unclaimed)</option>
            {users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
          </select>
        </div>

        {showSetup && (
          <button onClick={handleGenerateSchedule} className="w-full xl:w-auto bg-green-800 hover:bg-green-900 text-white font-bold py-2 px-4 rounded-lg shadow-md whitespace-nowrap transition">
            + Generate Schedule
          </button>
        )}
      </div>
      
      <div className="overflow-x-auto pb-4">
        <div style={{ minWidth: '800px' }}>
          <div className="grid grid-cols-7 gap-2 mb-2">
            {DAYS_OF_WEEK.map(dayName => (
              <div key={dayName} className={`font-black text-center py-2 rounded-t-lg border shadow-sm ${activeCalColor.bg} ${activeCalColor.text} ${activeCalColor.border}`}>
                {dayName}
              </div>
            ))}
          </div>

          <div className="grid grid-cols-7 gap-2 border-l border-t border-gray-300 bg-gray-200 rounded-b-lg overflow-hidden shadow-inner">
            {calendarCells.map((dayNum, index) => {
              const dayShifts = dayNum ? shifts.filter(shift => {
                const shiftLocId = shift.locationId;

                if (!isAdmin && !isManager) {
                  if (!allowedLocationIds.includes(shiftLocId)) return false;
                }

                const sd = new Date(shift.startTime);
                const isSameDay = sd.getFullYear() === currentYear && sd.getMonth() === currentMonth && sd.getDate() === dayNum;
                
                let locMatch = true;
                if (calLocFilter !== '') locMatch = shiftLocId === parseInt(calLocFilter, 10);
                
                let empMatch = true;
                if (calEmpFilter === 'OPEN') empMatch = shift.status === 'OPEN';
                else if (calEmpFilter !== '') empMatch = shift.userId === parseInt(calEmpFilter, 10);
                
                return isSameDay && locMatch && empMatch;
              }) : [];

              const rightNow = new Date();
              const isToday = dayNum && dayNum === rightNow.getDate() && currentMonth === rightNow.getMonth() && currentYear === rightNow.getFullYear();

              return (
                <div key={index} className={`bg-white min-h-32 border-r border-b border-gray-300 p-2 flex flex-col relative ${isToday ? 'ring-4 ring-inset ring-yellow-400 bg-yellow-50 z-10' : ''}`}>
                  {dayNum && (
                    <>
                      <div className={`text-right font-black mb-2 flex justify-between items-center ${isToday ? 'text-slate-900 text-base' : 'text-gray-400 text-sm'}`}>
                        {isToday ? <span style={{ fontSize: '10px' }} className="bg-yellow-400 text-slate-900 px-1.5 py-0.5 rounded shadow-sm tracking-widest uppercase">Today</span> : <span></span>}
                        <span>{dayNum}</span>
                      </div>
                      <div className="space-y-2 overflow-y-auto flex-grow">
                        {dayShifts.map(shift => {
                          const isMyShift = shift.userId === parseInt(selectedUserId);
                          const shiftColor = getLocationColor(shift.locationId);

                          let finalBg = 'bg-white';
                          let finalBorder = shiftColor.border;
                          if (shift.status === 'OPEN') {
                            finalBg = 'bg-green-50';
                            finalBorder = 'border-green-300';
                          } else if (shift.status === 'COVERAGE_REQUESTED') {
                            finalBg = 'bg-orange-50';
                            finalBorder = 'border-orange-500';
                          }

                          return (
                            <div key={shift.id} className={`p-2 rounded text-xs border-l-4 shadow-md mb-2 ${finalBg} ${finalBorder}`}>
                              <div className="font-bold text-slate-900 whitespace-nowrap overflow-hidden text-ellipsis mb-1">
                                {formatTimeSafe(shift.startTime)} - {formatTimeSafe(shift.endTime)}
                              </div>
                              <div className={`text-xs font-bold mb-1 truncate ${shiftColor.text}`}>
                                {shift.location?.name}
                              </div>
                              
                              {shift.status === 'OPEN' ? (
                                <button onClick={() => { handleClaimShift(shift.id); setTimeout(() => window.location.reload(), 500); }} className={`w-full mt-1 text-white font-bold py-1.5 rounded shadow-sm transition ${shiftColor.claim}`}>
                                  Claim
                                </button>
                              ) : shift.status === 'COVERAGE_REQUESTED' ? (
                                <div className="mt-1 flex flex-col gap-1">
                                  <div className="font-bold text-center truncate px-1 py-1 rounded shadow-sm border bg-orange-100 text-orange-900 border-orange-500">
                                    {isMyShift ? 'You Requested Cover' : `${shift.assignedTo?.name || 'Staff'} Needs Cover`}
                                  </div>
                                  {isMyShift ? (
                                    <button onClick={() => handleCancelCover(shift.id)} className="w-full text-xs bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 rounded shadow-sm transition border border-gray-400">Cancel Request</button>
                                  ) : (
                                    <button onClick={() => claimCoverage(shift.id)} className="w-full text-xs bg-orange-600 hover:bg-orange-700 text-white font-bold py-1.5 rounded shadow-md transition">Cover Shift</button>
                                  )}
                                </div>
                              ) : (
                                <div className="mt-1 flex flex-col gap-1">
                                  <div className={`font-bold text-center truncate px-1 py-1 rounded shadow-sm border ${isMyShift ? 'bg-green-100 text-green-900 border-green-500' : shiftColor.badge}`}>
                                    {isMyShift ? 'Your Shift' : (shift.assignedTo?.name || 'Assigned')}
                                  </div>
                                  {isMyShift && (
                                    <button onClick={() => handleRequestCover(shift.id)} className="w-full text-xs bg-orange-100 hover:bg-orange-200 text-orange-800 border border-orange-300 font-bold py-1 rounded shadow-sm transition">
                                      Need Coverage
                                    </button>
                                  )}
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/components/DashboardTab.tsx">
"use client";
import React, { useMemo } from 'react';
import { AppState, TimeCard, Shift } from '../lib/types';

export default function DashboardTab({ appState }: { appState: AppState }) {
  const {
    isManager, handleImportTimecards, missingPunches,
    formatDateSafe, formatTimeSafe, dashHiddenWarnings, dashPeriodIndex,
    setDashPeriodIndex, periods, locations, dashLocs, toggleDashLoc, users,
    dashEmployees, toggleDashEmp, selectedUserId, dashData
  } = appState;

  // NEW: Smart filtering logic inside the component
  const dashVisibleData = useMemo(() => {
    if (!dashData?.timeCards) return[];
    
    const userMap = new Map();
    
    dashData.timeCards.forEach((card: TimeCard) => {
      // 1. If NO locations are checked, show ALL locations. 
      //    If SOME are checked, only show those.
      if (dashLocs.length > 0 && !dashLocs.includes(card.locationId)) return;
      
      // 2. Build the employee groups
      if (!userMap.has(card.userId)) {
        userMap.set(card.userId, { 
          userId: card.userId, 
          name: card.user?.name || 'Unknown', 
          totalHours: 0, 
          cards:[] 
        });
      }
      
      const uData = userMap.get(card.userId);
      uData.totalHours = Math.round((uData.totalHours + (card.totalHours || 0)) * 100) / 100;
      uData.cards.push(card);
    });

    const finalArray = Array.from(userMap.values());
    finalArray.sort((a, b) => a.name.localeCompare(b.name));
    return finalArray;
  }, [dashData, dashLocs]);

  return (
    <div className="bg-white p-4 md:p-6 rounded-xl border border-gray-300 shadow-md">
      <div className="flex flex-col md:flex-row justify-between items-center mb-6 border-b border-gray-200 pb-4 gap-4">
        <h2 className="text-lg md:text-xl font-bold text-slate-900 text-center md:text-left">Payroll Dashboard</h2>
        
        <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full md:w-auto">
          {isManager && (
            <button 
              onClick={handleImportTimecards} 
              className="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2.5 px-5 rounded-lg shadow-sm transition"
            >
              + Import Jan/Feb Timecards
            </button>
          )}
        </div>
      </div>

      {missingPunches.length > 0 && (
        <div className="mb-8 bg-red-50 border-l-4 border-red-600 p-4 md:p-6 rounded-r-xl shadow-sm">
          <div className="flex items-start gap-3">
            <div className="flex-shrink-0 pt-0.5">
              <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2.5}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
            </div>
            <div className="w-full">
              <h3 className="text-sm md:text-base font-black text-red-900 mb-1">MISSING TIMECARDS DETECTED</h3>
              <p className="text-xs md:text-sm text-red-800 font-bold mb-3">
                {isManager ? "The following shifts were claimed for this Pay Period, but the employee never clocked their hours:" : "You claimed the following shifts this Pay Period, but haven't clocked your hours:"}
              </p>
              <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-2">
                {missingPunches.map((warn: Shift, i: number) => (
                  <div key={i} className="bg-white border border-red-200 p-2.5 rounded-lg shadow-sm text-xs font-bold text-slate-800 flex justify-between items-center">
                    <span className="truncate pr-2">{formatDateSafe(warn.startTime)} | {warn.assignedTo?.name}</span>
                    <span className="text-red-600 bg-red-50 px-2 py-1 rounded shadow-inner border border-red-100 whitespace-nowrap">
                      {formatTimeSafe(warn.startTime)} - {formatTimeSafe(warn.endTime)}
                    </span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      )}
      
      {isManager && dashHiddenWarnings.length > 0 && (
        <div className="mb-8 bg-yellow-50 border-l-4 border-yellow-500 p-4 md:p-6 rounded-r-xl shadow-sm">
          <div className="flex items-start gap-3">
            <div className="flex-shrink-0 pt-0.5">
              <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2.5}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
            </div>
            <div className="w-full">
              <h3 className="text-sm md:text-base font-black text-yellow-800 mb-1">Warning: Hidden Floating Hours!</h3>
              <p className="text-xs md:text-sm text-yellow-700 font-bold mb-3">
                The following employees worked at locations you currently have unchecked. Their Dashboard Totals below do <span className="underline font-black">NOT</span> include these hours:
              </p>
              <ul className="list-disc pl-5 text-sm font-black text-yellow-900 space-y-1">
                {dashHiddenWarnings.map((warn: string, i: number) => <li key={i}>{warn}</li>)}
              </ul>
            </div>
          </div>
        </div>
      )}

      <div className={`grid grid-cols-1 gap-4 md:gap-6 mb-8 bg-slate-50 p-4 rounded-xl border border-gray-200 shadow-inner ${isManager ? 'sm:grid-cols-3' : 'sm:grid-cols-2'}`}>
        <div>
          <label className="block text-xs md:text-sm font-black text-slate-800 uppercase tracking-widest mb-2">Select Pay Period</label>
          <select value={dashPeriodIndex} onChange={(e) => setDashPeriodIndex(parseInt(e.target.value))} className="w-full border border-gray-400 rounded-lg p-2.5 md:p-3 font-bold text-slate-900 bg-white shadow-sm outline-none cursor-pointer">
            {periods.map((p, i) => <option key={i} value={i}>{p.label}</option>)}
          </select>
        </div>
        
        <div>
          <label className="block text-xs md:text-sm font-black text-slate-800 uppercase tracking-widest mb-2">
            Filter by Location
            <span className="ml-2 text-[10px] font-bold text-slate-500 normal-case tracking-normal">(Leave blank for ALL)</span>
          </label>
          <div className="border border-gray-400 rounded-lg p-2 md:p-3 h-32 md:h-40 overflow-y-auto bg-white flex flex-col gap-2 shadow-sm">
            {locations.map(loc => (
              <label key={loc.id} className="flex items-center space-x-2 cursor-pointer hover:bg-slate-50 p-1 rounded">
                <input type="checkbox" checked={dashLocs.includes(loc.id)} onChange={() => toggleDashLoc(loc.id)} className="w-5 h-5 md:w-4 md:h-4 text-green-700 rounded border-gray-400 cursor-pointer" />
                <span className="text-xs md:text-sm font-bold text-slate-900">{loc.name}</span>
              </label>
            ))}
          </div>
        </div>

        {isManager && (
          <div>
            <label className="block text-xs md:text-sm font-black text-slate-800 uppercase tracking-widest mb-2">Filter by Employee</label>
            <div className="border border-gray-400 rounded-lg p-2 md:p-3 h-32 md:h-40 overflow-y-auto bg-white flex flex-col gap-2 shadow-sm">
              {users.map(u => (
                <label key={u.id} className="flex items-center space-x-2 cursor-pointer hover:bg-slate-50 p-1 rounded">
                  <input type="checkbox" checked={dashEmployees.includes(u.id)} onChange={() => toggleDashEmp(u.id)} className="w-5 h-5 md:w-4 md:h-4 text-green-700 rounded border-gray-400 cursor-pointer" />
                  <span className="text-xs md:text-sm font-bold text-slate-900">{u.name}</span>
                </label>
              ))}
            </div>
          </div>
        )}
      </div>

      <div>
        {!selectedUserId && !isManager ? (
          <div className="p-8 text-center text-slate-500 font-bold italic bg-slate-50 border border-slate-300 rounded-xl shadow-inner text-sm md:text-base">
            Please select your Active Employee profile at the top to view your Dashboard.
          </div>
        ) : (dashVisibleData.length === 0) ? (
          <div className="p-8 text-center text-slate-500 font-bold italic bg-slate-50 border border-slate-300 rounded-xl shadow-inner text-sm md:text-base">
            No hours logged for this pay period matching your filters.
          </div>
        ) : (
          dashVisibleData.map((row) => {
            const userCards: TimeCard[] = row.cards ||[];
            return (
              <div key={row.userId} className="mb-8 border border-gray-300 rounded-2xl overflow-hidden bg-white shadow-md">
                <div className="bg-slate-100 p-4 flex flex-col sm:flex-row justify-between items-center border-b border-gray-300 gap-3">
                  <h3 className="font-black text-slate-900 text-lg md:text-xl uppercase tracking-widest">{row.name}</h3>
                  <div className="bg-slate-900 border border-slate-700 text-white font-bold px-4 py-2 rounded-xl shadow-sm tracking-widest w-full sm:w-auto text-center">
                    Total: <span className="text-yellow-400 ml-1">{row.totalHours} hrs</span>
                  </div>
                </div>
                
                <div className="overflow-x-auto">
                  <table className="w-full text-left text-sm" style={{ minWidth: '600px' }}>
                    <thead className="bg-white border-b border-gray-200 text-slate-600">
                      <tr>
                        <th className="p-3 font-black uppercase tracking-widest text-slate-900 text-xs">Day</th>
                        <th className="p-3 font-black uppercase tracking-widest text-slate-900 text-xs">Location</th>
                        <th className="p-3 font-black uppercase tracking-widest text-slate-900 text-xs">Start</th>
                        <th className="p-3 font-black uppercase tracking-widest text-slate-900 text-xs">End</th>
                        <th className="p-3 font-black uppercase tracking-widest text-slate-900 text-xs">Hours</th>
                      </tr>
                    </thead>
                    <tbody>
                      {userCards.map((card: TimeCard) => {
                        const outD = card.clockOut ? new Date(card.clockOut) : null;
                        const isActive = !outD || isNaN(outD.getTime()) || outD.getFullYear() === 1970;

                        return (
                          <tr key={card.id} className="border-b border-gray-100 hover:bg-slate-50 transition whitespace-nowrap">
                            <td className="p-3 font-bold text-slate-900">{formatDateSafe(card.clockIn)}</td>
                            <td className="p-3 font-bold text-gray-700">{card.location?.name || 'Unknown'}</td>
                            <td className="p-3 text-green-700 font-bold">{formatTimeSafe(card.clockIn)}</td>
                            <td className={`p-3 font-bold ${isActive ? 'text-red-600 italic' : 'text-red-700'}`}>
                              {isActive ? 'Active' : formatTimeSafe(card.clockOut!)}
                            </td>
                            <td className="p-3 font-black text-slate-900 bg-slate-50 border-l border-gray-200">
                              {isActive ? (
                                <span className="text-[10px] text-red-600 bg-red-100 px-2 py-1 rounded shadow-inner uppercase tracking-widest animate-pulse border border-red-200">
                                  Working
                                </span>
                              ) : (
                                `${card.totalHours?.toFixed(2) || 0}h`
                              )}
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
            );
          })
        )}
      </div>
    </div>
  );
}
</file>

<file path="app/components/FeedbackTab.tsx">
"use client";
import React, { useState } from 'react';
import { AppState, Feedback, User } from '../lib/types';

export default function FeedbackTab({ appState }: { appState: AppState }) {
  const { feedbacks, fetchFeedbacks, users, handleSubmitFeedback, selectedUserId } = appState;

  // State for handling inline editing (Manager Side)
  const[editingId, setEditingId] = useState<number | null>(null);
  const [editStatus, setEditStatus] = useState<Feedback['status']>('OPEN');
  const [editNotes, setEditNotes] = useState<string>('');
  const [isSaving, setIsSaving] = useState<boolean>(false);

  // State for handling NEW feedback creation (Staff Side)
  const [isCreateOpen, setIsCreateOpen] = useState(false);
  const [newType, setNewType] = useState<'BUG' | 'SUGGESTION'>('BUG');
  const [newDesc, setNewDesc] = useState('');
  const[isSubmitting, setIsSubmitting] = useState(false);

  // --- SUBMIT NEW FEEDBACK ---
  const handleCreateSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!selectedUserId) {
      return alert("Please select your active Employee Name at the top of the screen first.");
    }
    if (newDesc.length < 5) {
      return alert("Description must be at least 5 characters long.");
    }

    setIsSubmitting(true);
    const res = await handleSubmitFeedback({
      userId: selectedUserId,
      type: newType,
      description: newDesc
    });
    setIsSubmitting(false);

    if (res.success) {
      setIsCreateOpen(false);
      setNewDesc('');
      setNewType('BUG');
    } else {
      alert("Failed to submit ticket. Please try again.");
    }
  };

  // --- MANAGE EXISTING FEEDBACK ---
  const startEditing = (fb: Feedback) => {
    setEditingId(fb.id);
    setEditStatus(fb.status || 'OPEN');
    setEditNotes(fb.devNotes || '');
  };

  const cancelEditing = () => {
    setEditingId(null);
    setEditStatus('OPEN');
    setEditNotes('');
  };

  const handleSave = async (id: number) => {
    setIsSaving(true);
    try {
      const response = await fetch(`/api/feedback/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          status: editStatus,
          devNotes: editNotes 
        })
      });

      if (!response.ok) throw new Error("Failed to save");

      await fetchFeedbacks(); 
      setEditingId(null);
      setEditNotes('');
    } catch (error) {
      console.error("Save Error:", error);
      alert("Failed to save changes.");
    } finally {
      setIsSaving(false);
    }
  };

  const statusGroups: Feedback['status'][] =['OPEN', 'IN PROGRESS', 'COMPLETED'];

  return (
    <div className="space-y-10 animate-in fade-in duration-500 relative">
      
      {/* --- HEADER AREA --- */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
        <div className="flex items-center gap-3">
          <div className="bg-purple-700 p-2.5 rounded-2xl shadow-lg shadow-purple-200">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2.5} stroke="currentColor" className="w-7 h-7 text-white">
              <path strokeLinecap="round" strokeLinejoin="round" d="M17.25 6.75 22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3-4.5 16.5" />
            </svg>
          </div>
          <div>
            <h2 className="text-3xl md:text-4xl font-black text-slate-900 tracking-tight">Developer Backlog</h2>
            <p className="text-slate-700 font-bold text-xs md:text-sm uppercase tracking-widest">System Improvements & Bug Tracking</p>
          </div>
        </div>
        
        {/* CREATE FEEDBACK BUTTON */}
        <button
          onClick={() => setIsCreateOpen(true)}
          className="flex items-center justify-center gap-2 bg-purple-700 hover:bg-purple-800 text-white px-6 py-3.5 rounded-xl font-black transition-all shadow-lg"
        >
          <span></span> Submit Feedback
        </button>
      </div>

      {/* --- KANBAN COLUMNS --- */}
      {statusGroups.map(statusGroup => {
        const filteredFeedbacks = feedbacks.filter(f => f.status === statusGroup);
        
        return (
          <div key={statusGroup} className="bg-white border-2 border-slate-200 rounded-[2.5rem] p-6 md:p-8 shadow-sm">
            
            {/* Group Header */}
            <div className="flex justify-between items-center mb-8 pb-4 border-b border-slate-200">
              <h3 className="text-xl font-black text-slate-900 tracking-tighter flex items-center gap-3">
                <span className={`w-3 h-3 rounded-full ${
                  statusGroup === 'OPEN' ? 'bg-amber-500' : 
                  statusGroup === 'IN PROGRESS' ? 'bg-blue-600' : 'bg-green-600'
                }`} />
                {statusGroup}
              </h3>
              <span className="bg-slate-200 px-4 py-1.5 rounded-full text-sm font-black text-slate-800 shadow-inner">
                {filteredFeedbacks.length}
              </span>
            </div>

            {/* Grid of Tickets */}
            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
              {filteredFeedbacks.map(fb => {
                const isEditing = editingId === fb.id;
                const user = users.find((u: User) => u.id === fb.userId);
                const createdDate = new Date(fb.createdAt).toLocaleDateString('en-US', { 
                  weekday: 'short', month: 'short', day: 'numeric' 
                });

                return (
                  <div key={fb.id} className="flex flex-col bg-slate-50 border-2 border-slate-200 rounded-3xl p-6 transition-all hover:bg-white hover:shadow-lg">
                    
                    <div className="flex justify-between items-start mb-5">
                      <span className={`text-[10px] font-black px-2.5 py-1 rounded-lg border uppercase tracking-widest ${
                        fb.type === 'BUG' ? 'bg-red-100 text-red-800 border-red-300' : 'bg-blue-100 text-blue-800 border-blue-300'
                      }`}>
                        {fb.type}
                      </span>
                      <span className="text-[11px] font-bold text-slate-700 bg-white px-2.5 py-1 rounded border border-slate-300 shadow-sm">
                        {createdDate}
                      </span>
                    </div>

                    <div className="flex-grow">
                      <p className="text-slate-900 font-bold text-lg leading-snug mb-4">
                        "{fb.description}"
                      </p>
                      <div className="flex items-center gap-2 mb-6">
                        <div className="w-5 h-5 rounded-full bg-slate-300 flex items-center justify-center text-[10px] text-slate-800 font-black uppercase border border-slate-400">
                          {user?.name?.charAt(0) || '?'}
                        </div>
                        <p className="text-xs font-black text-slate-700 uppercase tracking-tight">
                          {user?.name || 'Unknown Staff'}
                        </p>
                      </div>
                    </div>

                    {/* Developer Response Section */}
                    {!isEditing && (statusGroup === 'IN PROGRESS' || statusGroup === 'COMPLETED') && (
                      <div className="mb-6 bg-white p-4 rounded-2xl border-2 border-slate-300 shadow-inner overflow-hidden">
                        <p className="text-[10px] font-black text-slate-700 uppercase tracking-widest mb-2 flex items-center gap-1.5">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-4 h-4 flex-shrink-0 text-slate-600">
                            <path fillRule="evenodd" d="M4.804 21.644A6.707 6.707 0 006 21.75a6.721 6.721 0 003.583-1.029c.774.182 1.584.279 2.417.279 5.322 0 9.75-3.97 9.75-9 0-5.03-4.428-9-9.75-9s-9.75 3.97-9.75 9c0 2.409 1.025 4.587 2.674 6.192.232.226.277.428.254.543a3.73 3.73 0 01-.814 1.686.75.75 0 00.44 1.223z" clipRule="evenodd" />
                          </svg>
                          Developer Note
                        </p>
                        <p className="text-sm font-bold text-slate-900 leading-relaxed">
                          {fb.devNotes ? fb.devNotes : <span className="text-slate-600 italic font-medium">No notes provided yet.</span>}
                        </p>
                      </div>
                    )}

                    {/* Edit Controls (Manager/Admin Only conceptually) */}
                    <div className="pt-5 border-t-2 border-slate-200">
                      {isEditing ? (
                        <div className="space-y-4">
                          <div>
                            <label className="block text-[10px] font-black text-slate-700 uppercase tracking-widest mb-1.5">Update Status</label>
                            <select 
                              value={editStatus} 
                              onChange={(e) => setEditStatus(e.target.value as Feedback['status'])}
                              className="w-full border-2 border-slate-300 rounded-xl p-2.5 text-sm font-black text-slate-900 focus:border-slate-900 outline-none bg-white shadow-sm cursor-pointer"
                            >
                              <option value="OPEN">Open</option>
                              <option value="IN PROGRESS">In Progress</option>
                              <option value="COMPLETED">Completed</option>
                            </select>
                          </div>

                          <div>
                            <label className="block text-[10px] font-black text-slate-700 uppercase tracking-widest mb-1.5">Developer Notes</label>
                            <textarea 
                              value={editNotes}
                              onChange={(e) => setEditNotes(e.target.value)}
                              placeholder="Describe the fix or timeline..."
                              className="w-full border-2 border-slate-300 rounded-xl p-3 text-sm font-bold text-slate-900 focus:border-slate-900 outline-none bg-white shadow-sm"
                              rows={4}
                            />
                          </div>

                          <div className="flex gap-2">
                            <button 
                              onClick={() => handleSave(fb.id)}
                              disabled={isSaving}
                              className="flex-[2] bg-slate-900 text-white font-black py-3 rounded-xl text-sm hover:bg-black transition disabled:opacity-50 shadow-md"
                            >
                              {isSaving ? 'Saving...' : 'Save Changes'}
                            </button>
                            <button 
                              onClick={cancelEditing}
                              className="flex-1 bg-white border-2 border-slate-300 text-slate-700 font-black py-3 rounded-xl text-sm hover:bg-slate-100 transition shadow-sm"
                            >
                              Cancel
                            </button>
                          </div>
                        </div>
                      ) : (
                        <button 
                          onClick={() => startEditing(fb)}
                          className="w-full py-3 bg-white border-2 border-slate-300 rounded-xl text-[11px] font-black text-slate-800 hover:border-slate-900 hover:text-slate-900 transition-all uppercase tracking-widest shadow-sm"
                        >
                          Manage Ticket
                        </button>
                      )}
                    </div>

                  </div>
                );
              })}

              {filteredFeedbacks.length === 0 && (
                <div className="col-span-full py-16 text-center border-4 border-dashed border-slate-200 rounded-[2.5rem]">
                  <p className="text-slate-500 font-black uppercase tracking-[0.2em] text-sm">No Tickets Found</p>
                </div>
              )}
            </div>
          </div>
        );
      })}

      {/* --- CREATE FEEDBACK MODAL --- */}
      {isCreateOpen && (
        <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
          <div className="bg-white rounded-[32px] w-full max-w-lg shadow-2xl overflow-hidden animate-in zoom-in duration-200 border border-slate-300">
            
            <div className="p-6 md:p-8 border-b-2 border-slate-100 flex justify-between items-center bg-slate-50">
              <h4 className="font-black text-slate-900 text-2xl">Submit Feedback</h4>
              <button onClick={() => setIsCreateOpen(false)} className="text-slate-600 hover:text-red-600 text-2xl font-black transition-colors">
                
              </button>
            </div>

            <form onSubmit={handleCreateSubmit} className="p-6 md:p-8 space-y-6">
              
              <div className="flex p-1.5 bg-slate-200 rounded-xl shadow-inner">
                <button
                  type="button"
                  onClick={() => setNewType('BUG')}
                  className={`flex-1 flex items-center justify-center gap-2 py-2.5 text-sm font-black rounded-lg transition-all ${newType === 'BUG' ? 'bg-white shadow-md text-red-800' : 'text-slate-700 hover:text-slate-900'}`}
                >
                  <span className="text-lg leading-none"></span> Report a Bug
                </button>
                <button
                  type="button"
                  onClick={() => setNewType('SUGGESTION')}
                  className={`flex-1 flex items-center justify-center gap-2 py-2.5 text-sm font-black rounded-lg transition-all ${newType === 'SUGGESTION' ? 'bg-white shadow-md text-blue-800' : 'text-slate-700 hover:text-slate-900'}`}
                >
                  <span className="text-lg leading-none"></span> Suggestion
                </button>
              </div>

              <div>
                <label className="block text-xs font-black text-slate-900 uppercase mb-2 ml-1">Description</label>
                <textarea
                  required
                  autoFocus
                  minLength={5}
                  value={newDesc}
                  onChange={(e) => setNewDesc(e.target.value)}
                  placeholder={newType === 'BUG' ? "Describe the issue you encountered in detail..." : "Describe your idea for improving the app..."}
                  className="w-full border-2 border-slate-300 rounded-xl p-4 text-sm font-bold text-slate-900 focus:border-purple-600 focus:ring-0 outline-none shadow-sm min-h-[140px] resize-none"
                />
              </div>

              <button
                type="submit"
                disabled={isSubmitting || newDesc.length < 5}
                className="w-full bg-purple-700 text-white py-4 rounded-xl font-black text-lg shadow-xl shadow-purple-900/20 hover:bg-purple-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-3 mt-4"
              >
                {isSubmitting ? 'Submitting...' : 'Submit Ticket'} <span className="text-xl leading-none"></span>
              </button>

            </form>
          </div>
        </div>
      )}

    </div>
  );
}
</file>

<file path="app/components/PrivilegesTab.tsx">
"use client";
import React, { useState } from 'react';
import { AppState, Member, PassUsage } from '../lib/types';

export default function PrivilegesTab({ appState }: { appState: AppState }) {
  const {
    passSearch, setPassSearch, filteredMembers,
    handleRedeemBeverage, expandedMember, setExpandedMember,
    pDate, setPDate, pAmt, setPAmt, pInitials, setPInitials, handleLogPass,
    isManager, setMembers, editingRenewalId, setEditingRenewalId,
    newRenewalDate, setNewRenewalDate,
    editingTotalId, setEditingTotalId, newTotalVal, setNewTotalVal,
    newBonusNotes, setNewBonusNotes
  } = appState;

  const [showAddMember, setShowAddMember] = useState(false);
  const [newMemLast, setNewMemLast] = useState('');
  const [newMemFirst, setNewMemFirst] = useState('');
  const [newMemLoc, setNewMemLoc] = useState('');
  const [newMemDate, setNewMemDate] = useState('');
  const [newMemTotal, setNewMemTotal] = useState<number | string>(12);

  const refreshMembers = async () => {
    const res = await fetch('/api/members?t=' + new Date().getTime());
    const data = await res.json();
    setMembers(data);
  };

  const handleAddMember = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!newMemLast) return alert("Last name is required!");
    await fetch('/api/members', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ lastName: newMemLast, firstName: newMemFirst, location: newMemLoc, renewalDate: newMemDate, totalPasses: newMemTotal })
    });
    alert("New member added successfully!");
    setNewMemLast(''); setNewMemFirst(''); setNewMemLoc(''); setNewMemDate(''); setNewMemTotal(12);
    setShowAddMember(false);
    refreshMembers();
  };

  const handleUpdateRenewal = async (memberId: number) => {
    await fetch('/api/members', { 
      method: 'PUT', 
      headers: { 'Content-Type': 'application/json' }, 
      body: JSON.stringify({ action: 'UPDATE_RENEWAL', memberId, renewalDate: newRenewalDate }) 
    });
    setEditingRenewalId(null);
    refreshMembers();
  };

  const handleUpdateTotal = async (memberId: number) => {
    await fetch('/api/members', { 
      method: 'PUT', 
      headers: { 'Content-Type': 'application/json' }, 
      body: JSON.stringify({ action: 'UPDATE_TOTAL_PASSES', memberId, totalPasses: newTotalVal, bonusNotes: newBonusNotes }) 
    });
    setEditingTotalId(null);
    refreshMembers();
  };

  return (
    <div className="bg-white p-4 md:p-6 rounded-xl border border-gray-300 shadow-md">
      <div className="flex flex-col md:flex-row justify-between items-center mb-6 border-b border-gray-200 pb-4 gap-4">
        <h2 className="text-lg md:text-xl font-bold text-slate-900 text-center md:text-left">Platinum Privileges & Passes</h2>
        <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full md:w-auto">
          <input type="text" placeholder="Search Name/Loc..." value={passSearch} onChange={(e) => setPassSearch(e.target.value)} className="w-full sm:w-auto border border-gray-400 rounded p-2 text-slate-900 font-bold outline-none shadow-inner" />
          {isManager && (
            <button onClick={() => setShowAddMember(!showAddMember)} className="w-full sm:w-auto bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition">
              {showAddMember ? 'Cancel' : '+ Add Member'}
            </button>
          )}
          {/* Import CSV Button Removed */}
        </div>
      </div>

      {showAddMember && (
        <div className="mb-6 bg-slate-50 border border-gray-300 p-4 rounded-xl shadow-inner">
          <h3 className="font-black text-slate-900 mb-3">Add New Platinum Member</h3>
          <form onSubmit={handleAddMember} className="grid grid-cols-1 sm:grid-cols-6 gap-3">
            <input type="text" placeholder="Last Name" required value={newMemLast} onChange={(e) => setNewMemLast(e.target.value)} className="sm:col-span-2 border border-gray-400 p-2 rounded text-slate-900 font-bold outline-none" />
            <input type="text" placeholder="First Name" value={newMemFirst} onChange={(e) => setNewMemFirst(e.target.value)} className="sm:col-span-1 border border-gray-400 p-2 rounded text-slate-900 font-bold outline-none" />
            <input type="text" placeholder="Location (e.g. WF)" value={newMemLoc} onChange={(e) => setNewMemLoc(e.target.value)} className="sm:col-span-1 border border-gray-400 p-2 rounded text-slate-900 font-bold outline-none" />
            <input type="text" placeholder="Renewal (e.g. 10-01-26)" value={newMemDate} onChange={(e) => setNewMemDate(e.target.value)} className="sm:col-span-1 border border-gray-400 p-2 rounded text-slate-900 font-bold outline-none" />
            <button type="submit" className="sm:col-span-1 bg-green-700 hover:bg-green-800 text-white font-bold rounded shadow-sm">Save Member</button>
          </form>
        </div>
      )}

      <div className="overflow-x-auto border border-gray-300 rounded-lg shadow-sm pb-2">
        <table className="w-full text-left text-sm" style={{ minWidth: '800px' }}>
          <thead className="bg-slate-100 border-b border-gray-300 text-slate-800">
            <tr>
              <th className="p-3 font-black text-slate-900">Last Name</th>
              <th className="p-3 font-black text-slate-900">First Name</th>
              <th className="p-3 font-black text-slate-900">Location</th>
              <th className="p-3 font-black text-slate-900">Renewal Date</th>
              <th className="p-3 font-black text-slate-900 border-l border-gray-300">Total Passes</th>
              <th className="p-3 font-black text-slate-900 bg-slate-200 text-center border-l border-gray-300">Remain</th>
              <th className="p-3 font-black text-slate-900 text-center border-l border-gray-300">Bev/Snack</th>
              <th className="p-3 font-black text-slate-900 text-center border-l border-gray-300">Action</th>
            </tr>
          </thead>
          <tbody>
            {filteredMembers.length === 0 ? (
              <tr><td colSpan={8} className="p-6 text-center text-slate-500 font-bold italic bg-white">No members found.</td></tr>
            ) : (
              filteredMembers.map((m: Member) => {
                let usedCount = 0;
                m.usages.forEach((u: PassUsage) => usedCount += u.amount);
                const remaining = m.totalPasses - usedCount;

                let bevAvailable = true;
                let bevDateStr = '';
                if (m.lastBeverageDate) {
                  const bDate = new Date(m.lastBeverageDate);
                  const today = new Date();
                  if (bDate.getMonth() === today.getMonth() && bDate.getFullYear() === today.getFullYear()) {
                    bevAvailable = false;
                    bevDateStr = bDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                  }
                }

                return (
                  <React.Fragment key={m.id}>
                    <tr className="border-b border-gray-200 hover:bg-slate-50 transition whitespace-nowrap">
                      <td className="p-3 font-black text-slate-900">{m.lastName}</td>
                      <td className="p-3 font-bold text-slate-800">{m.firstName}</td>
                      <td className="p-3 font-bold text-gray-700">{m.location}</td>
                      
                      {/* EDITABLE RENEWAL DATE */}
                      <td className="p-3 font-bold text-gray-700">
                        {editingRenewalId === m.id ? (
                          <div className="flex space-x-1">
                            <input type="text" value={newRenewalDate} onChange={(e) => setNewRenewalDate(e.target.value)} className="border border-gray-400 rounded px-2 py-0.5 text-xs w-24 outline-none font-bold text-slate-900" />
                            <button onClick={() => handleUpdateRenewal(m.id)} className="bg-green-600 hover:bg-green-700 text-white font-bold px-2 py-0.5 rounded text-xs shadow-sm">Save</button>
                            <button onClick={() => setEditingRenewalId(null)} className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold px-2 py-0.5 rounded text-xs shadow-sm">X</button>
                          </div>
                        ) : (
                          <div className="flex items-center space-x-2">
                            <span>{m.renewalDate || 'N/A'}</span>
                            {isManager && (
                              <button onClick={() => { setEditingRenewalId(m.id); setNewRenewalDate(m.renewalDate || ''); }} className="bg-slate-200 hover:bg-slate-300 rounded p-1.5 transition shadow-sm" title="Edit Date">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className="w-3 h-3 text-slate-700"><path d="M2.695 14.763l-1.262 3.152a.5.5 0 00.65.65l3.152-1.262a4 4 0 001.343-.885L17.5 5.5a2.121 2.121 0 00-3-3L3.58 13.42a4 4 0 00-.885 1.343z" /></svg>
                              </button>
                            )}
                          </div>
                        )}
                      </td>

                      {/* EDITABLE TOTAL PASSES */}
                      <td className="p-3 border-l border-gray-200">
                        {editingTotalId === m.id ? (
                          <div className="flex flex-col gap-1 w-48">
                            <div className="flex space-x-1">
                              <input type="number" value={newTotalVal} onChange={(e) => setNewTotalVal(e.target.value)} className="border border-gray-400 rounded px-2 py-0.5 text-xs w-16 outline-none font-black text-slate-900" />
                              <button onClick={() => handleUpdateTotal(m.id)} className="bg-green-600 hover:bg-green-700 text-white font-bold px-2 py-0.5 rounded text-xs shadow-sm">Save</button>
                              <button onClick={() => setEditingTotalId(null)} className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold px-2 py-0.5 rounded text-xs shadow-sm">X</button>
                            </div>
                            <input type="text" placeholder="Manager Notes (Optional)" value={newBonusNotes} onChange={(e) => setNewBonusNotes(e.target.value)} className="border border-gray-400 rounded px-2 py-1 text-[10px] outline-none font-bold text-slate-700 w-full" />
                          </div>
                        ) : (
                          <div className="flex flex-col items-start">
                            <div className="flex items-center space-x-2">
                              <span className="font-black text-slate-800 text-base">{m.totalPasses}</span>
                              {isManager && (
                                <button onClick={() => { setEditingTotalId(m.id); setNewTotalVal(m.totalPasses); setNewBonusNotes(m.bonusNotes || ''); }} className="bg-slate-200 hover:bg-slate-300 rounded p-1.5 transition shadow-sm" title="Edit Total Passes">
                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className="w-3 h-3 text-slate-700"><path d="M2.695 14.763l-1.262 3.152a.5.5 0 00.65.65l3.152-1.262a4 4 0 001.343-.885L17.5 5.5a2.121 2.121 0 00-3-3L3.58 13.42a4 4 0 00-.885 1.343z" /></svg>
                                </button>
                              )}
                            </div>
                            {m.bonusNotes && <span className="text-[10px] text-blue-700 font-bold italic mt-0.5 whitespace-normal break-words w-32 leading-tight">Note: {m.bonusNotes}</span>}
                          </div>
                        )}
                      </td>

                      <td className={`p-3 font-black text-center border-l border-gray-200 ${remaining <= 0 ? 'bg-red-100 text-red-800' : 'bg-green-50 text-green-800'}`}>
                        {remaining}
                      </td>
                      
                      <td className="p-3 text-center border-l border-gray-200">
                        {bevAvailable ? (
                          <button onClick={() => handleRedeemBeverage(m.id)} className="bg-yellow-400 text-slate-900 border border-yellow-500 text-xs font-black px-3 py-1.5 rounded shadow-sm hover:bg-yellow-500 transition">
                            Redeem
                          </button>
                        ) : (
                          <span className="text-xs text-gray-500 font-bold bg-gray-100 px-2 py-1.5 rounded border border-gray-300 shadow-inner">
                            Used {bevDateStr}
                          </span>
                        )}
                      </td>

                      <td className="p-3 text-center border-l border-gray-200">
                        <button onClick={() => setExpandedMember(expandedMember === m.id ? null : m.id)} className="bg-slate-200 text-slate-800 font-bold px-3 py-1.5 rounded shadow-sm hover:bg-slate-300 w-full transition">
                          {expandedMember === m.id ? 'Close' : 'Manage'}
                        </button>
                      </td>
                    </tr>
                    
                    {expandedMember === m.id && (
                      <tr className="bg-slate-100 border-b border-gray-400 shadow-inner">
                        <td colSpan={8} className="p-4">
                          <div className="flex flex-col lg:flex-row gap-6">
                            
                            <div className="bg-white p-4 rounded-lg border border-gray-300 shadow-sm flex-1">
                              <h4 className="font-black text-slate-900 mb-3 border-b pb-2">Log Pass Usage</h4>
                              <form onSubmit={(e) => handleLogPass(e, m.id)} className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-4">
                                <input type="text" required placeholder="Date (e.g. 10-25)" value={pDate} onChange={(e) => setPDate(e.target.value)} className="border border-gray-400 p-2 rounded text-slate-900 font-bold w-full sm:w-1/3 outline-none" />
                                <input type="number" required min="1" placeholder="Amt" value={pAmt} onChange={(e) => setPAmt(e.target.value)} className="border border-gray-400 p-2 rounded text-slate-900 font-bold w-full sm:w-1/4 outline-none" />
                                <input type="text" required placeholder="Initials" value={pInitials} onChange={(e) => setPInitials(e.target.value)} className="border border-gray-400 p-2 rounded text-slate-900 font-bold w-full sm:w-1/3 outline-none" />
                                <button type="submit" className="bg-green-800 hover:bg-green-900 text-white font-bold py-2 px-4 rounded shadow-sm w-full sm:w-auto transition">Save</button>
                              </form>
                              <p className="text-xs text-slate-500 mt-4 font-bold bg-slate-50 p-2 border border-slate-200 rounded">{m.notes || 'No special notes.'}</p>
                            </div>

                            <div className="bg-white p-4 rounded-lg border border-gray-300 shadow-sm flex-1">
                              <h4 className="font-black text-slate-900 mb-3 border-b pb-2">Usage History</h4>
                              {m.usages.length === 0 ? <p className="text-sm text-slate-500 italic mt-4">No usage logged yet.</p> : (
                                <div className="space-y-2 mt-4 max-h-40 overflow-y-auto pr-2">
                                  {m.usages.map((u: PassUsage) => (
                                    <div key={u.id} className="flex justify-between border-b border-gray-100 pb-1 text-sm font-bold text-slate-700">
                                      <span>{u.dateUsed}</span>
                                      <span className="text-red-700">Used {u.amount}</span>
                                      <span className="text-slate-500">By: {u.initials}</span>
                                    </div>
                                  ))}
                                </div>
                              )}
                            </div>

                          </div>
                        </td>
                      </tr>
                    )}
                  </React.Fragment>
                );
              })
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="app/components/StaffTab.tsx">
"use client";
import React from 'react';
import { AppState, User } from '../lib/types';

export default function StaffTab({ appState }: { appState: AppState }) {
  const { 
    users, 
    locations, 
    handleUpdateUser, 
    handleRoleToggle, 
    AVAILABLE_ROLES, 
    isAdmin 
  } = appState;

  // Function to handle toggling a location array for a user
  const toggleLocation = async (user: User, locationId: number) => {
    const currentLocs = user.locationIds ? [...user.locationIds] :[];
    let newLocs: number[];

    if (currentLocs.includes(locationId)) {
      // Remove the location
      newLocs = currentLocs.filter(id => id !== locationId);
    } else {
      // Add the location
      newLocs = [...currentLocs, locationId];
    }

    await handleUpdateUser(user.id, { locationIds: newLocs });
  };

  if (!isAdmin) {
    return (
      <div className="p-8 text-center bg-white rounded-2xl border border-gray-200">
        <h2 className="text-xl font-black text-slate-900 uppercase tracking-widest">Access Denied</h2>
        <p className="text-slate-600 font-bold mt-2">Only Administrators can manage staff assignments.</p>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
        <div>
          <h2 className="text-3xl font-black text-slate-900 tracking-tight uppercase italic">Staff Management</h2>
          <p className="text-slate-600 font-bold text-sm uppercase tracking-widest">Roles & Location Permissions</p>
        </div>
      </div>

      <div className="grid grid-cols-1 gap-6">
        {[...users].sort((a, b) => a.name.localeCompare(b.name)).map(user => {
          const userLocs = user.locationIds ||[];

          return (
            <div key={user.id} className="bg-white rounded-3xl border-2 border-slate-200 p-6 shadow-sm hover:shadow-md transition-all">
              <div className="flex flex-col lg:flex-row gap-8">
                
                {/* User Info Section */}
                <div className="lg:w-1/4">
                  <div className="flex items-center gap-4 mb-2">
                    <div className="w-12 h-12 bg-slate-900 rounded-2xl flex items-center justify-center text-white font-black text-xl">
                      {user.name.charAt(0)}
                    </div>
                    <div>
                      <h3 className="text-lg font-black text-slate-900 leading-tight">{user.name}</h3>
                      <p className="text-xs font-bold text-slate-500 uppercase tracking-widest">Employee ID: {user.id}</p>
                    </div>
                  </div>
                </div>

                {/* System Roles Section */}
                <div className="lg:w-1/3">
                  <h4 className="text-xs font-black text-slate-600 uppercase tracking-[0.2em] mb-4">System Roles</h4>
                  <div className="flex flex-wrap gap-2">
                    {AVAILABLE_ROLES.map(role => {
                      const hasRole = user.systemRoles?.includes(role);
                      return (
                        <button
                          key={role}
                          onClick={() => handleRoleToggle(user.id, role)}
                          className={`px-3 py-1.5 rounded-xl text-xs font-black transition-all border-2 ${
                            hasRole 
                              ? 'bg-slate-900 border-slate-900 text-white shadow-lg shadow-slate-200' 
                              : 'bg-white border-slate-300 text-slate-600 hover:border-slate-400 hover:text-slate-800'
                          }`}
                        >
                          {role}
                        </button>
                      );
                    })}
                  </div>
                </div>

                {/* Assigned Locations Section */}
                <div className="lg:w-2/5">
                  <h4 className="text-xs font-black text-slate-600 uppercase tracking-[0.2em] mb-4">Workable Locations</h4>
                  <div className="flex flex-wrap gap-2">
                    {locations.map(loc => {
                      const isAssigned = userLocs.includes(loc.id);
                      return (
                        <button
                          key={loc.id}
                          onClick={() => toggleLocation(user, loc.id)}
                          className={`flex items-center gap-2 px-3 py-1.5 rounded-xl text-xs font-black transition-all border-2 ${
                            isAssigned 
                              ? 'bg-blue-50 border-blue-600 text-blue-700 shadow-sm' 
                              : 'bg-white border-slate-300 text-slate-600 hover:border-slate-400 hover:text-slate-800'
                          }`}
                        >
                          <div className={`w-2 h-2 rounded-full ${isAssigned ? 'bg-blue-600' : 'bg-slate-300'}`} />
                          {loc.name}
                          {isAssigned && (
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className="w-3 h-3">
                              <path fillRule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clipRule="evenodd" />
                            </svg>
                          )}
                        </button>
                      );
                    })}
                  </div>
                  {userLocs.length === 0 && (
                    <p className="text-xs font-bold text-red-600 mt-3 uppercase italic">No locations assigned - this user cannot see any shifts on the calendar.</p>
                  )}
                </div>

              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}
</file>

<file path="app/layout.tsx">
import type { Metadata } from "next";
import "./globals.css";

export const metadata: Metadata = {
  title: "ShiftSync",
  description: "Internal Scheduling App",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body style={{ fontFamily: 'ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif' }}>
        {children}
      </body>
    </html>
  );
}
</file>

<file path="app/page.tsx">
"use client";
import React, { useState, useEffect } from 'react';
import { 
  User, Location, TimeCard, Shift, Member, ShiftTemplate, 
  Checklist, GlobalTask, GiftCard, Feedback, AppState 
} from '../lib/types';

import CalendarTab from './components/CalendarTab';
import TimeCardTab from './components/TimeCardTab';
import DashboardTab from './components/DashboardTab';
import ManagerTab from './components/ManagerTab';
import PrivilegesTab from './components/PrivilegesTab';
import ReportsTab from './components/ReportsTab';
import SetupTab from './components/SetupTab';
import StaffTab from './components/StaffTab';
import GiftCardTab from './components/GiftCardTab';
import FeedbackTab from './components/FeedbackTab'; 

export default function SchedulingApp() {
  const [isMounted, setIsMounted] = useState(false);
  const [activeTab, setActiveTab] = useState('setup'); 
  
  const [users, setUsers] = useState<User[]>([]);
  const [locations, setLocations] = useState<Location[]>([]);
  const[timeCards, setTimeCards] = useState<TimeCard[]>([]);
  const [shifts, setShifts] = useState<Shift[]>([]);
  const [members, setMembers] = useState<Member[]>([]);
  const [templates, setTemplates] = useState<ShiftTemplate[]>([]);
  const [checklists, setChecklists] = useState<Checklist[]>([]);
  const [globalTasks, setGlobalTasks] = useState<GlobalTask[]>([]);
  
  const[feedbacks, setFeedbacks] = useState<Feedback[]>([]);
  const [isFeedbacksLoading, setIsFeedbacksLoading] = useState(true);

  const [giftCards, setGiftCards] = useState<GiftCard[]>([]);
  const [isGiftCardsLoading, setIsGiftCardsLoading] = useState(true);

  const[selectedUserId, setSelectedUserId] = useState('');
  const [currentMonth, setCurrentMonth] = useState(new Date().getMonth());
  const [currentYear, setCurrentYear] = useState(new Date().getFullYear());
  
  const[calLocFilter, setCalLocFilter] = useState('');
  const [calEmpFilter, setCalEmpFilter] = useState('');

  const [editingCardId, setEditingCardId] = useState<number | null>(null);
  const[formDate, setFormDate] = useState('');
  const [formStartTime, setFormStartTime] = useState('');
  const[formEndTime, setFormEndTime] = useState('');
  const [selectedLocation, setSelectedLocation] = useState('');

  const[showChecklistModal, setShowChecklistModal] = useState(false);
  const [reportTargetCard, setReportTargetCard] = useState<TimeCard | null>(null); 
  const[editingChecklistId, setEditingChecklistId] = useState<number | null>(null); 
  const[clDynamicTasks, setClDynamicTasks] = useState<string[]>([]); 
  const [clCompletedTasks, setClCompletedTasks] = useState<string[]>([]); 
  const [clNotes, setClNotes] = useState('');

  const[passSearch, setPassSearch] = useState('');
  const [expandedMember, setExpandedMember] = useState<number | null>(null);
  const[pDate, setPDate] = useState('');
  const [pAmt, setPAmt] = useState<number | string>(1);
  const [pInitials, setPInitials] = useState('');
  const [editingRenewalId, setEditingRenewalId] = useState<number | null>(null);
  const [newRenewalDate, setNewRenewalDate] = useState('');
  const[editingTotalId, setEditingTotalId] = useState<number | null>(null);
  const[newTotalVal, setNewTotalVal] = useState<number | string>(12);
  const[newBonusNotes, setNewBonusNotes] = useState('');

  const [editingTplId, setEditingTplId] = useState<number | null>(null); 
  const [tplLocs, setTplLocs] = useState<number[]>([]);
  const [tplDays, setTplDays] = useState<(string | number)[]>([]);
  const [tplStart, setTplStart] = useState('');
  const [tplEnd, setTplEnd] = useState('');
  const [tplStartDate, setTplStartDate] = useState(''); 
  const [tplEndDate, setTplEndDate] = useState('');     
  const [tplTasks, setTplTasks] = useState<string[]>([]); 
  const [newTaskStr, setNewTaskStr] = useState(''); 
  const[tplUserId, setTplUserId] = useState(''); 

  const [tplViewLocs, setTplViewLocs] = useState<number[]>([]);
  const [tplViewDays, setTplViewDays] = useState<number[]>([]);

  const generatePeriods = () => {
    const p =[];
    const today = new Date();
    let curM = today.getMonth();
    let curY = today.getFullYear();
    if (today.getDate() < 28) { curM--; if(curM < 0) { curM = 11; curY--; } }
    for(let i=0; i<6; i++) {
      const s = new Date(curY, curM - i, 28);
      const e = new Date(curY, curM - i + 1, 27);
      p.push({ label: `${s.toLocaleDateString()} - ${e.toLocaleDateString()}`, start: s.toISOString(), end: e.toISOString() });
    }
    return p;
  };

  const [periods] = useState(generatePeriods());
  const [dashPeriodIndex, setDashPeriodIndex] = useState(0);
  const[dashLocs, setDashLocs] = useState<number[]>([]); 
  const [dashEmployees, setDashEmployees] = useState<number[]>([]);
  const [dashData, setDashData] = useState<any>({ totals: [], timeCards:[] });

  const [manPeriods, setManPeriods] = useState<number[]>([0]); 
  const[manLocs, setManLocs] = useState<number[]>([]);
  const[manEmps, setManEmps] = useState<number[]>([]);
  const [managerData, setManagerData] = useState<TimeCard[]>([]);

  const DAYS_OF_WEEK =['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const MONTHS =['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  const YEARS = [2025, 2026, 2027];
  const AVAILABLE_ROLES = ['Administrator', 'Manager', 'Front Desk', 'Trainer'];

  const formatTimeSafe = (dStr: string) => {
    if (!dStr) return 'Active';
    const d = new Date(dStr);
    if (isNaN(d.getTime())) return 'Active';
    return d.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'});
  };

  const formatDateSafe = (dStr: string) => {
    if (!dStr) return 'Unknown';
    const d = new Date(dStr);
    if (isNaN(d.getTime())) return 'Unknown';
    return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  };

  const getLocationColor = (locId: number | string) => {
    const colors =[
      { bg: 'bg-blue-100', border: 'border-blue-500', text: 'text-blue-900', claim: 'bg-blue-600 hover:bg-blue-700', badge: 'bg-blue-100 text-blue-900 border-blue-300' },
      { bg: 'bg-purple-100', border: 'border-purple-500', text: 'text-purple-900', claim: 'bg-purple-600 hover:bg-purple-700', badge: 'bg-purple-100 text-purple-900 border-purple-300' },
      { bg: 'bg-orange-100', border: 'border-orange-500', text: 'text-orange-900', claim: 'bg-orange-600 hover:bg-orange-700', badge: 'bg-orange-100 text-orange-900 border-orange-300' },
      { bg: 'bg-teal-100', border: 'border-teal-500', text: 'text-teal-900', claim: 'bg-teal-600 hover:bg-teal-700', badge: 'bg-teal-100 text-teal-900 border-teal-300' },
      { bg: 'bg-pink-100', border: 'border-pink-500', text: 'text-pink-900', claim: 'bg-pink-600 hover:bg-pink-700', badge: 'bg-pink-100 text-pink-900 border-pink-300' }
    ];
    const id = typeof locId === 'string' ? parseInt(locId) : locId;
    if(!id) return colors[0];
    const index = id % colors.length;
    return colors[index];
  };

  const fetchUsers = () => fetch('/api/users?t=' + new Date().getTime()).then(res => res.json()).then(data => { setUsers(data); if(data && data.length > 0 && !selectedUserId) setSelectedUserId(data[0].id.toString()); });
  const fetchMembers = () => fetch('/api/members?t=' + new Date().getTime()).then(res => res.json()).then(data => setMembers(data));
  const fetchShifts = () => fetch('/api/shifts?t=' + new Date().getTime()).then(res => res.json()).then(data => setShifts(data));
  const fetchTemplates = () => fetch('/api/templates?t=' + new Date().getTime()).then(res => res.json()).then(data => setTemplates(data));
  const fetchChecklists = () => fetch('/api/checklists?t=' + new Date().getTime()).then(res => res.json()).then(data => setChecklists(data));
  const fetchGlobalTasks = () => fetch('/api/tasks?t=' + new Date().getTime()).then(res => res.json()).then(data => setGlobalTasks(data));
  const fetchGiftCards = () => fetch('/api/giftcards?t=' + new Date().getTime()).then(res => res.json()).then(data => { setGiftCards(data); setIsGiftCardsLoading(false); }).catch(() => setIsGiftCardsLoading(false));
  const fetchFeedbacks = () => fetch('/api/feedback?t=' + new Date().getTime()).then(res => res.json()).then(data => { setFeedbacks(data); setIsFeedbacksLoading(false); }).catch(() => setIsFeedbacksLoading(false));

  useEffect(() => {
    setIsMounted(true);
    fetchUsers();
    fetchMembers();
    fetchTemplates();
    fetchChecklists(); 
    fetchGlobalTasks();
    fetchGiftCards(); 
    fetchFeedbacks();
    fetch('/api/locations?t=' + new Date().getTime()).then(res => res.json()).then(data => { setLocations(data); if(data && data.length > 0) setSelectedLocation(data[0].id.toString()); });
    fetch('/api/timecards?t=' + new Date().getTime()).then(res => res.json()).then(data => setTimeCards(data));
    fetchShifts();
  },[]);

  useEffect(() => {
    if (activeTab === 'dashboard') fetchDashboard();
    if (activeTab === 'manager') fetchManagerData();
  },[activeTab, dashPeriodIndex, dashLocs, dashEmployees, manPeriods, manLocs, manEmps, selectedUserId]);

  const activeUserObj = users.find(u => u.id === parseInt(selectedUserId));
  const activeRoles = activeUserObj && activeUserObj.systemRoles ? activeUserObj.systemRoles :[];

  const hasRole = (roleName: string) => activeRoles.includes(roleName);
  const isAdmin = hasRole('Administrator');
  const isManager = hasRole('Manager') || isAdmin;
  const isFrontDesk = hasRole('Front Desk') || isManager || isAdmin;

  const systemHasAdmin = users.some(u => u.systemRoles && u.systemRoles.includes('Administrator'));
  const showDashboard = isManager || isFrontDesk; 
  const showManagerView = isManager;
  const showSetup = isManager;
  const showReports = isManager; 
  const showStaff = isAdmin || !systemHasAdmin;
  const showPasses = isFrontDesk; 
  const showGiftCards = isFrontDesk; 

  useEffect(() => {
    if (!isMounted) return;
    if (activeTab === 'dashboard' && !showDashboard) setActiveTab('calendar');
    if (activeTab === 'manager' && !showManagerView) setActiveTab('calendar');
    if (activeTab === 'privileges' && !showPasses) setActiveTab('calendar');
    if (activeTab === 'giftcards' && !showGiftCards) setActiveTab('calendar'); 
    if (activeTab === 'setup' && !showSetup) setActiveTab('calendar');
    if (activeTab === 'staff' && !showStaff) setActiveTab('calendar');
    if (activeTab === 'reports' && !showReports) setActiveTab('calendar');
  },[selectedUserId, users, activeTab]);

  const fetchDashboard = async () => {
    const p = periods[dashPeriodIndex];
    let targetEmployees = dashEmployees;
    if (!isManager && selectedUserId) targetEmployees = [parseInt(selectedUserId)];
    const res = await fetch('/api/dashboard?t=' + new Date().getTime(), { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ startDate: p.start, endDate: p.end, userIds: targetEmployees, locationIds: dashLocs }) });
    const data = await res.json();
    setDashData(data); 
  };

  const fetchManagerData = async () => {
    const selectedPeriods = manPeriods.map(idx => periods[idx]);
    const res = await fetch('/api/manager?t=' + new Date().getTime(), { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ periods: selectedPeriods, userIds: manEmps }) });
    const data = await res.json();
    setManagerData(data);
  };

  const toggleDashLoc = (id: number) => dashLocs.includes(id) ? setDashLocs(dashLocs.filter(x => x !== id)) : setDashLocs([...dashLocs, id]);
  const toggleDashEmp = (id: number) => dashEmployees.includes(id) ? setDashEmployees(dashEmployees.filter(x => x !== id)) : setDashEmployees([...dashEmployees, id]);
  const toggleManPeriod = (idx: number) => manPeriods.includes(idx) ? setManPeriods(manPeriods.filter(x => x !== idx)) : setManPeriods([...manPeriods, idx]);
  const toggleManLoc = (id: number) => manLocs.includes(id) ? setManLocs(manLocs.filter(x => x !== id)) : setManLocs([...manLocs, id]);
  const toggleManEmp = (id: number) => manEmps.includes(id) ? setManEmps(manEmps.filter(x => x !== id)) : setManEmps([...manEmps, id]);
  const toggleTplLoc = (id: number) => { if (editingTplId) return setTplLocs([id]); tplLocs.includes(id) ? setTplLocs(tplLocs.filter(x => x !== id)) : setTplLocs([...tplLocs, id]); };
  const toggleTplDay = (idx: string | number) => { if (editingTplId) return setTplDays([idx]); tplDays.includes(idx) ? setTplDays(tplDays.filter(x => x !== idx)) : setTplDays([...tplDays, idx]); };
  const toggleTplViewLoc = (id: number) => tplViewLocs.includes(id) ? setTplViewLocs(tplViewLocs.filter(x => x !== id)) : setTplViewLocs([...tplViewLocs, id]);
  const toggleTplViewDay = (idx: number) => tplViewDays.includes(idx) ? setTplViewDays(tplViewDays.filter(x => x !== idx)) : setTplViewDays([...tplViewDays, idx]);
  const toggleTplTask = (taskName: string) => { if (tplTasks.includes(taskName)) setTplTasks(tplTasks.filter(t => t !== taskName)); else setTplTasks([...tplTasks, taskName]); };

  const handleRoleToggle = async (targetUserId: number, roleName: string) => {
    const targetUser = users.find(u => u.id === targetUserId);
    if (!targetUser) return;
    let currentRoles = targetUser.systemRoles ? [...targetUser.systemRoles] :[];
    if (currentRoles.includes(roleName)) currentRoles = currentRoles.filter(r => r !== roleName);
    else currentRoles.push(roleName);
    setUsers(users.map(u => u.id === targetUserId ? { ...u, systemRoles: currentRoles } : u));
    await fetch('/api/users', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: targetUserId, roles: currentRoles }) });
  };

  const handleUpdateUser = async (targetUserId: number, updates: any) => {
    setUsers(users.map(u => u.id === targetUserId ? { ...u, ...updates } : u));
    await fetch('/api/users', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: targetUserId, ...updates }) });
  };

  const handleSeedEmployees = async () => { if(!confirm("Add all new employees?")) return; const res = await fetch('/api/users/seed', { method: 'POST' }); const data = await res.json(); alert(`Success! ${data.count} new employees added.`); fetchUsers(); };
  const handleImportHistory = async () => { if(!confirm("Import Garner Schedule History?")) return; const res = await fetch('/api/shifts/import-history', { method: 'POST' }); const data = await res.json(); alert(`Success! ${data.count} shifts synced.`); fetchShifts(); };
  const handleImportTimecards = async () => { if(!confirm("Import Jan/Feb Worked Timecards?")) return; const res = await fetch('/api/timecards/seed', { method: 'POST' }); const data = await res.json(); alert(`Success! ${data.count} missing timecards logged.`); fetch('/api/timecards').then(r => r.json()).then(d => setTimeCards(d)); if (activeTab === 'dashboard') fetchDashboard(); };
  const handleImportPasses = async () => { if(!confirm("Import Platinum Guest Passes CSV?")) return; const res = await fetch('/api/members/seed', { method: 'POST' }); const data = await res.json(); alert(`Success! Added ${data.members} members.`); fetchMembers(); };

  const handleClaimShift = async (shiftId: number) => { if(!selectedUserId) return alert("Select an employee first!"); await fetch('/api/shifts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ shiftId: shiftId, userId: parseInt(selectedUserId), action: 'CLAIM' }) }); fetchShifts(); };
  const handleUnclaimShift = async (shiftId: number) => { if(!confirm("Unclaim this shift?")) return; await fetch('/api/shifts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ shiftId: shiftId, action: 'UNCLAIM' }) }); fetchShifts(); };

  const handleGenerateSchedule = async () => {
    if (templates.length === 0) return alert("Create templates first!");
    const res = await fetch('/api/shifts/seed', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ locationId: calLocFilter, month: currentMonth, year: currentYear }) });
    const data = await res.json();
    alert(`Success! ${data.count} new shifts generated.`);
    fetchShifts();
  };

  const handleManualSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if(!selectedUserId) return alert("Select an employee!");
    const clockInDateTime = new Date(`${formDate}T${formStartTime}`);
    const clockOutDateTime = formEndTime ? new Date(`${formDate}T${formEndTime}`) : null;
    const body = { id: editingCardId, userId: selectedUserId, locationId: selectedLocation, clockIn: clockInDateTime.toISOString(), clockOut: clockOutDateTime?.toISOString() || null };
    await fetch('/api/timecards', { method: editingCardId ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
    setEditingCardId(null); setFormStartTime(''); setFormEndTime('');
    fetch('/api/timecards').then(res => res.json()).then(data => setTimeCards(data));
  };

  const handleOpenReport = (card: TimeCard) => {
    setReportTargetCard(card);
    const tcDate = new Date(card.clockIn);
    const day = tcDate.getDay();
    const mins = tcDate.getHours() * 60 + tcDate.getMinutes();
    let bestTpl: ShiftTemplate | null = null;
    let minDiff = 9999;
    templates.filter(t => t.locationId === card.locationId && t.dayOfWeek === day).forEach(t => {
      const parts = t.startTime.split(':');
      const tMins = parseInt(parts[0]) * 60 + parseInt(parts[1]);
      const diff = Math.abs(mins - tMins);
      if (diff < minDiff && diff <= 180) { minDiff = diff; bestTpl = t; }
    });
    setClDynamicTasks(bestTpl?.checklistTasks ||[]);
    if (card.checklists && card.checklists.length > 0) {
      const existing = card.checklists[0];
      setEditingChecklistId(existing.id); setClCompletedTasks(existing.completedTasks ||[]); setClNotes(existing.notes || '');
    } else {
      setEditingChecklistId(null); setClCompletedTasks([]); setClNotes('');
    }
    setShowChecklistModal(true);
  };

  const toggleChecklistTask = (taskName: string) => clCompletedTasks.includes(taskName) ? setClCompletedTasks(clCompletedTasks.filter(t => t !== taskName)) : setClCompletedTasks([...clCompletedTasks, taskName]);

  const submitShiftReport = async () => {
    const missed = clDynamicTasks.filter(t => !clCompletedTasks.includes(t));
    const body = { id: editingChecklistId, userId: reportTargetCard?.userId, locationId: reportTargetCard?.locationId, timeCardId: reportTargetCard?.id, notes: clNotes, completedTasks: clCompletedTasks, missedTasks: missed };
    await fetch('/api/checklists', { method: editingChecklistId ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
    setShowChecklistModal(false); setReportTargetCard(null); setEditingChecklistId(null);
    fetch('/api/timecards').then(res => res.json()).then(data => setTimeCards(data));
    fetchChecklists(); 
  };

  const handleAddMasterTask = async () => {
    if (!newTaskStr.trim()) return;
    const res = await fetch('/api/tasks', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: newTaskStr.trim() }) });
    if (res.ok) {
      setNewTaskStr('');
      fetchGlobalTasks();
    } else {
      const data = await res.json();
      alert(data.error || "Failed to add task.");
    }
  };

  const handleDeleteMasterTask = async (taskId: number) => {
    if(!confirm("Delete this master task completely?")) return;
    const res = await fetch('/api/tasks', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: taskId }) });
    if (res.ok) fetchGlobalTasks();
  };

  const handleEditTemplate = (t: ShiftTemplate) => {
    setEditingTplId(t.id); setTplLocs([t.locationId]); setTplDays([t.dayOfWeek]); setTplStart(t.startTime); setTplEnd(t.endTime); setTplStartDate(t.startDate || ''); setTplEndDate(t.endDate || ''); setTplTasks(t.checklistTasks ||[]); setTplUserId(t.userId?.toString() || ''); window.scrollTo(0, 0);
  };

  const handleSaveTemplate = async (e: React.FormEvent) => {
    e.preventDefault();
    const body = { id: editingTplId, locationIds: tplLocs, daysOfWeek: tplDays, startTime: tplStart, endTime: tplEnd, startDate: tplStartDate || null, endDate: tplEndDate || null, checklistTasks: tplTasks, userId: tplUserId || null };
    await fetch('/api/templates', { method: editingTplId ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
    setEditingTplId(null); setTplLocs([]); setTplDays([]); setTplStart(''); setTplEnd(''); setTplStartDate(''); setTplEndDate(''); setTplTasks([]); setTplUserId('');
    fetchTemplates();
  };

  const handleDeleteTemplate = async (id: number) => { if(!confirm("Delete?")) return; await fetch('/api/templates', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) }); fetchTemplates(); };
  const handleRedeemBeverage = async (memberId: number) => { await fetch('/api/members', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ memberId, action: 'LOG_BEVERAGE' }) }); fetchMembers(); };
  const handleLogPass = async (e: React.FormEvent, memberId: number) => { e.preventDefault(); const res = await fetch('/api/members', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ memberId, dateUsed: pDate, amount: pAmt, initials: pInitials }) }); if (res.ok) { setPDate(''); setPAmt(1); setPInitials(''); fetchMembers(); } };
  
  const handleEditClick = (card: TimeCard) => {
    const inD = new Date(card.clockIn);
    setFormDate(inD.toISOString().split('T')[0]); setFormStartTime(inD.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }));
    if (card.clockOut) setFormEndTime(new Date(card.clockOut).toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }));
    else setFormEndTime('');
    setSelectedLocation(card.locationId.toString()); setSelectedUserId(card.userId.toString()); setEditingCardId(card.id); setActiveTab('manual'); window.scrollTo(0, 0);
  };

  const handleDeleteClick = async (cardId: number) => { if(!confirm("Delete?")) return; await fetch('/api/timecards', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: cardId }) }); fetch('/api/timecards').then(res => res.json()).then(data => setTimeCards(data)); };

  const handleExportCSV = () => {
    let csv = "Pay Period,Location,Employee,Hours\n";
    appState.matrixRows.forEach((row: any) => { appState.activeManPeriods.forEach((p: any) => { const h = row.periodTotals.get(p.label); if (h > 0) csv += `"${p.label}","${row.locName}","${row.empName}",${h.toFixed(2)}\n`; }); });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = "Payroll.csv"; link.click();
  };

  const handleIssueGiftCard = async (payload: any) => {
    const res = await fetch('/api/giftcards', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    fetchGiftCards(); return { success: res.ok };
  };

  const handleRedeemCard = async (id: number, amount: number) => {
    const res = await fetch(`/api/giftcards/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ redemptionAmount: amount }) });
    fetchGiftCards(); return { success: res.ok };
  };

  const handleSubmitFeedback = async (payload: any) => {
    const res = await fetch('/api/feedback', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    fetchFeedbacks(); return { success: res.ok };
  };

  const handleUpdateFeedback = async (id: number, payload: any) => {
    const res = await fetch(`/api/feedback/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    fetchFeedbacks(); return { success: res.ok };
  };

  // --- TAB LABELS MAPPING ---
  // This explicitly sets what the buttons should say to avoid user confusion
  const TAB_LABELS: Record<string, string> = {
    calendar: 'Calendar',
    manual: 'Time Cards',     // <-- This maps the internal key "manual" to the beautiful "Time Cards" label
    dashboard: 'Dashboard',
    manager: 'Manager',
    privileges: 'Passes',
    giftcards: 'Gift Cards',
    feedback: ' Feedback',
    reports: 'Reports',
    setup: 'Shift Setup',
    staff: 'Staff'
  };

  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const daysInM = new Date(currentYear, currentMonth + 1, 0).getDate();
  const calendarCells =[...new Array(firstDay).fill(null), ...Array.from({ length: daysInM }, (_, i) => i + 1)];

  const matrixMap = new Map();
  const hiddenWarningsMap = new Map();
  const activeManPeriods = manPeriods.map(idx => periods[idx]);

  managerData.forEach(card => {
    if (manLocs.length > 0 && !manLocs.includes(card.locationId)) {
      if (!hiddenWarningsMap.has(card.user?.name)) hiddenWarningsMap.set(card.user?.name, new Set());
      hiddenWarningsMap.get(card.user?.name).add(card.location?.name); return;
    }
    const key = `${card.locationId}_${card.userId}`;
    if (!matrixMap.has(key)) matrixMap.set(key, { locName: card.location?.name, empName: card.user?.name, periodTotals: new Map(), totalRowHours: 0 });
    const row = matrixMap.get(key);
    activeManPeriods.forEach(p => {
      const cDate = new Date(card.clockIn); if (cDate >= new Date(p.start) && cDate <= new Date(new Date(p.end).setHours(23,59,59))) {
        row.periodTotals.set(p.label, (row.periodTotals.get(p.label) || 0) + (card.totalHours || 0));
        row.totalRowHours += (card.totalHours || 0);
      }
    });
  });

  const appState: AppState = {
    isMounted, activeTab, setActiveTab, users, locations, timeCards, shifts, members, templates, checklists,
    selectedUserId, setSelectedUserId, currentMonth, setCurrentMonth, currentYear, setCurrentYear,
    calLocFilter, setCalLocFilter, calEmpFilter, setCalEmpFilter, editingCardId, setEditingCardId,
    formDate, setFormDate, formStartTime, setFormStartTime, formEndTime, setFormEndTime,
    selectedLocation, setSelectedLocation, passSearch, setPassSearch, expandedMember, setExpandedMember,
    pDate, setPDate, pAmt, setPAmt, pInitials, setPInitials, editingTplId, setEditingTplId,
    tplLocs, setTplLocs, tplDays, setTplDays, tplStart, setTplStart, tplEnd, setTplEnd,
    tplStartDate, setTplStartDate, tplEndDate, setTplEndDate, tplTasks, setTplTasks, tplUserId, setTplUserId,
    tplViewLocs, setTplViewLocs, tplViewDays, setTplViewDays, dashPeriodIndex, setDashPeriodIndex, 
    dashLocs, setDashLocs, dashEmployees, setDashEmployees, manPeriods, setManPeriods, manLocs, setManLocs, 
    manEmps, setManEmps, managerData, DAYS_OF_WEEK, MONTHS, YEARS, AVAILABLE_ROLES, formatTimeSafe, 
    formatDateSafe, getLocationColor, showDashboard, showManagerView, showSetup, showReports, showStaff, 
    showPasses, isManager, isAdmin, toggleDashLoc, toggleDashEmp, toggleManPeriod, toggleManLoc, toggleManEmp, 
    toggleTplLoc, toggleTplDay, toggleTplViewLoc, toggleTplViewDay, toggleTplTask, handleRoleToggle, 
    handleUpdateUser, handleSeedEmployees, handleImportHistory, handleImportTimecards, handleImportPasses, handleClaimShift, 
    handleUnclaimShift, handleGenerateSchedule, handleManualSubmit, handleOpenReport, toggleChecklistTask, 
    submitShiftReport, handleAddMasterTask, handleDeleteMasterTask, handleEditTemplate, handleSaveTemplate, handleDeleteTemplate, handleRedeemBeverage, 
    handleLogPass, handleEditClick, handleDeleteClick, handleExportCSV, periods, 
    dashData: { timeCards: dashData.timeCards ||[] }, showChecklistModal, 
    setShowChecklistModal, reportTargetCard, setReportTargetCard, editingChecklistId, setEditingChecklistId,
    clDynamicTasks, setClDynamicTasks, clCompletedTasks, setClCompletedTasks, clNotes, setClNotes,
    globalTasks, setGlobalTasks, fetchGlobalTasks, editingRenewalId, setEditingRenewalId, newRenewalDate, setNewRenewalDate,
    editingTotalId, setEditingTotalId, newTotalVal, setNewTotalVal, newBonusNotes, setNewBonusNotes,
    giftCards, setGiftCards, fetchGiftCards, handleIssueGiftCard, handleRedeemCard, showGiftCards,
    isGiftCardsLoading, feedbacks, setFeedbacks, fetchFeedbacks, handleSubmitFeedback, handleUpdateFeedback, 
    isFeedbacksLoading, calendarCells, 
    activeCalColor: calLocFilter ? getLocationColor(calLocFilter) : { bg: 'bg-slate-900', text: 'text-white', border: 'border-slate-800' },
    activeManPeriods, matrixRows: Array.from(matrixMap.values()), hiddenWarnings: Array.from(hiddenWarningsMap.entries()).map(([k, v]) => `${k} (${Array.from(v).join(', ')})`),
    missingPunches: [], dashVisibleData: [], dashHiddenWarnings:[],
    activeUserTimeCards: timeCards.filter(c => c.userId === parseInt(selectedUserId)),
    filteredMembers: members.filter(m => m.lastName.toLowerCase().includes(passSearch.toLowerCase())),
    filteredTemplates: templates
  };

  if (!isMounted) return <div className="p-10 text-center font-bold">Loading...</div>;

  return (
    <div className="min-h-screen bg-gray-100 p-2 md:p-6 font-sans relative">
      {showChecklistModal && (
        <div className="fixed inset-0 bg-slate-900 bg-opacity-75 z-50 flex justify-center items-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full">
            <h3 className="text-2xl font-black mb-6">{editingChecklistId ? 'Edit Shift Report' : 'Shift Closing Checklist'}</h3>
            <div className="space-y-4 mb-8 max-h-60 overflow-y-auto">
              {clDynamicTasks.map((t, i) => (
                <label key={i} className="flex items-center space-x-3 cursor-pointer bg-slate-50 p-3 rounded-lg border">
                  <input type="checkbox" checked={clCompletedTasks.includes(t)} onChange={() => toggleChecklistTask(t)} className="w-6 h-6" />
                  <span className="font-bold">{t}</span>
                </label>
              ))}
            </div>
            <textarea value={clNotes} onChange={(e) => setClNotes(e.target.value)} rows={3} placeholder="Notes..." className="w-full border rounded-lg p-3 mb-6"></textarea>
            <div className="flex justify-end space-x-3">
              <button onClick={() => setShowChecklistModal(false)} className="px-6 py-3 bg-gray-200 font-bold rounded-lg">Cancel</button>
              <button onClick={submitShiftReport} className="px-6 py-3 bg-green-800 text-white font-bold rounded-lg">Submit</button>
            </div>
          </div>
        </div>
      )}
      
      <div className="max-w-7xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden border border-gray-300">
        
        <div className="bg-slate-900 p-6 text-white flex flex-col xl:flex-row justify-between items-center gap-4">
          <div className="flex items-center gap-4">
            <img src="/logo.png" alt="Logo" className="h-16 w-auto" />
            <h1 className="text-3xl font-black italic uppercase tracking-widest"><span className="text-yellow-400">Pickles</span> & Play</h1>
          </div>
          
          <div className="flex items-center gap-2 bg-slate-800 p-2 rounded-lg border border-slate-700">
            <span className="text-sm font-bold">Employee:</span>
            <select value={selectedUserId} onChange={(e) => setSelectedUserId(e.target.value)} className="text-slate-900 rounded p-1.5 text-sm font-black bg-white">
              <option value="">-- Select --</option>
              {users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
            </select>
          </div>

          <div className="flex flex-wrap gap-2 justify-center">
            {['calendar', 'manual', 'dashboard', 'manager', 'privileges', 'giftcards', 'feedback', 'reports', 'setup', 'staff'].map(tab => {
              
              // Only render the tabs the current user has access to see
              const visible = (tab === 'calendar' || tab === 'manual' || tab === 'feedback') || 
                              (tab === 'dashboard' && showDashboard) || 
                              (tab === 'manager' && showManagerView) || 
                              (tab === 'privileges' && showPasses) || 
                              (tab === 'giftcards' && showGiftCards) || 
                              (tab === 'reports' && showReports) || 
                              (tab === 'setup' && showSetup) || 
                              (tab === 'staff' && showStaff);
              
              if (!visible) return null;
              
              return (
                <button 
                  key={tab} 
                  onClick={() => setActiveTab(tab)} 
                  className={`px-3 py-2 rounded-lg font-black uppercase text-xs transition shadow-sm ${
                    activeTab === tab 
                      ? 'bg-yellow-400 text-slate-900' 
                      : 'bg-slate-800 hover:bg-green-800 text-white'
                  }`}
                >
                  {/* Maps internal key "manual" to output "Time Cards" visually! */}
                  {TAB_LABELS[tab]}
                </button>
              );
            })}
          </div>
        </div>

        <div className="p-4 md:p-8 bg-gray-50">
          {activeTab === 'calendar' && <CalendarTab appState={appState} />}
          {activeTab === 'manual' && <TimeCardTab appState={appState} />}
          {activeTab === 'dashboard' && <DashboardTab appState={appState} />}
          {activeTab === 'manager' && <ManagerTab appState={appState} />}
          {activeTab === 'privileges' && <PrivilegesTab appState={appState} />}
          {activeTab === 'reports' && <ReportsTab appState={appState} />}
          {activeTab === 'setup' && <SetupTab appState={appState} />}
          {activeTab === 'staff' && <StaffTab appState={appState} />}
          {activeTab === 'giftcards' && <GiftCardTab appState={appState} />}
          {activeTab === 'feedback' && <FeedbackTab appState={appState} />}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="package.json">
{
  "name": "shiftsync-app",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "prisma generate && next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@prisma/adapter-pg": "^7.4.1",
    "@prisma/client": "^6.19.2",
    "dotenv": "^17.3.1",
    "lucide-react": "^0.575.0",
    "next": "16.1.6",
    "pg": "^8.19.0",
    "react": "19.2.3",
    "react-dom": "19.2.3",
    "zod": "^4.3.6"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.1.6",
    "prisma": "^6.19.2",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
</file>

<file path="prisma/schema.prisma">
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  MANAGER
  EMPLOYEE
}

model Location {
  id          Int             @id @default(autoincrement())
  name        String          @unique 
  users       User[]     
  shifts      Shift[]    
  timeCards   TimeCard[] 
  templates   ShiftTemplate[] 
  checklists  Checklist[]     
}

model User {
  id          Int        @id @default(autoincrement())
  name        String     
  pinCode     String?    
  role        Role       @default(EMPLOYEE)
  systemRoles String[]   @default(["Front Desk"]) 
  
  // Added array to support multiple locations natively
  locationIds Int[]      @default([])

  locationId  Int?
  location    Location?  @relation(fields: [ locationId ], references:[ id ])
  shifts      Shift[]
  timeCards   TimeCard[]
  checklists  Checklist[]     
  templates   ShiftTemplate[]
  feedbacks   Feedback[]
}

model PayPeriod {
  id           Int          @id @default(autoincrement())
  year         Int        
  periodNumber Int        
  startDate    DateTime   
  endDate      DateTime   
  timeCards    TimeCard[]

  @@unique([ year, periodNumber ])
}

model Shift {
  id          Int        @id @default(autoincrement())
  startTime   DateTime
  endTime     DateTime
  status      String     @default("OPEN") 
  locationId  Int
  location    Location   @relation(fields: [ locationId ], references: [ id ])
  userId      Int?
  assignedTo  User?      @relation(fields: [ userId ], references: [ id ])
}

model TimeCard {
  id          Int          @id @default(autoincrement())
  clockIn     DateTime
  clockOut    DateTime?
  totalHours  Float?     
  userId      Int
  user        User         @relation(fields: [ userId ], references: [ id ])
  locationId  Int
  location    Location     @relation(fields: [ locationId ], references: [ id ])
  payPeriodId Int?
  payPeriod   PayPeriod?   @relation(fields: [ payPeriodId ], references:[ id ])
  
  checklists  Checklist[] 
}

model Member {
  id               Int         @id @default(autoincrement())
  lastName         String
  firstName        String
  location         String?
  notes            String?     
  bonusNotes       String?     
  family           String?
  renewalDate      String?
  totalPasses      Int         @default(12)
  lastBeverageDate DateTime?   
  usages           PassUsage[]
  giftCards        GiftCard[]  
}

model PassUsage {
  id         Int      @id @default(autoincrement())
  dateUsed   String
  amount     Int
  initials   String?
  memberId   Int
  member     Member   @relation(fields: [ memberId ], references: [ id ])
}

model GiftCard {
  id               Int      @id @default(autoincrement())
  code             String   @unique
  initialAmount    Float
  remainingBalance Float
  recipientName    String?  
  memberId         Int?     
  member           Member?  @relation(fields: [memberId], references:[id])
  issuedAt         DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model ShiftTemplate {
  id             Int      @id @default(autoincrement())
  locationId     Int
  location       Location @relation(fields: [locationId], references:[id])
  dayOfWeek      Int      
  startTime      String   
  endTime        String   
  startDate      String?  
  endDate        String?  
  checklistTasks String[] @default([]) 
  userId         Int?     
  user           User?    @relation(fields:[userId], references:[id])
}

model Checklist {
  id             Int       @id @default(autoincrement())
  date           DateTime  @default(now())
  userId         Int
  user           User      @relation(fields: [userId], references:[id])
  locationId     Int
  location       Location  @relation(fields: [locationId], references: [id])
  timeCardId     Int?      
  timeCard       TimeCard? @relation(fields:[timeCardId], references: [id]) 
  notes          String?
  completedTasks String[]  @default([])
  missedTasks    String[]  @default([])
}

model GlobalTask {
  id   Int    @id @default(autoincrement())
  name String @unique
}

model Feedback {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String   
  description String
  status      String   @default("OPEN") 
  devNotes    String?
  createdAt   DateTime @default(now())
}
</file>

<file path="tsconfig.json">
{
   "compilerOptions": {
    "noImplicitAny": false,
    "target": "es5",
    "lib":["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path="app/components/GiftCardTab.tsx">
"use client";

import React, { useState } from 'react';
import { AppState, GiftCard, Member } from '../lib/types';

export default function GiftCardTab({ appState }: { appState: AppState }) {
  const { members, giftCards, handleIssueGiftCard, handleRedeemCard } = appState;
  
  const [isIssueOpen, setIsIssueOpen] = useState(false);
  const [isRedeemOpen, setIsRedeemOpen] = useState(false);
  const[selectedCard, setSelectedCard] = useState<GiftCard | null>(null);
  const[redeemAmount, setRedeemAmount] = useState('');
  
  const [isMemberMode, setIsMemberMode] = useState(true);
  const [showManualInput, setShowManualInput] = useState(false); 
  
  const[issueForm, setIssueForm] = useState({
    code: '',
    amount: '',
    memberId: '',
    recipientName: ''
  });

  const generateCode = () => {
    const code = 'SS-' + Math.random().toString(36).substring(2, 9).toUpperCase();
    setIssueForm({ ...issueForm, code });
  };

  const handleIssueSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    const res = await handleIssueGiftCard(issueForm);
    if (res.success) {
      setIsIssueOpen(false);
      setIssueForm({ code: '', amount: '', memberId: '', recipientName: '' });
      setShowManualInput(false);
    }
  };

  const handleRedeemSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!selectedCard) return;
    const res = await handleRedeemCard(selectedCard.id, parseFloat(redeemAmount));
    if (res.success) {
      setIsRedeemOpen(false);
      setRedeemAmount('');
      setSelectedCard(null);
    }
  };

  return (
    <div className="space-y-6 animate-in fade-in duration-500">
      
      {/* Header Area */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h3 className="text-2xl font-black text-slate-900">Gift Card Registry</h3>
          <p className="text-sm font-bold text-slate-700">Spreadsheet view of all store credit issued to members and guests.</p>
        </div>
        <button
          onClick={() => setIsIssueOpen(true)}
          className="flex items-center justify-center gap-2 bg-green-800 hover:bg-green-900 text-white px-6 py-3 rounded-xl font-black transition-all shadow-lg"
        >
          <span></span> Issue Gift Card
        </button>
      </div>

      {/* Spreadsheet Table View */}
      <div className="bg-white rounded-2xl shadow-md border border-slate-300 overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full text-left border-collapse whitespace-nowrap">
            <thead className="bg-slate-200 border-b-2 border-slate-300 text-slate-900 font-black text-xs uppercase tracking-wider">
              <tr>
                <th className="px-6 py-4">Card Code</th>
                <th className="px-6 py-4">Holder</th>
                <th className="px-6 py-4">Type</th>
                <th className="px-6 py-4">Date Issued</th>
                <th className="px-6 py-4 text-right">Original Amt</th>
                <th className="px-6 py-4 text-right">Balance</th>
                <th className="px-6 py-4 text-center">Action</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-200">
              {giftCards?.length === 0 ? (
                <tr>
                  <td colSpan={7} className="px-6 py-16 text-center text-slate-600">
                    <div className="text-5xl mb-4 opacity-30 drop-shadow-sm"></div>
                    <p className="font-black text-lg">No gift cards issued yet.</p>
                  </td>
                </tr>
              ) : (
                giftCards?.map((card: GiftCard) => (
                  <tr key={card.id} className="hover:bg-slate-50 transition-colors">
                    <td className="px-6 py-4">
                      <span className="font-mono font-black text-slate-900 bg-slate-100 border border-slate-300 px-3 py-1.5 rounded-md text-xs uppercase tracking-widest shadow-sm">
                        {card.code}
                      </span>
                    </td>
                    <td className="px-6 py-4 font-black text-slate-900">
                      {card.member ? `${card.member.firstName} ${card.member.lastName}` : card.recipientName}
                    </td>
                    <td className="px-6 py-4">
                      <span className={`px-3 py-1 rounded-full text-[10px] font-black tracking-widest shadow-sm border ${card.member ? 'bg-green-100 text-green-900 border-green-300' : 'bg-slate-200 text-slate-800 border-slate-300'}`}>
                        {card.member ? 'MEMBER' : 'GUEST'}
                      </span>
                    </td>
                    <td className="px-6 py-4 text-sm font-bold text-slate-700">
                      {new Date(card.issuedAt).toLocaleDateString()}
                    </td>
                    <td className="px-6 py-4 text-right text-sm font-bold text-slate-700">
                      ${card.initialAmount.toFixed(2)}
                    </td>
                    <td className="px-6 py-4 text-right">
                      {card.remainingBalance <= 0 ? (
                        <span className="text-red-800 font-black bg-red-100 border border-red-300 px-3 py-1 rounded-md text-sm shadow-sm">$0.00</span>
                      ) : (
                        <span className="text-slate-900 font-black text-base">${card.remainingBalance.toFixed(2)}</span>
                      )}
                    </td>
                    <td className="px-6 py-4 text-center">
                      <button
                        onClick={() => {
                          setSelectedCard(card);
                          setIsRedeemOpen(true);
                        }}
                        disabled={card.remainingBalance <= 0}
                        className="bg-slate-900 text-white px-5 py-2 rounded-lg text-xs font-black hover:bg-black disabled:opacity-30 disabled:cursor-not-allowed transition-colors shadow-md mx-auto block"
                      >
                        Redeem
                      </button>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* ISSUE MODAL */}
      {isIssueOpen && (
        <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
          <div className="bg-white rounded-[32px] w-full max-w-md shadow-2xl overflow-hidden animate-in zoom-in duration-200 border border-slate-300">
            <div className="p-6 md:p-8 border-b-2 border-slate-100 flex justify-between items-center bg-slate-50">
              <h4 className="font-black text-slate-900 text-2xl">Issue Credit</h4>
              <button onClick={() => setIsIssueOpen(false)} className="text-slate-600 hover:text-red-600 text-2xl font-black transition-colors">
                
              </button>
            </div>

            <form onSubmit={handleIssueSubmit} className="p-6 md:p-8 space-y-6">
              
              <div className="flex p-1.5 bg-slate-200 rounded-xl shadow-inner">
                <button
                  type="button"
                  onClick={() => { setIsMemberMode(true); setShowManualInput(false); setIssueForm({...issueForm, recipientName: '', memberId: ''}); }}
                  className={`flex-1 flex items-center justify-center gap-2 py-2.5 text-sm font-black rounded-lg transition-all ${isMemberMode ? 'bg-white shadow-md text-green-900' : 'text-slate-700 hover:text-slate-900'}`}
                >
                  <span></span> Member
                </button>
                <button
                  type="button"
                  onClick={() => { setIsMemberMode(false); setShowManualInput(false); setIssueForm({...issueForm, recipientName: '', memberId: ''}); }}
                  className={`flex-1 flex items-center justify-center gap-2 py-2.5 text-sm font-black rounded-lg transition-all ${!isMemberMode ? 'bg-white shadow-md text-green-900' : 'text-slate-700 hover:text-slate-900'}`}
                >
                  <span>+</span> Guest
                </button>
              </div>

              <div>
                <label className="block text-xs font-black text-slate-900 uppercase mb-2 ml-1">Card Code</label>
                <div className="flex gap-2">
                  <input
                    required
                    value={issueForm.code}
                    onChange={(e) => setIssueForm({ ...issueForm, code: e.target.value.toUpperCase() })}
                    className="flex-1 bg-white border-2 border-slate-300 rounded-xl px-4 py-3 text-sm font-mono focus:border-green-600 focus:ring-0 outline-none text-slate-900 font-bold placeholder-slate-500 shadow-sm"
                    placeholder="SS-XXXXXX"
                  />
                  <button type="button" onClick={generateCode} className="text-sm font-black text-green-900 px-5 bg-green-100 hover:bg-green-200 rounded-xl transition-colors border-2 border-green-300 shadow-sm">Auto</button>
                </div>
              </div>

              {isMemberMode ? (
                <div>
                  <label className="block text-xs font-black text-slate-900 uppercase mb-2 ml-1">Member</label>
                  
                  {showManualInput ? (
                    <div className="flex gap-2 animate-in fade-in slide-in-from-right-2">
                      <input
                        required
                        autoFocus
                        className="flex-1 bg-white border-2 border-slate-300 rounded-xl px-4 py-3 text-sm focus:border-green-600 focus:ring-0 outline-none text-slate-900 font-bold placeholder-slate-500 shadow-sm"
                        placeholder="Type member name manually..."
                        value={issueForm.recipientName}
                        onChange={(e) => setIssueForm({ ...issueForm, recipientName: e.target.value, memberId: '' })}
                      />
                      <button
                        type="button"
                        onClick={() => { setShowManualInput(false); setIssueForm({ ...issueForm, recipientName: '' }); }}
                        className="text-xs font-black text-slate-800 bg-slate-200 hover:bg-slate-300 border-2 border-slate-300 rounded-xl px-4 transition-colors shadow-sm"
                      >
                        Cancel
                      </button>
                    </div>
                  ) : (
                    <select
                      required
                      className="w-full bg-white border-2 border-slate-300 rounded-xl px-4 py-3 text-sm outline-none focus:border-green-600 focus:ring-0 text-slate-900 font-bold cursor-pointer shadow-sm"
                      value={issueForm.memberId}
                      onChange={(e) => {
                        if (e.target.value === 'MANUAL') {
                          setShowManualInput(true);
                          setIssueForm({ ...issueForm, memberId: '', recipientName: '' });
                        } else {
                          setIssueForm({ ...issueForm, memberId: e.target.value, recipientName: '' });
                        }
                      }}
                    >
                      <option value="" className="text-slate-700 font-bold">Select Member...</option>
                      <option value="MANUAL" className="font-black text-green-800 bg-green-100"> Not listed? Type name manually...</option>
                      {members?.map((m: Member) => (
                        <option key={m.id} value={m.id} className="text-slate-900 font-bold">{m.firstName} {m.lastName}</option>
                      ))}
                    </select>
                  )}
                </div>
              ) : (
                <div>
                  <label className="block text-xs font-black text-slate-900 uppercase mb-2 ml-1">Recipient Name</label>
                  <input
                    required
                    className="w-full bg-white border-2 border-slate-300 rounded-xl px-4 py-3 text-sm outline-none focus:border-green-600 focus:ring-0 text-slate-900 font-bold placeholder-slate-500 shadow-sm"
                    placeholder="e.g. Guest Name"
                    value={issueForm.recipientName}
                    onChange={(e) => setIssueForm({ ...issueForm, recipientName: e.target.value, memberId: '' })}
                  />
                </div>
              )}

              <div>
                <label className="block text-xs font-black text-slate-900 uppercase mb-2 ml-1">Amount ($)</label>
                <input
                  required
                  type="number"
                  step="0.01"
                  min="1"
                  className="w-full bg-white border-2 border-slate-300 rounded-xl px-4 py-3 text-xl outline-none focus:border-green-600 focus:ring-0 text-slate-900 font-black placeholder-slate-400 shadow-sm"
                  placeholder="0.00"
                  value={issueForm.amount}
                  onChange={(e) => setIssueForm({ ...issueForm, amount: e.target.value })}
                />
              </div>

              <button
                type="submit"
                className="w-full bg-green-800 text-white py-4 rounded-xl font-black text-lg shadow-xl shadow-green-900/20 hover:bg-green-900 transition-all flex items-center justify-center gap-3 mt-4"
              >
                Issue Gift Card <span className="text-2xl leading-none"></span>
              </button>
            </form>
          </div>
        </div>
      )}

      {/* REDEEM MODAL */}
      {isRedeemOpen && selectedCard && (
        <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
          <div className="bg-white rounded-[40px] w-full max-w-sm shadow-2xl overflow-hidden animate-in slide-in-from-bottom-4 duration-300 border border-slate-300">
            <div className="bg-green-900 p-8 md:p-10 text-white text-center shadow-inner">
              <div className="text-6xl opacity-70 mx-auto mb-4 drop-shadow-md"></div>
              <h4 className="text-3xl font-black uppercase tracking-tight">Redeem</h4>
              <p className="text-green-200 font-bold mt-2 text-lg">Available: ${selectedCard.remainingBalance.toFixed(2)}</p>
            </div>
            
            <form onSubmit={handleRedeemSubmit} className="p-8 md:p-10">
              <div className="mb-8">
                <label className="block text-center text-xs font-black text-slate-700 uppercase mb-3">Amount to Deduct</label>
                <div className="relative">
                  <span className="absolute left-6 top-1/2 -translate-y-1/2 text-slate-500 font-black text-3xl">$</span>
                  <input
                    required
                    autoFocus
                    type="number"
                    step="0.01"
                    max={selectedCard.remainingBalance}
                    className="w-full border-4 border-slate-300 rounded-[24px] py-6 px-12 text-4xl font-black text-center text-slate-900 focus:border-green-600 focus:ring-0 outline-none transition-all placeholder-slate-400 shadow-inner"
                    placeholder="0.00"
                    value={redeemAmount}
                    onChange={(e) => setRedeemAmount(e.target.value)}
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <button
                  type="button"
                  onClick={() => setIsRedeemOpen(false)}
                  className="py-4 rounded-2xl font-black text-slate-800 bg-slate-200 border-2 border-slate-300 hover:bg-slate-300 transition-colors"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  disabled={!redeemAmount || parseFloat(redeemAmount) <= 0 || parseFloat(redeemAmount) > parseFloat(selectedCard.remainingBalance.toFixed(2))}
                  className="bg-green-800 text-white py-4 rounded-2xl font-black text-lg hover:bg-green-900 disabled:opacity-40 disabled:bg-slate-500 shadow-xl shadow-green-900/30 transition-all"
                >
                  Apply
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="app/components/ReportsTab.tsx">
"use client";
import React from 'react';
import { AppState, Checklist, TimeCard } from '../lib/types';

export default function ReportsTab({ appState }: { appState: AppState }) {
  const { checklists, timeCards } = appState;

  // Safe sorting: Convert ISO strings to numbers for comparison
  const sortedChecklists = [...(checklists || [])].sort((a: Checklist, b: Checklist) => {
    const tcA = timeCards.find((t: TimeCard) => t.id === a.timeCardId);
    const tcB = timeCards.find((t: TimeCard) => t.id === b.timeCardId);
    
    const dateA = new Date(tcA?.clockIn || a.date).getTime();
    const dateB = new Date(tcB?.clockIn || b.date).getTime();
    
    return dateB - dateA;
  });

  return (
    <div className="p-4 md:p-6 space-y-6">
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 border-b border-gray-200 pb-4">
        <div>
          <h2 className="text-2xl font-black text-slate-900">Shift Reports</h2>
          <p className="text-sm font-bold text-slate-500 mt-1">Review submitted shift closing checklists and notes.</p>
        </div>
      </div>

      <div className="grid gap-4">
        {sortedChecklists.length === 0 ? (
          <div className="bg-white p-8 rounded-xl border border-dashed border-gray-300 text-center">
            <p className="font-bold text-slate-400 italic">No shift reports found.</p>
          </div>
        ) : (
          sortedChecklists.map((report: Checklist) => {
            const tc = timeCards.find((t: TimeCard) => t.id === report.timeCardId);
            return (
              <div key={report.id} className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                <div className="bg-slate-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                  <span className="font-black text-slate-800">
                    {report.user?.name || 'Unknown User'} @ {report.location?.name || 'Unknown Location'}
                  </span>
                  <span className="text-xs font-bold text-slate-500 uppercase tracking-tighter">
                    {tc ? new Date(tc.clockIn).toLocaleDateString() : new Date(report.date).toLocaleDateString()}
                  </span>
                </div>
                <div className="p-4">
                  <div className="mb-4">
                    <p className="text-xs font-black text-slate-400 uppercase mb-1">Notes</p>
                    <p className="text-sm font-bold text-slate-700">{report.notes || 'No notes provided.'}</p>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <p className="text-xs font-black text-green-600 uppercase mb-1">Completed Tasks ({report.completedTasks?.length || 0})</p>
                      <ul className="text-xs font-bold text-slate-600 list-disc pl-4">
                        {report.completedTasks.map((t: string, i: number) => <li key={i}>{t}</li>)}
                      </ul>
                    </div>
                    <div>
                      <p className="text-xs font-black text-red-600 uppercase mb-1">Missed Tasks ({report.missedTasks?.length || 0})</p>
                      <ul className="text-xs font-bold text-slate-600 list-disc pl-4">
                        {report.missedTasks.map((t: string, i: number) => <li key={i}>{t}</li>)}
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            );
          })
        )}
      </div>
    </div>
  );
}
</file>

<file path="app/components/SetupTab.tsx">
"use client";
import React, { useState, useEffect, useRef } from 'react';
import { AppState, Location, GlobalTask } from '../lib/types';

export default function SetupTab({ appState }: { appState: AppState }) {
  const [activeTab, setActiveTab] = useState('templates');
  const[showLocFilter, setShowLocFilter] = useState(false);
  const [showDayFilter, setShowDayFilter] = useState(false);
  const [sortConfig, setSortConfig] = useState<{key: string, direction: 'asc' | 'desc'}>({ key: 'location', direction: 'asc' });

  const locFilterRef = useRef<HTMLTableHeaderCellElement>(null);
  const dayFilterRef = useRef<HTMLTableHeaderCellElement>(null);

  const {
    editingTplId, locations, tplLocs, toggleTplLoc, DAYS_OF_WEEK, tplDays, toggleTplDay, 
    tplStart, setTplStart, tplEnd, setTplEnd, tplStartDate, setTplStartDate,
    tplEndDate, setTplEndDate, setEditingTplId, setTplLocs, setTplDays,
    setTplTasks, tplViewLocs, toggleTplViewLoc, tplViewDays, toggleTplViewDay,
    setTplViewLocs, setTplViewDays, filteredTemplates, handleEditTemplate, 
    handleDeleteTemplate, users, globalTasks, tplTasks, toggleTplTask, 
    handleSaveTemplate, newTaskStr, setNewTaskStr, tplUserId, setTplUserId,
    handleAddMasterTask, handleDeleteMasterTask
  } = appState;

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (locFilterRef.current && !locFilterRef.current.contains(event.target as Node)) {
        setShowLocFilter(false);
      }
      if (dayFilterRef.current && !dayFilterRef.current.contains(event.target as Node)) {
        setShowDayFilter(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  },[]);

  const handleSelectAllTasks = () => {
    if (globalTasks.length > 0 && tplTasks.length === globalTasks.length) {
      setTplTasks([]);
    } else {
      setTplTasks(globalTasks.map((t: GlobalTask) => t.name));
    }
  };

  const formatDateForTable = (isoString?: string | null) => {
    if (!isoString) return null;
    const d = new Date(isoString);
    return d.toLocaleDateString('en-US', { timeZone: 'UTC', month: 'short', day: 'numeric', year: 'numeric' });
  };

  const handleSort = (key: string) => {
    let direction: 'asc' | 'desc' = 'asc';
    if (sortConfig.key === key && sortConfig.direction === 'asc') direction = 'desc';
    setSortConfig({ key, direction });
  };

  const sortedTemplates = [...(filteredTemplates || [])].sort((a, b) => {
    const dir = sortConfig.direction === 'asc' ? 1 : -1;
    const locA = a.location?.name || '';
    const locB = b.location?.name || '';
    const dayA = a.dayOfWeek ?? -1;
    const dayB = b.dayOfWeek ?? -1;
    const timeA = a.startTime || '';
    const timeB = b.startTime || '';

    if (sortConfig.key === 'location' && locA !== locB) return locA.localeCompare(locB) * dir;
    if (sortConfig.key === 'dayOfWeek' && dayA !== dayB) return (dayA - dayB) * dir;
    if (sortConfig.key === 'startTime' && timeA !== timeB) return timeA.localeCompare(timeB) * dir;

    if (sortConfig.key !== 'location' && locA !== locB) return locA.localeCompare(locB);
    if (sortConfig.key !== 'dayOfWeek' && dayA !== dayB) return dayA - dayB;
    if (sortConfig.key !== 'startTime' && timeA !== timeB) return timeA.localeCompare(timeB);

    return 0;
  });

  return (
    <div className="bg-white p-4 rounded-xl border border-gray-300 shadow-md">
      
      {/* Sub-Tab Navigation */}
      <div className="flex border-b border-gray-200 mb-6">
        <button
          onClick={() => setActiveTab('templates')}
          className={`py-2 px-6 font-black text-sm outline-none transition-colors border-b-2 ${
            activeTab === 'templates' 
              ? 'border-blue-600 text-blue-800' 
              : 'border-transparent text-slate-600 hover:text-slate-900 hover:border-slate-400'
          }`}
        >
          Shift Templates
        </button>
        <button
          onClick={() => setActiveTab('tasks')}
          className={`py-2 px-6 font-black text-sm outline-none transition-colors border-b-2 ${
            activeTab === 'tasks' 
              ? 'border-blue-600 text-blue-800' 
              : 'border-transparent text-slate-600 hover:text-slate-900 hover:border-slate-400'
          }`}
        >
          Facility Master Tasks
        </button>
      </div>

      {activeTab === 'templates' && (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          
          {/* COLUMN 1: FORM */}
          <div className="lg:col-span-1 bg-slate-50 p-5 rounded-xl border border-slate-300 shadow-inner">
            <form onSubmit={handleSaveTemplate} className="space-y-5">
              
              <div>
                <label className="block text-sm font-black text-slate-900 mb-1.5">1. Pre-Assign Employee</label>
                <select 
                  value={tplUserId || ''} 
                  onChange={(e) => setTplUserId(e.target.value)}
                  className="w-full border-2 border-slate-300 rounded-lg p-2.5 text-sm bg-white text-slate-900 font-bold focus:border-blue-600 focus:outline-none"
                >
                  <option value="" className="text-slate-600 font-bold">-- Unassigned --</option>
                  {users?.map(u => (
                    <option key={u.id} value={u.id}>{u.name}</option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-black text-slate-900 mb-1.5">2. Locations</label>
                <div className="max-h-32 overflow-y-auto bg-white p-2 border-2 border-slate-300 rounded-lg shadow-sm space-y-1">
                  {locations?.map((loc: Location) => (
                    <label key={loc.id} className="flex items-center space-x-2 cursor-pointer text-sm hover:bg-slate-50 p-1.5 rounded">
                      <input 
                        type="checkbox" 
                        checked={tplLocs?.includes(loc.id) || false} 
                        onChange={() => toggleTplLoc(loc.id)} 
                        className="w-4 h-4 text-blue-600 rounded border-slate-400"
                      />
                      <span className="text-slate-900 font-bold">{loc.name}</span>
                    </label>
                  ))}
                </div>
              </div>

              <div>
                <label className="block text-sm font-black text-slate-900 mb-1.5">3. Days of Week</label>
                <div className="flex flex-wrap gap-2">
                  {DAYS_OF_WEEK?.map((day, idx) => (
                    <label key={day} className="flex items-center space-x-1 cursor-pointer text-sm bg-white border-2 border-slate-300 px-2.5 py-1.5 rounded-lg shadow-sm hover:bg-slate-50">
                      <input 
                        type="checkbox" 
                        checked={tplDays?.includes(idx) || false} 
                        onChange={() => toggleTplDay(idx)} 
                        className="w-4 h-4 text-blue-600 rounded border-slate-400"
                      />
                      <span className="text-slate-900 font-bold">{day.substring(0, 3)}</span>
                    </label>
                  ))}
                </div>
              </div>

              <div className="grid grid-cols-2 gap-3 items-end">
                <div className="flex flex-col justify-end h-full">
                  <label className="block text-sm font-black text-slate-900 mb-1.5 leading-tight">4. Start Time</label>
                  <input 
                    type="time" 
                    value={tplStart || ''} 
                    onChange={(e) => setTplStart(e.target.value)}
                    className="w-full border-2 border-slate-300 rounded-lg p-2.5 text-sm text-slate-900 font-bold focus:border-blue-600 focus:outline-none"
                    required
                  />
                </div>
                <div className="flex flex-col justify-end h-full">
                  <label className="block text-sm font-black text-slate-900 mb-1.5 leading-tight">End Time</label>
                  <input 
                    type="time" 
                    value={tplEnd || ''} 
                    onChange={(e) => setTplEnd(e.target.value)}
                    className="w-full border-2 border-slate-300 rounded-lg p-2.5 text-sm text-slate-900 font-bold focus:border-blue-600 focus:outline-none"
                    required
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-3 items-end">
                <div className="flex flex-col justify-end h-full">
                  <label className="block text-sm font-black text-slate-900 mb-1.5 leading-tight">
                    5. Start Date 
                    <span className="block font-bold text-[11px] text-slate-600 mt-0.5">(Leave blank)</span>
                  </label>
                  <input 
                    type="date" 
                    value={tplStartDate || ''} 
                    onChange={(e) => setTplStartDate(e.target.value)}
                    className="w-full border-2 border-slate-300 rounded-lg p-2.5 text-sm text-slate-900 font-bold focus:border-blue-600 focus:outline-none"
                  />
                </div>
                <div className="flex flex-col justify-end h-full">
                  <label className="block text-sm font-black text-slate-900 mb-1.5 leading-tight">
                    End Date 
                    <span className="block font-bold text-[11px] text-slate-600 mt-0.5">(Leave blank)</span>
                  </label>
                  <input 
                    type="date" 
                    value={tplEndDate || ''} 
                    onChange={(e) => setTplEndDate(e.target.value)}
                    className="w-full border-2 border-slate-300 rounded-lg p-2.5 text-sm text-slate-900 font-bold focus:border-blue-600 focus:outline-none"
                  />
                </div>
              </div>

              <div className="border-t-2 border-slate-200 pt-4 mt-4">
                <div className="flex justify-between items-center mb-2">
                  <label className="text-sm font-black text-slate-900">6. Checklist Tasks</label>
                  <button 
                    type="button" 
                    onClick={handleSelectAllTasks}
                    className="text-xs font-black text-blue-700 hover:text-blue-900 hover:underline"
                  >
                    {globalTasks?.length > 0 && tplTasks?.length === globalTasks?.length 
                      ? 'Deselect All' 
                      : 'Select All'}
                  </button>
                </div>
                
                <div className="max-h-40 overflow-y-auto bg-white p-2 rounded-lg border-2 border-slate-300 shadow-sm space-y-1">
                  {globalTasks?.map((task: GlobalTask) => (
                    <label key={task.id} className="flex items-center space-x-2 cursor-pointer hover:bg-slate-50 p-1.5 rounded">
                      <input 
                        type="checkbox" 
                        checked={tplTasks?.includes(task.name) || false} 
                        onChange={() => toggleTplTask(task.name)} 
                        className="w-4 h-4 text-blue-600 rounded border-slate-400 focus:ring-blue-500" 
                      />
                      <span className="text-xs font-bold text-slate-900">{task.name}</span>
                    </label>
                  ))}
                  {globalTasks?.length === 0 && (
                    <div className="text-xs text-slate-600 italic font-bold p-2">No tasks available. Add them in the Master Tasks tab.</div>
                  )}
                </div>
              </div>
              
              <button type="submit" className="w-full bg-green-800 text-white font-black py-3.5 rounded-lg hover:bg-green-900 transition shadow-lg mt-2">
                {editingTplId ? 'Update Template' : 'Save Templates'}
              </button>

              {editingTplId && (
                <button 
                  type="button"
                  onClick={() => {
                    setEditingTplId(null);
                    setTplLocs([]);
                    setTplDays([]);
                    setTplTasks([]);
                    setTplStart('');
                    setTplEnd('');
                    setTplUserId('');
                    setTplStartDate('');
                    setTplEndDate('');
                  }}
                  className="w-full bg-slate-700 text-white font-black py-2.5 rounded-lg hover:bg-slate-800 transition shadow mt-2"
                >
                  Cancel Edit
                </button>
              )}
            </form>
          </div>

          {/* COLUMN 2: TEMPLATES TABLE */}
          <div className="lg:col-span-2 space-y-6">
            <div className="bg-white p-5 rounded-xl border border-slate-300 shadow-sm overflow-hidden h-full flex flex-col">
              <h3 className="font-black text-slate-900 mb-4 text-xl border-b-2 border-slate-100 pb-2">Saved Templates</h3>
              <div className="overflow-x-auto overflow-y-auto flex-1 min-h-[300px] max-h-[800px] pb-32">
                <table className="w-full text-left text-sm text-slate-800 relative">
                  <thead className="bg-slate-200 text-slate-900 text-xs uppercase font-black sticky top-0 z-40 shadow-sm">
                    <tr>
                      
                      <th className="p-3 relative select-none" ref={locFilterRef}>
                        <div className="flex items-center gap-2">
                          <div 
                            className="flex items-center gap-1 cursor-pointer hover:text-blue-800 transition-colors"
                            onClick={() => handleSort('location')}
                            title="Sort by Location"
                          >
                            LOCATION
                            {sortConfig.key === 'location' && (
                              <span className="text-blue-700 text-[10px]">{sortConfig.direction === 'asc' ? '' : ''}</span>
                            )}
                          </div>
                          <div 
                            className={`flex items-center justify-center cursor-pointer px-1.5 py-0.5 rounded transition-colors ${tplViewLocs?.length > 0 ? 'bg-blue-300 text-blue-900' : 'hover:bg-slate-300 text-slate-600 hover:text-blue-800'}`}
                            onClick={() => setShowLocFilter(!showLocFilter)}
                            title="Filter Locations"
                          >
                            {tplViewLocs?.length > 0 ? (
                              <span className="text-[10px] font-black">{tplViewLocs.length}</span>
                            ) : (
                              <span className="text-[10px]"></span>
                            )}
                          </div>
                        </div>
                        
                        {showLocFilter && (
                          <div className="absolute top-full left-0 mt-1 w-56 bg-white border-2 border-slate-300 rounded-lg shadow-2xl p-2 font-normal normal-case text-sm text-slate-900 flex flex-col z-[100]">
                            <div className="max-h-48 overflow-y-auto space-y-1 mb-2">
                              {locations?.map((loc: Location) => (
                                <label key={loc.id} className="flex items-center space-x-2 p-1.5 hover:bg-slate-100 rounded cursor-pointer transition-colors">
                                  <input 
                                    type="checkbox" 
                                    checked={tplViewLocs?.includes(loc.id) || false} 
                                    onChange={() => toggleTplViewLoc(loc.id)} 
                                    className="w-4 h-4 text-blue-600 rounded border-slate-400"
                                  />
                                  <span className="truncate font-bold">{loc.name}</span>
                                </label>
                              ))}
                            </div>
                            {tplViewLocs?.length > 0 && (
                              <button 
                                onClick={(e) => { e.stopPropagation(); setTplViewLocs([]); setShowLocFilter(false); }}
                                className="text-xs font-black text-red-700 border-t border-slate-200 pt-2 pb-1 hover:text-red-900 transition-colors"
                              >
                                Clear Selection
                              </button>
                            )}
                          </div>
                        )}
                      </th>

                      <th className="p-3 relative select-none" ref={dayFilterRef}>
                        <div className="flex items-center gap-2">
                          <div 
                            className="flex items-center gap-1 cursor-pointer hover:text-blue-800 transition-colors"
                            onClick={() => handleSort('dayOfWeek')}
                            title="Sort by Day"
                          >
                            DAYS
                            {sortConfig.key === 'dayOfWeek' && (
                              <span className="text-blue-700 text-[10px]">{sortConfig.direction === 'asc' ? '' : ''}</span>
                            )}
                          </div>
                          <div 
                            className={`flex items-center justify-center cursor-pointer px-1.5 py-0.5 rounded transition-colors ${tplViewDays?.length > 0 ? 'bg-blue-300 text-blue-900' : 'hover:bg-slate-300 text-slate-600 hover:text-blue-800'}`}
                            onClick={() => setShowDayFilter(!showDayFilter)}
                            title="Filter Days"
                          >
                            {tplViewDays?.length > 0 ? (
                              <span className="text-[10px] font-black">{tplViewDays.length}</span>
                            ) : (
                              <span className="text-[10px]"></span>
                            )}
                          </div>
                        </div>

                        {showDayFilter && (
                          <div className="absolute top-full left-0 mt-1 w-32 bg-white border-2 border-slate-300 rounded-lg shadow-2xl p-2 font-normal normal-case text-sm text-slate-900 flex flex-col z-[100]">
                            <div className="max-h-48 overflow-y-auto space-y-1 mb-2">
                              {DAYS_OF_WEEK?.map((day, idx) => (
                                <label key={day} className="flex items-center space-x-2 p-1.5 hover:bg-slate-100 rounded cursor-pointer transition-colors">
                                  <input 
                                    type="checkbox" 
                                    checked={tplViewDays?.includes(idx) || false} 
                                    onChange={() => toggleTplViewDay(idx)} 
                                    className="w-4 h-4 text-blue-600 rounded border-slate-400"
                                  />
                                  <span className="font-bold">{day.substring(0, 3)}</span>
                                </label>
                              ))}
                            </div>
                            {tplViewDays?.length > 0 && (
                              <button 
                                onClick={(e) => { e.stopPropagation(); setTplViewDays([]); setShowDayFilter(false); }}
                                className="text-xs font-black text-red-700 border-t border-slate-200 pt-2 pb-1 hover:text-red-900 transition-colors"
                              >
                                Clear
                              </button>
                            )}
                          </div>
                        )}
                      </th>

                      <th className="p-3 select-none">
                        <div 
                          className="flex items-center gap-1 cursor-pointer hover:text-blue-800 transition-colors w-max"
                          onClick={() => handleSort('startTime')}
                        >
                          TIME
                          {sortConfig.key === 'startTime' && (
                            <span className="text-blue-700 text-[10px]">{sortConfig.direction === 'asc' ? '' : ''}</span>
                          )}
                        </div>
                      </th>

                      <th className="p-3">Dates</th>
                      <th className="p-3">Tasks</th>
                      <th className="p-3 text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {sortedTemplates?.length === 0 ? (
                      <tr>
                        <td colSpan={6} className="p-10 text-center text-slate-600 font-bold italic bg-slate-50/80">
                          {tplViewLocs.length > 0 || tplViewDays.length > 0 
                            ? "No templates match your active filters." 
                            : "No templates found. Create one using the form on the left."}
                        </td>
                      </tr>
                    ) : (
                      sortedTemplates?.map((tpl) => {
                        const hasDates = tpl.startDate || tpl.endDate;
                        return (
                          <tr key={tpl.id} className="border-b border-slate-200 hover:bg-slate-100 transition-colors">
                            <td className="p-3 font-bold max-w-[120px] truncate" title={tpl.location?.name}>
                              {tpl.location?.name || 'Unknown Location'}
                            </td>
                            <td className="p-3 font-bold">
                              {DAYS_OF_WEEK[tpl.dayOfWeek]?.substring(0, 3) || 'N/A'}
                            </td>
                            <td className="p-3 whitespace-nowrap">
                              <span className="font-black text-slate-900">{tpl.startTime} - {tpl.endTime}</span>
                            </td>
                            <td className="p-3 font-bold whitespace-nowrap">
                              {!hasDates ? (
                                <span className="text-green-800">Always</span>
                              ) : (
                                <span className="text-slate-800">{formatDateForTable(tpl.startDate) || 'Always'} to {formatDateForTable(tpl.endDate) || 'Always'}</span>
                              )}
                            </td>
                            <td className="p-3 font-bold text-slate-700 max-w-[100px] truncate" title={tpl.checklistTasks?.join(', ')}>
                              {tpl.checklistTasks?.length || 0} tasks
                            </td>
                            <td className="p-3 text-center whitespace-nowrap">
                              <button 
                                type="button"
                                onClick={() => {
                                  handleEditTemplate({
                                    ...tpl,
                                    dayOfWeek: tpl.dayOfWeek,
                                    startDate: tpl.startDate ? tpl.startDate.split('T')[0] : '',
                                    endDate: tpl.endDate ? tpl.endDate.split('T')[0] : ''
                                  });
                                }} 
                                className="text-blue-700 hover:text-blue-900 hover:underline mr-4 font-black transition-colors"
                              >
                                Edit
                              </button>
                              <button 
                                type="button"
                                onClick={() => handleDeleteTemplate(tpl.id)} 
                                className="text-red-700 hover:text-red-900 hover:underline font-black transition-colors"
                              >
                                Delete
                              </button>
                            </td>
                          </tr>
                        );
                      })
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* --- VIEW 2: FACILITY MASTER TASKS --- */}
      {activeTab === 'tasks' && (
        <div className="max-w-4xl mx-auto space-y-6 mt-4">
          <div className="bg-slate-900 text-white p-8 rounded-2xl shadow-xl border border-slate-800">
            <h3 className="font-black text-xl uppercase tracking-widest mb-1 text-yellow-400">
              Facility Master Tasks
            </h3>
            <p className="text-sm text-slate-300 mb-8 font-bold leading-relaxed">
              Create and manage tasks globally. Tasks added here will be available to select when creating new Shift Templates.
            </p>
            
            <div className="flex flex-col sm:flex-row gap-3 mb-8">
              <input 
                value={newTaskStr || ''}
                onChange={(e) => setNewTaskStr(e.target.value)}
                onKeyDown={(e) => {
                  if (e.key === 'Enter') {
                    e.preventDefault();
                    if (newTaskStr?.trim() && handleAddMasterTask) handleAddMasterTask();
                  }
                }}
                className="flex-grow bg-slate-800 border-2 border-slate-700 rounded-xl px-5 py-3.5 text-base font-bold text-white focus:outline-none focus:border-yellow-500 placeholder-slate-400 transition-colors" 
                placeholder="Type a new task and press Enter..." 
              />
              <button 
                type="button"
                onClick={() => handleAddMasterTask && handleAddMasterTask()} 
                disabled={!newTaskStr?.trim()}
                className="bg-yellow-500 text-slate-900 font-black px-8 py-3.5 rounded-xl text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-yellow-400 transition shadow-lg"
              >
                ADD TASK
              </button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto max-h-[60vh] pr-2">
              {globalTasks?.map((task: GlobalTask) => (
                <div 
                  key={task.id} 
                  className="bg-slate-800 border-2 border-slate-700 hover:border-slate-500 transition-colors rounded-xl px-5 py-4 flex items-center justify-between gap-3 shadow-md"
                >
                  <span className="text-sm font-bold text-slate-100 truncate" title={task.name}>{task.name}</span>
                  <button 
                    type="button" 
                    onClick={() => handleDeleteMasterTask && handleDeleteMasterTask(task.id)} 
                    className="text-red-400 hover:text-red-300 font-black text-2xl leading-none px-2 focus:outline-none transition-colors"
                    title="Delete Task"
                  >
                    &times;
                  </button>
                </div>
              ))}
              {globalTasks?.length === 0 && (
                <div className="col-span-full text-slate-400 font-bold italic py-8 text-center bg-slate-800/50 rounded-xl border border-dashed border-slate-700">
                  No master tasks created yet.
                </div>
              )}
            </div>
            
          </div>
        </div>
      )}

    </div>
  );
}
</file>

<file path="next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  typescript: {
    // This allows the build to finish even if there are small type errors
    ignoreBuildErrors: true,
  },
  serverExternalPackages: ["@prisma/client"],
};

export default nextConfig;
</file>

<file path="app/components/ManagerTab.tsx">
"use client";
import React, { useState } from 'react';
import { AppState, TimeCard, User, Location } from '../lib/types';

export default function ManagerTab({ appState }: { appState: AppState }) {
  const {
    handleExportCSV, periods, manPeriods, toggleManPeriod, locations, manLocs, toggleManLoc,
    users, manEmps, toggleManEmp, hiddenWarnings, matrixRows, activeManPeriods, managerData,
    formDate, setFormDate, formStartTime, setFormStartTime, formEndTime, setFormEndTime,
    selectedLocation, setSelectedLocation, handleManualSubmit, editingCardId, setEditingCardId,
    selectedUserId, setSelectedUserId, setActiveTab,
    handleEditClick, handleDeleteClick, formatDateSafe, formatTimeSafe
  } = appState;

  const [expandedGroups, setExpandedGroups] = useState<Record<string, boolean>>({});
  
  const toggleGroup = (key: string) => {
    setExpandedGroups(prev => ({ ...prev, [key]: !prev[key] }));
  };

  const handleManagerEditClick = (card: TimeCard) => {
    handleEditClick(card); 
    setActiveTab('manager'); 
    window.scrollTo({ top: 0, behavior: 'smooth' }); 
  };

  // Group managerData dynamically
  const groupedCards = (managerData || []).reduce((acc: Record<string, Record<string, TimeCard[]>>, card) => {
    if (manLocs.length > 0 && !manLocs.includes(card.locationId)) return acc;

    const locName = card.location?.name || 'Unknown Location';
    const empName = card.user?.name || 'Unknown Employee';

    if (!acc[locName]) acc[locName] = {};
    if (!acc[locName][empName]) acc[locName][empName] = [];

    acc[locName][empName].push(card);
    return acc;
  }, {});

  return (
    <div className="bg-white p-4 md:p-6 rounded-2xl border border-gray-300 shadow-md">
      
      <div className="flex flex-col md:flex-row justify-between items-center mb-6 border-b border-gray-200 pb-4 gap-4">
        <h2 className="text-lg md:text-2xl font-black text-slate-900 text-center md:text-left">Manager View & Tools</h2>
        <button onClick={handleExportCSV} className="w-full md:w-auto bg-green-800 hover:bg-green-900 text-white font-bold py-2.5 px-6 rounded-xl shadow-md transition whitespace-nowrap">
          Export to CSV
        </button>
      </div>

      <div className="bg-slate-50 p-5 md:p-6 rounded-2xl border border-slate-300 shadow-sm mb-8">
        <div className="flex items-center gap-2 mb-4 pb-3 border-b border-slate-200">
          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-orange-600" viewBox="0 0 20 20" fill="currentColor">
            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
          </svg>
          <h2 className="text-lg md:text-xl font-black text-slate-900">
            {editingCardId ? 'Edit Time Entry' : 'Manual Time Entry'}
          </h2>
        </div>
        
        <form onSubmit={(e) => { handleManualSubmit(e); setActiveTab('manager'); setTimeout(() => window.location.reload(), 500); }} className="flex flex-col md:flex-row gap-4 items-start md:items-end flex-wrap">
          <div className="w-full md:w-auto flex-grow">
            <label className="block text-sm font-bold text-slate-700 mb-1">Employee</label>
            <select value={selectedUserId} onChange={(e) => setSelectedUserId(e.target.value)} required className="w-full border border-gray-400 rounded-lg p-2.5 text-slate-900 font-black focus:ring-2 focus:ring-blue-500 outline-none shadow-sm">
              <option value="">-- Select --</option>
              {users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
            </select>
          </div>

          <div className="w-full md:w-auto flex-grow">
            <label className="block text-sm font-bold text-slate-700 mb-1">Date</label>
            <input type="date" value={formDate} onChange={(e) => setFormDate(e.target.value)} required className="w-full border border-gray-400 rounded-lg p-2.5 text-slate-900 font-black focus:ring-2 focus:ring-blue-500 outline-none shadow-sm" />
          </div>

          <div className="w-full md:w-auto flex-grow">
            <label className="block text-sm font-bold text-slate-700 mb-1">Start Time</label>
            <input type="time" value={formStartTime} onChange={(e) => setFormStartTime(e.target.value)} required className="w-full border border-gray-400 rounded-lg p-2.5 text-slate-900 font-black focus:ring-2 focus:ring-blue-500 outline-none shadow-sm" />
          </div>

          <div className="w-full md:w-auto flex-grow">
            <label className="block text-sm font-bold text-slate-700 mb-1">End Time</label>
            <input type="time" value={formEndTime} onChange={(e) => setFormEndTime(e.target.value)} className="w-full border border-gray-400 rounded-lg p-2.5 text-slate-900 font-black focus:ring-2 focus:ring-blue-500 outline-none shadow-sm" />
          </div>

          <div className="w-full md:w-auto flex-grow">
            <label className="block text-sm font-bold text-slate-700 mb-1">Location</label>
            <select value={selectedLocation} onChange={(e) => setSelectedLocation(e.target.value)} required className="w-full border border-gray-400 rounded-lg p-2.5 text-slate-900 font-black focus:ring-2 focus:ring-blue-500 outline-none shadow-sm">
              <option value="">-- Select --</option>
              {locations.map(loc => <option key={loc.id} value={loc.id}>{loc.name}</option>)}
            </select>
          </div>

          <div className="w-full md:w-auto flex flex-col gap-2 md:pb-6">
            <button type="submit" className="w-full bg-slate-900 hover:bg-black text-white font-bold py-3 px-6 rounded-lg shadow-md transition whitespace-nowrap">
              {editingCardId ? 'Update Entry' : 'Save Entry'}
            </button>
            {editingCardId && (
              <button type="button" onClick={() => { setEditingCardId(null); setFormDate(''); setFormStartTime(''); setFormEndTime(''); setSelectedLocation(''); setSelectedUserId(''); }} className="w-full bg-gray-200 hover:bg-gray-300 text-slate-800 font-bold py-2 px-6 rounded-lg shadow-sm transition">
                Cancel
              </button>
            )}
          </div>
        </form>
      </div>
      
      <h3 className="text-lg font-black text-slate-900 mb-3">Report Filters</h3>
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 md:gap-6 mb-8 bg-slate-50 p-4 rounded-xl border border-gray-200 shadow-inner">
        <div>
          <label className="block text-xs md:text-sm font-bold text-slate-800 mb-2">Pay Periods</label>
          <div className="border border-gray-400 rounded-lg p-2 md:p-3 h-32 md:h-40 overflow-y-auto bg-white flex flex-col gap-2 shadow-sm">
            {periods.map((p, i) => (
              <label key={i} className="flex items-center space-x-2 cursor-pointer hover:bg-slate-50 p-1 rounded">
                <input type="checkbox" checked={manPeriods.includes(i)} onChange={() => toggleManPeriod(i)} className="w-5 h-5 md:w-4 md:h-4 text-orange-500 rounded border-gray-400 cursor-pointer" />
                <span className="text-xs md:text-sm font-bold text-slate-900">{p.label}</span>
              </label>
            ))}
          </div>
        </div>

        <div>
          <label className="block text-xs md:text-sm font-bold text-slate-800 mb-2">Locations</label>
          <div className="border border-gray-400 rounded-lg p-2 md:p-3 h-32 md:h-40 overflow-y-auto bg-white flex flex-col gap-2 shadow-sm">
            {locations.map(loc => (
              <label key={loc.id} className="flex items-center space-x-2 cursor-pointer hover:bg-slate-50 p-1 rounded">
                <input type="checkbox" checked={manLocs.includes(loc.id)} onChange={() => toggleManLoc(loc.id)} className="w-5 h-5 md:w-4 md:h-4 text-orange-500 rounded border-gray-400 cursor-pointer" />
                <span className="text-xs md:text-sm font-bold text-slate-900">{loc.name}</span>
              </label>
            ))}
          </div>
        </div>

        <div>
          <label className="block text-xs md:text-sm font-bold text-slate-800 mb-2">Employees</label>
          <div className="border border-gray-400 rounded-lg p-2 md:p-3 h-32 md:h-40 overflow-y-auto bg-white flex flex-col gap-2 shadow-sm">
            {users.map(u => (
              <label key={u.id} className="flex items-center space-x-2 cursor-pointer hover:bg-slate-50 p-1 rounded">
                <input type="checkbox" checked={manEmps.includes(u.id)} onChange={() => toggleManEmp(u.id)} className="w-5 h-5 md:w-4 md:h-4 text-orange-500 rounded border-gray-400 cursor-pointer" />
                <span className="text-xs md:text-sm font-bold text-slate-900">{u.name}</span>
              </label>
            ))}
          </div>
        </div>
      </div>

      {hiddenWarnings.length > 0 && (
        <div className="mb-6 bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-r-lg shadow-sm">
          <div className="flex items-start">
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div className="ml-3">
              <h3 className="text-sm font-black text-yellow-800">Warning: Hidden Floating Hours!</h3>
              <ul className="list-disc pl-5 mt-2 font-black text-yellow-900 text-sm">
                {hiddenWarnings.map((warn, i) => <li key={i}>{warn}</li>)}
              </ul>
            </div>
          </div>
        </div>
      )}

      <h3 className="text-lg font-black text-slate-900 mb-3">Hours Matrix</h3>
      <div className="overflow-x-auto border border-gray-300 rounded-xl shadow-sm mb-10">
        <table className="w-full text-left text-sm" style={{ minWidth: '700px' }}>
          <thead className="bg-slate-100 border-b border-gray-300 text-slate-800">
            <tr>
              <th className="p-3 font-black text-slate-900 border-r border-gray-300">Location</th>
              <th className="p-3 font-black text-slate-900 border-r border-gray-300">Employee</th>
              {activeManPeriods.map(p => <th key={p.label} className="p-3 font-black text-slate-900 border-r border-gray-300 text-center">{p.label}</th>)}
              <th className="p-3 font-black text-blue-900 bg-blue-100 text-center border-l border-blue-300">Total Hours</th>
            </tr>
          </thead>
          <tbody>
            {matrixRows.length === 0 ? (
              <tr><td colSpan={10} className="p-6 text-center font-bold text-slate-500 italic bg-white">No data match.</td></tr>
            ) : (
              matrixRows.map((row, idx) => (
                <tr key={idx} className="border-b border-gray-200 hover:bg-slate-50 transition whitespace-nowrap">
                  <td className="p-3 font-bold text-gray-700 border-r border-gray-200">{row.locName}</td>
                  <td className="p-3 font-black text-slate-900 border-r border-gray-200">{row.empName}</td>
                  {activeManPeriods.map(p => {
                    const val = row.periodTotals.get(p.label);
                    return (
                      <td key={p.label} className={`p-3 font-bold text-center border-r border-gray-200 ${val > 0 ? 'text-green-800 bg-green-50' : 'text-gray-400'}`}>
                        {val > 0 ? val.toFixed(2) + 'h' : '-'}
                      </td>
                    );
                  })}
                  <td className="p-3 font-black text-blue-900 bg-blue-50 text-center border-l-2 border-blue-200">{row.totalRowHours.toFixed(2)}h</td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>

      <h3 className="text-xl font-black text-slate-900 mb-4 border-b border-gray-200 pb-2">Detailed Time Cards</h3>
      
      {Object.keys(groupedCards).length === 0 ? (
        <div className="text-center p-8 bg-slate-50 border border-slate-200 rounded-xl text-slate-500 font-bold italic shadow-sm">No cards.</div>
      ) : (
        <div className="space-y-4">
          {Object.keys(groupedCards).sort().map(locName => {
            const locKey = `loc-${locName}`;
            const empGroups = groupedCards[locName];
            let locTotal = 0;
            Object.values(empGroups).forEach(group => group.forEach(c => locTotal += (c.totalHours || 0)));

            return (
              <div key={locName} className="bg-white border border-slate-300 rounded-2xl overflow-hidden shadow-sm">
                <button onClick={() => toggleGroup(locKey)} className="w-full bg-slate-800 text-white p-4 md:p-5 flex justify-between items-center hover:bg-slate-700 transition">
                  <span className="text-lg md:text-xl font-black tracking-wide">{locName}</span>
                  <div className="flex items-center gap-4">
                    <span className="text-sm font-bold bg-slate-900 px-3 py-1.5 rounded-lg border border-slate-600">{locTotal.toFixed(2)} hrs</span>
                    <svg className={`h-6 w-6 transition-transform ${expandedGroups[locKey] ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M19 9l-7 7-7-7" /></svg>
                  </div>
                </button>

                {expandedGroups[locKey] && (
                  <div className="p-3 md:p-5 bg-slate-50 space-y-4">
                    {Object.keys(empGroups).sort().map(empName => {
                      const empKey = `emp-${locName}-${empName}`;
                      const cards = empGroups[empName];
                      const empTotal = cards.reduce((sum, c) => sum + (c.totalHours || 0), 0);

                      return (
                        <div key={empName} className="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                          <button onClick={() => toggleGroup(empKey)} className="w-full bg-blue-50 text-blue-900 p-3 md:p-4 flex justify-between items-center border-b border-blue-100">
                            <span className="font-black text-sm md:text-base uppercase tracking-widest">{empName}</span>
                            <div className="flex items-center gap-4">
                              <span className="text-xs md:text-sm font-black bg-blue-200 text-blue-800 px-3 py-1 rounded shadow-sm">{empTotal.toFixed(2)} hrs</span>
                              <svg className={`h-5 w-5 transition-transform ${expandedGroups[empKey] ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                            </div>
                          </button>
                          {expandedGroups[empKey] && (
                            <div className="p-3 md:p-4 space-y-3 bg-white">
                              {cards.sort((a, b) => new Date(b.clockIn).getTime() - new Date(a.clockIn).getTime()).map(card => {
                                const isActive = !card.clockOut || isNaN(new Date(card.clockOut).getTime()) || new Date(card.clockOut).getFullYear() === 1970;
                                return (
                                  <div key={card.id} className="flex flex-col md:flex-row justify-between items-start md:items-center p-4 border border-gray-200 rounded-lg gap-4">
                                    <div className="flex flex-col md:flex-row md:items-center gap-2 md:gap-4">
                                      <span className="font-black text-slate-800">{formatDateSafe(card.clockIn)}</span>
                                      <div className="flex items-center gap-2 text-sm font-bold text-slate-600 bg-slate-100 px-3 py-1.5 rounded-lg">
                                        <span className="text-green-700">{formatTimeSafe(card.clockIn)}</span>
                                        <span></span>
                                        <span className={isActive ? 'text-red-600 animate-pulse' : 'text-slate-800'}>{isActive ? 'Active' : formatTimeSafe(card.clockOut!)}</span>
                                      </div>
                                      <span className="text-sm font-black text-blue-700">{card.totalHours?.toFixed(2)}h</span>
                                    </div>
                                    <div className="flex gap-2 w-full md:w-auto">
                                      <button onClick={() => handleManagerEditClick(card)} className="px-5 py-2 text-xs bg-orange-50 text-orange-900 border border-orange-200 font-bold rounded-lg">Edit</button>
                                      <button onClick={() => { handleDeleteClick(card.id); setTimeout(() => window.location.reload(), 400); }} className="px-5 py-2 text-xs bg-red-50 text-red-700 border border-red-200 font-bold rounded-lg">Delete</button>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}
</file>

</files>
